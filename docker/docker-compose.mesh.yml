# Docker Compose configuration for 4-node mesh ILP network
# Topology: Full mesh - all connectors connected to each other
#
#         Connector A (Port 3000)
#            /  |  \
#           /   |   \
#          /    |    \
#         B     C     D
#      (3001) (3002) (3003)
#         \    |    /
#          \   |   /
#           \  |  /
#        (All interconnected)
#
# Total connections: 6 bidirectional (A↔B, A↔C, A↔D, B↔C, B↔D, C↔D)
# Each connector has 3 peers
#
# Explorer UI Access:
#   - Connector A: http://localhost:3010
#   - Connector B: http://localhost:3011
#   - Connector C: http://localhost:3012
#   - Connector D: http://localhost:3013
#
# Usage:
#   Start: docker-compose -f docker/docker-compose.mesh.yml up -d
#   Logs:  docker-compose -f docker/docker-compose.mesh.yml logs -f
#   Stop:  docker-compose -f docker/docker-compose.mesh.yml down
#
# Prerequisites:
#   Build the connector image: docker build -t ilp-connector .
#
# Configuration:
#   Each connector loads its configuration from a YAML file mounted as a volume.
#   Configuration files: examples/mesh-4-nodes-{a,b,c,d}.yaml
#   This topology provides redundant paths for increased resilience.

version: '3.8'

services:
  # Connector A - Mesh node 1
  # Explorer UI: http://localhost:3010
  connector-a:
    image: ilp-connector
    container_name: connector-a
    environment:
      CONFIG_FILE: /app/config.yaml
      NODE_ID: connector-a
      LOG_LEVEL: info
      DASHBOARD_TELEMETRY_URL: ws://localhost:9999
      EXPLORER_ENABLED: "true"
      EXPLORER_PORT: "3010"
    volumes:
      - ../examples/mesh-4-nodes-a.yaml:/app/config.yaml:ro
    ports:
      - "3000:3000"
      - "3010:3010"
    networks:
      - ilp-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Connector B - Mesh node 2
  # Explorer UI: http://localhost:3011
  connector-b:
    image: ilp-connector
    container_name: connector-b
    environment:
      CONFIG_FILE: /app/config.yaml
      NODE_ID: connector-b
      LOG_LEVEL: info
      DASHBOARD_TELEMETRY_URL: ws://localhost:9999
      EXPLORER_ENABLED: "true"
      EXPLORER_PORT: "3011"
    volumes:
      - ../examples/mesh-4-nodes-b.yaml:/app/config.yaml:ro
    ports:
      - "3001:3001"
      - "3011:3011"
    networks:
      - ilp-network
    depends_on:
      - connector-a
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Connector C - Mesh node 3
  # Explorer UI: http://localhost:3012
  connector-c:
    image: ilp-connector
    container_name: connector-c
    environment:
      CONFIG_FILE: /app/config.yaml
      NODE_ID: connector-c
      LOG_LEVEL: info
      DASHBOARD_TELEMETRY_URL: ws://localhost:9999
      EXPLORER_ENABLED: "true"
      EXPLORER_PORT: "3012"
    volumes:
      - ../examples/mesh-4-nodes-c.yaml:/app/config.yaml:ro
    ports:
      - "3002:3002"
      - "3012:3012"
    networks:
      - ilp-network
    depends_on:
      - connector-a
      - connector-b
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Connector D - Mesh node 4
  # Explorer UI: http://localhost:3013
  connector-d:
    image: ilp-connector
    container_name: connector-d
    environment:
      CONFIG_FILE: /app/config.yaml
      NODE_ID: connector-d
      LOG_LEVEL: info
      DASHBOARD_TELEMETRY_URL: ws://localhost:9999
      EXPLORER_ENABLED: "true"
      EXPLORER_PORT: "3013"
    volumes:
      - ../examples/mesh-4-nodes-d.yaml:/app/config.yaml:ro
    ports:
      - "3003:3003"
      - "3013:3013"
    networks:
      - ilp-network
    depends_on:
      - connector-a
      - connector-b
      - connector-c
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  ilp-network:
    driver: bridge
