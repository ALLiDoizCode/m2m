# Data Models

## ILPPacket (Base)

**Purpose:** Abstract base type for all ILP packet types (Prepare, Fulfill, Reject) as defined in RFC-0027

**Key Attributes:**

- `type: PacketType` (enum: PREPARE = 12, FULFILL = 13, REJECT = 14) - Discriminator for packet type
- `data: Buffer` - Binary payload data
- `amount: bigint` - Payment amount in smallest unit (uint64)
- `destination: ILPAddress` - Hierarchical ILP address per RFC-0015

**Relationships:**

- Extended by ILPPreparePacket, ILPFulfillPacket, ILPRejectPacket
- Used in BTPMessage payload field

## ILPPreparePacket

**Purpose:** Represents conditional payment packet initiating an ILP transaction (RFC-0027 Section 3.1)

**Key Attributes:**

- `type: PacketType.PREPARE` (12) - Packet type identifier
- `amount: bigint` - Transfer amount
- `destination: ILPAddress` - Payment destination address
- `executionCondition: Buffer` - 32-byte SHA-256 hash condition
- `expiresAt: Date` - Expiration timestamp (ISO 8601)
- `data: Buffer` - Optional application data payload

**Relationships:**

- Forwarded through multiple Connectors until reaching destination
- Responded to with either ILPFulfillPacket or ILPRejectPacket
- Wrapped in BTPMessage for transmission

## ILPFulfillPacket

**Purpose:** Represents successful payment fulfillment (RFC-0027 Section 3.2)

**Key Attributes:**

- `type: PacketType.FULFILL` (13) - Packet type identifier
- `fulfillment: Buffer` - 32-byte preimage that hashes to executionCondition
- `data: Buffer` - Optional return data

**Relationships:**

- Response to ILPPreparePacket
- Propagates backward through connector chain

## ILPRejectPacket

**Purpose:** Represents payment rejection with error information (RFC-0027 Section 3.3)

**Key Attributes:**

- `type: PacketType.REJECT` (14) - Packet type identifier
- `code: ILPErrorCode` - Three-character error code (F00-F99, T00-T99, R00-R99)
- `triggeredBy: ILPAddress` - Address of connector that generated error
- `message: string` - Human-readable error description
- `data: Buffer` - Additional error context

**Relationships:**

- Response to ILPPreparePacket when payment cannot be fulfilled
- Propagates backward through connector chain

**Error Code Categories:**

- F-prefix: Final errors (permanent failures)
- T-prefix: Temporary errors (retryable)
- R-prefix: Relative errors (protocol violations)

## RoutingTableEntry

**Purpose:** Maps ILP address prefixes to next-hop peer identifiers for packet forwarding

**Key Attributes:**

- `prefix: string` - ILP address prefix (e.g., "g.alice" or "g.bob.crypto")
- `nextHop: string` - Peer identifier matching BTP connection
- `priority: number` - Route priority for tie-breaking (optional, default 0)

**Relationships:**

- Many entries comprise a RoutingTable
- nextHop references a Peer in the connector's peer list

## Peer

**Purpose:** Represents a BTP-connected peer connector with connection metadata

**Key Attributes:**

- `id: string` - Unique peer identifier
- `url: string` - WebSocket URL for BTP connection (e.g., "ws://connector-b:3000")
- `authToken: string` - Shared secret for BTP authentication
- `connected: boolean` - Current connection state
- `lastSeen: Date` - Timestamp of last successful communication

**Relationships:**

- Referenced by RoutingTableEntry.nextHop
- Manages one BTPConnection instance

## BTPMessage

**Purpose:** BTP protocol message wrapping ILP packets for transmission (RFC-0023)

**Key Attributes:**

- `type: BTPMessageType` (enum: MESSAGE, RESPONSE, ERROR, TRANSFER, etc.)
- `requestId: number` - Correlation ID for request/response matching
- `data: BTPData` - Message payload containing:
  - `protocolData: BTPProtocolData[]` - Array of protocol-specific data
  - `ilpPacket: Buffer` - Serialized ILP packet (OER encoded)

**Relationships:**

- Contains serialized ILPPacket
- Transmitted over WebSocket connection between Peers

## TelemetryEvent

**Purpose:** Observability event emitted by connectors to dashboard for visualization

**Key Attributes:**

- `type: TelemetryEventType` (enum: NODE_STATUS, PACKET_RECEIVED, PACKET_SENT, ROUTE_LOOKUP)
- `nodeId: string` - Identifier of connector emitting event
- `timestamp: Date` - Event occurrence time
- `data: object` - Event-specific payload (varies by type)

**Event Type Payloads:**

- `NODE_STATUS`: { routes: RoutingTableEntry[], peers: Peer[], health: string }
- `PACKET_RECEIVED`: { packetId: string, type: PacketType, source: string, destination: string, amount: string }
- `PACKET_SENT`: { packetId: string, nextHop: string, timestamp: string }
- `ROUTE_LOOKUP`: { destination: string, selectedPeer: string, reason: string }

**Relationships:**

- Generated by Connector components during packet processing
- Transmitted to Dashboard via WebSocket
- Consumed by Dashboard for visualization and logging

## ConnectorConfig

**Purpose:** Configuration object loaded at connector startup defining routing and peer topology

**Key Attributes:**

- `nodeId: string` - Unique identifier for this connector instance
- `btpServerPort: number` - Port for incoming BTP connections (default 3000)
- `healthCheckPort: number` - HTTP health endpoint port (default 8080)
- `peers: Peer[]` - List of peer connectors to connect to
- `routes: RoutingTableEntry[]` - Initial routing table entries
- `logLevel: string` - Logging verbosity (DEBUG, INFO, WARN, ERROR)
- `dashboardTelemetryUrl: string` - WebSocket URL for telemetry emission

**Relationships:**

- Loaded from YAML file or environment variables
- Initializes RoutingTable and Peer connections

## XRPChannelState

**Purpose:** Represents the current state of an XRP Ledger payment channel for settlement operations

**Key Attributes:**

- `channelId: string` - Unique channel identifier (64-character hex, transaction hash)
- `account: string` - Source account XRP Ledger address (r-address)
- `destination: string` - Destination account XRP Ledger address (r-address)
- `amount: string` - Total XRP in channel (drops as string, 1 XRP = 1,000,000 drops)
- `balance: string` - XRP claimed so far (drops as string)
- `settleDelay: number` - Settlement delay in seconds
- `publicKey: string` - ed25519 public key for claim verification (66-character hex)
- `cancelAfter?: number` - Optional auto-expiration timestamp (seconds since epoch)
- `expiration?: number` - Optional close request timestamp (seconds since epoch)
- `status: 'open' | 'closing' | 'closed'` - Channel lifecycle status

**Relationships:**

- Cached by XRPChannelSDK for fast lookups
- Tracked by XRPChannelLifecycleManager for lifecycle operations
- Queried from XRP Ledger via XRPLClient

## XRPClaim

**Purpose:** Represents a signed claim for XRP payment channel off-chain settlement

**Key Attributes:**

- `channelId: string` - Channel ID to claim from (64-character hex)
- `amount: string` - Cumulative XRP to claim (drops as string)
- `signature: string` - ed25519 signature (128-character hex)
- `publicKey: string` - ed25519 public key (66-character hex, starts with 'ED')

**Relationships:**

- Generated by ClaimSigner.signClaim()
- Verified by ClaimSigner.verifyClaim()
- Submitted to ledger via XRPLClient.submitClaim()
- Stored in database for dispute resolution

## DualSettlementPeerConfig

**Purpose:** Configuration for peer supporting both EVM and XRP settlement methods

**Key Attributes:**

- `peerId: string` - Peer identifier
- `ilpAddress: string` - ILP address of peer
- `settlementPreference: 'evm' | 'xrp' | 'both'` - Settlement method preference
- `settlementTokens: string[]` - Supported settlement tokens (ordered by preference)
- `evmAddress?: string` - EVM address (required if settlementPreference includes 'evm')
- `xrpAddress?: string` - XRP Ledger address (required if settlementPreference includes 'xrp')
- `settlementThreshold: bigint` - Settlement threshold in base units
- `settlementInterval: number` - Settlement interval in milliseconds

**Relationships:**

- Used by UnifiedSettlementExecutor for routing decisions
- References both EVM and XRP addresses
- Determines which settlement method to use per token type

## XRPChannelTrackingState

**Purpose:** Internal state structure for tracking XRP channel lifecycle per peer

**Key Attributes:**

- `channelId: string` - Channel ID (64-character hex)
- `peerId: string` - Peer ID associated with this channel
- `destination: string` - XRP Ledger destination address (r-address)
- `amount: string` - Total XRP amount in channel (drops)
- `balance: string` - Current channel balance (XRP claimed so far, in drops)
- `settleDelay: number` - Settlement delay in seconds
- `status: 'open' | 'closing' | 'closed'` - Channel status
- `lastActivityAt: number` - Timestamp of last claim activity (milliseconds since epoch)
- `cancelAfter?: number` - Optional CancelAfter timestamp (seconds since epoch)

**Relationships:**

- Tracked by XRPChannelLifecycleManager in Map<peerId, XRPChannelTrackingState>
- Updated after claim submissions and funding operations
- Used for idle detection and expiration handling
