<!-- Powered by BMAD™ Core -->

# Story 16.1: AI SDK Foundation & Provider Factory

## Status

Done

## Story

**As a** connector operator,
**I want** the Vercel AI SDK integrated with a provider-agnostic model factory and configuration system,
**So that** the agent node can use any AI SDK-compatible provider (Anthropic, OpenAI, etc.) for intelligent event processing, with configuration-driven model selection and sensible defaults.

## Acceptance Criteria

1. AI configuration types (`AIAgentConfig`, `AIYamlConfig`, `AIBudgetConfig`, `AIAgentPersonality`) are defined with full TypeScript typing
2. A `parseAIConfig()` function merges YAML config with environment variable overrides and applies defaults
3. Model string format `provider:model` (e.g., `"anthropic:claude-haiku-4-5"`) is validated with `isValidModelString()` and parsed with `parseModelString()`
4. A `createModelFromConfig()` provider factory dynamically imports the correct `@ai-sdk/*` package and returns a `LanguageModelV1` instance
5. Supported providers: `anthropic` (via `@ai-sdk/anthropic`) and `openai` (via `@ai-sdk/openai`), with clear error messages for unsupported providers or missing packages
6. Environment variable overrides work for all AI config fields: `AI_API_KEY`, `AI_AGENT_ENABLED`, `AI_AGENT_MODEL`, `AI_MAX_TOKENS_PER_REQUEST`, `AI_MAX_TOKENS_PER_HOUR`
7. Default configuration values are exported as `AI_AGENT_DEFAULTS` constant
8. The YAML `ai:` section is validated in `AgentConfigLoader.validateAIConfig()` with proper error messages
9. All configuration and factory code has unit tests with >80% coverage
10. The `ai` npm package (^4.0.0), `@ai-sdk/anthropic` (^1.0.0), `@ai-sdk/openai` (^1.0.0), and `zod` (^3.23.0) are added as dependencies

## Tasks / Subtasks

- [x] Task 1: Add AI SDK npm dependencies (AC: 10)
  - [x] Add `ai` ^4.0.0 as dependency in `packages/connector/package.json`
  - [x] Add `@ai-sdk/anthropic` ^1.0.0 as dependency
  - [x] Add `@ai-sdk/openai` ^1.0.0 as dependency
  - [x] Add `zod` ^3.23.0 as dependency
  - [x] Run `npm install` and verify clean install
  - [x] [Source: architecture/tech-stack.md — AI SDK row, AI Providers row, Schema Validation row]

- [x] Task 2: Create AI agent config types and parser (AC: 1, 2, 3, 6, 7)
  - [x] Create `packages/connector/src/agent/ai/ai-agent-config.ts`
  - [x] Define `AIAgentPersonality` interface (name, role, instructions)
  - [x] Define `AIBudgetConfig` interface (maxTokensPerHour, fallbackOnExhaustion)
  - [x] Define `AIAgentConfig` interface (enabled, model, apiKey, maxTokensPerRequest, budget, personality)
  - [x] Define `AIYamlConfig` interface for raw YAML parsing
  - [x] Export `AI_AGENT_DEFAULTS` constant with default values
  - [x] Implement `parseAIConfig(yaml?: AIYamlConfig): AIAgentConfig` with env var merging
  - [x] Implement `isValidModelString(model: string): boolean` for `provider:model` format validation
  - [x] Implement `parseModelString(model: string): { provider, modelName }` for parsing
  - [x] Implement `envBool()` and `envInt()` helper functions for env var parsing
  - [x] [Source: docs/prd/epic-16-ai-agent-node.md — Configuration section]

- [x] Task 3: Create provider factory (AC: 4, 5)
  - [x] Create `packages/connector/src/agent/ai/provider-factory.ts`
  - [x] Implement `createModelFromConfig(config: AIAgentConfig): Promise<LanguageModelV1>` factory function
  - [x] Implement `createAnthropicModel()` with dynamic import of `@ai-sdk/anthropic`
  - [x] Implement `createOpenAIModel()` with dynamic import of `@ai-sdk/openai`
  - [x] Handle `MODULE_NOT_FOUND` errors with actionable error messages
  - [x] Support fallback to provider-specific env vars (`ANTHROPIC_API_KEY`, `OPENAI_API_KEY`)
  - [x] [Source: docs/prd/epic-16-ai-agent-node.md — Architecture section, Dependencies section]

- [x] Task 4: Create AI module index and exports (AC: 1)
  - [x] Create `packages/connector/src/agent/ai/index.ts` barrel file
  - [x] Export all config types, parse functions, defaults, and factory
  - [x] Update `packages/connector/src/agent/index.ts` to re-export AI module
  - [x] [Source: architecture/source-tree.md — ai/ section]

- [x] Task 5: Integrate AI config validation into AgentConfigLoader (AC: 8)
  - [x] Add `AIYamlConfig` import to `packages/connector/src/config/agent-config.ts`
  - [x] Add `ai?: AIYamlConfig` field to `AgentYamlConfig` interface
  - [x] Implement `validateAIConfig()` private static method
  - [x] Validate `enabled` (boolean), `model` (string, provider:model format), `apiKey` (string)
  - [x] Validate `maxTokensPerRequest` (positive number), `budget` sub-object, `personality` sub-object
  - [x] Call `validateAIConfig()` from `validateConfig()` when `ai` section exists
  - [x] [Source: architecture/components.md — AgentNode section, agent-config.ts]

- [x] Task 6: Integrate AI config into AgentNode (AC: 1)
  - [x] Add `ai?: AIAgentConfig` to `AgentNodeConfig` interface in `agent-node.ts`
  - [x] Verify `AgentConfigLoader.toAgentNodeConfig()` passes parsed AI config through to `AgentNodeConfig`
  - [x] Log AI config status during `initialize()` (e.g., `AI config present: enabled=${ai.enabled}, model=${ai.model}`)
  - [x] **Note:** Dispatcher field (`_aiDispatcher`), initialization (`_initializeAIDispatcher()`), and event routing integration are deferred to Story 16.4 (AI Agent Dispatcher). Pre-existing code on `epic-16` branch already implements these — the dev agent should leave that code in place but NOT add it as part of this story's scope.
  - [x] [Source: architecture/components.md — AgentNode section]

- [x] Task 7: Write unit tests for AI config and provider factory (AC: 9)
  - [x] Create `packages/connector/src/agent/ai/__tests__/ai-agent-config.test.ts`
    - [x] Test `parseAIConfig()` with defaults, YAML overrides, and env var overrides
    - [x] Test `isValidModelString()` with valid and invalid formats
    - [x] Test `parseModelString()` parsing behavior
    - [x] Test `AI_AGENT_DEFAULTS` constant values
    - [x] Test `envBool()` and `envInt()` edge cases (via parseAIConfig env var paths)
  - [x] Create `packages/connector/src/agent/ai/__tests__/provider-factory.test.ts`
    - [x] Test `createModelFromConfig()` for supported providers (mock dynamic imports)
    - [x] Test unsupported provider error messages
    - [x] Test MODULE_NOT_FOUND error handling
    - [x] Test fallback to provider-specific env vars (`ANTHROPIC_API_KEY`, `OPENAI_API_KEY`)
  - [x] Add `validateAIConfig()` tests in `packages/connector/src/config/agent-config.test.ts` (co-located with existing AgentConfigLoader tests, or create if not present)
    - [x] Test valid AI config passes validation
    - [x] Test invalid `model` format rejected
    - [x] Test invalid `enabled` type rejected
    - [x] Test invalid `maxTokensPerRequest` (non-positive) rejected
    - [x] Test invalid `budget` sub-object validation
    - [x] Test invalid `personality` sub-object validation
  - [x] All tests follow AAA pattern, mock external dependencies
  - [x] [Source: architecture/test-strategy-and-standards.md — Unit Tests section]

## Dev Notes

### Previous Story Insights (from Story 15.6)

- Story 15.6 completed the Peers & Routing Table View for the Agent Explorer
- The agent system has a well-established pattern for configuration, initialization, and component orchestration via `AgentNode`
- The `AgentConfigLoader` class in `config/agent-config.ts` handles all YAML config parsing and validation
- The `AgentNode` constructor wires up all components; `initialize()` creates DB schema and registers handlers

### Data Models

**AIAgentConfig interface:**

```typescript
interface AIAgentConfig {
  enabled: boolean; // default: true
  model: string; // "provider:model" format
  apiKey?: string; // from config or AI_API_KEY env var
  maxTokensPerRequest: number; // default: 1024
  budget: AIBudgetConfig;
  personality?: AIAgentPersonality;
}
```

**AIBudgetConfig interface:**

```typescript
interface AIBudgetConfig {
  maxTokensPerHour: number; // default: 100000
  fallbackOnExhaustion: boolean; // default: true
}
```

**AIAgentPersonality interface:**

```typescript
interface AIAgentPersonality {
  name?: string;
  role?: string;
  instructions?: string;
}
```

[Source: docs/prd/epic-16-ai-agent-node.md#configuration]

### API Specifications

**Provider Factory:**

- `createModelFromConfig(config: AIAgentConfig): Promise<LanguageModelV1>` — dynamically imports the correct `@ai-sdk/*` package
- Returns `LanguageModelV1` from the `ai` package (Vercel AI SDK core type)
- Switch on provider string: `'anthropic'` → `@ai-sdk/anthropic`, `'openai'` → `@ai-sdk/openai`

**Config Parser:**

- `parseAIConfig(yaml?: AIYamlConfig): AIAgentConfig` — merges YAML config with env var overrides
- `isValidModelString(model: string): boolean` — validates `provider:model` format
- `parseModelString(model: string): { provider: string; modelName: string }` — splits on first colon

**Environment Variable Overrides:**
| Variable | Description | Default |
|----------|-------------|---------|
| `AI_API_KEY` | API key for the AI provider | — |
| `AI_AGENT_ENABLED` | Override `ai.enabled` | `true` |
| `AI_AGENT_MODEL` | Override `ai.model` | `anthropic:claude-haiku-4-5` |
| `AI_MAX_TOKENS_PER_REQUEST` | Override per-request limit | `1024` |
| `AI_MAX_TOKENS_PER_HOUR` | Override hourly budget | `100000` |

[Source: architecture/components.md#aiagentdispatcher, architecture/ai-agent-skills.md#configuration-reference]

### File Locations

| File                                                                 | Purpose                                                                                          |
| -------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------ |
| `packages/connector/src/agent/ai/ai-agent-config.ts`                 | Create — AI config types, defaults, parser                                                       |
| `packages/connector/src/agent/ai/provider-factory.ts`                | Create — Provider-agnostic model factory                                                         |
| `packages/connector/src/agent/ai/index.ts`                           | Create — AI module barrel exports                                                                |
| `packages/connector/src/agent/index.ts`                              | Modify — re-export AI module                                                                     |
| `packages/connector/src/agent/agent-node.ts`                         | Modify — Add `ai?: AIAgentConfig` to `AgentNodeConfig` (dispatcher integration deferred to 16.4) |
| `packages/connector/src/config/agent-config.ts`                      | Modify — AI YAML validation in `AgentConfigLoader`                                               |
| `packages/connector/package.json`                                    | Modify — add AI SDK dependencies                                                                 |
| `packages/connector/src/agent/ai/__tests__/ai-agent-config.test.ts`  | Create — Config types and parser tests                                                           |
| `packages/connector/src/agent/ai/__tests__/provider-factory.test.ts` | Create — Provider factory tests                                                                  |
| `packages/connector/src/config/agent-config.test.ts`                 | Modify or Create — validateAIConfig() tests                                                      |

[Source: architecture/source-tree.md — ai/ section]

### Testing Requirements

- **Framework:** Jest 29.7.x with ts-jest
- **Location:** `packages/connector/src/agent/ai/__tests__/` for AI module tests
- **Patterns:** AAA (Arrange, Act, Assert), descriptive test names, mock all external deps
- **Coverage:** >80% line coverage for connector package
- **Key mocks:** Dynamic imports for `@ai-sdk/anthropic` and `@ai-sdk/openai`, `process.env` for env var tests
- **Test isolation:** Fresh mock instances in `beforeEach()`, clean up env vars in `afterEach()`
- **Critical:** Mock the `import()` calls in provider-factory.ts — do NOT make real API calls to AI providers in unit tests

[Source: architecture/test-strategy-and-standards.md#unit-tests]

### Technical Constraints

- **Dynamic imports required:** AI SDK packages must be dynamically imported to keep them optional — agents without AI config should not require these packages installed
- **Provider:model format:** Model strings use `provider:model` format (e.g., `"anthropic:claude-haiku-4-5"`) where the provider determines which `@ai-sdk/*` package to load
- **Environment variable precedence:** YAML config takes priority over env vars, which take priority over defaults (i.e., YAML > env vars > defaults)
- **API key resolution:** Config `apiKey` > `AI_API_KEY` env var > provider-specific env var (e.g., `ANTHROPIC_API_KEY`)
- **API key security:** API keys MUST NOT be logged at any level (including debug). When logging AI config at startup, redact or omit the `apiKey` field. Log only non-sensitive fields like `model`, `enabled`, `maxTokensPerRequest`.
- **No console.log:** Use Pino logger exclusively
- **AI is default-enabled:** `ai.enabled` defaults to `true`; operators set `false` to disable
- **Fallback pattern:** AI initialization failure is non-fatal — direct handler dispatch continues to work

[Source: architecture/coding-standards.md#critical-rules, docs/prd/epic-16-ai-agent-node.md#key-design-decisions]

### Coding Standards

- TypeScript strict mode, kebab-case files, PascalCase interfaces, camelCase functions
- Private members use `_` prefix (e.g., `_aiDispatcher`)
- All async functions must handle errors with try-catch
- NEVER hardcode URLs — use env vars with defaults
- ILPErrorCode enum values for typed returns

[Source: architecture/coding-standards.md]

### Existing Code Context

**AgentNode (`agent-node.ts`):**

- Constructor validates config, creates database, subscription manager, follow graph router, event handler, TOON codec
- `initialize()` creates DB schema, registers built-in handlers
- For this story: only add `ai?: AIAgentConfig` to `AgentNodeConfig` interface. Dispatcher field, initialization, and event routing are deferred to Story 16.4
- **Note:** Pre-existing code already has dispatcher integration — leave it in place but do not add it as part of this story's deliverables

**AgentConfigLoader (`config/agent-config.ts`):**

- Static class with `loadConfig()`, `validateConfig()`, `toAgentNodeConfig()` methods
- Validation methods are private static (e.g., `validateAgentIdentity()`, `validateDatabaseConfig()`)
- Follow this existing pattern for AI config validation

[Source: packages/connector/src/agent/agent-node.ts, packages/connector/src/config/agent-config.ts]

### Pre-existing Code Warning

**There is uncommitted code on the `epic-16` branch that was written ahead of the formal story process.** The dev agent should evaluate this code against the story requirements:

- **Untracked:** `packages/connector/src/agent/ai/` — entire directory with config, factory, skills, dispatcher, tests
- **Modified (unstaged):** `agent-node.ts` (+100 lines), `agent-config.ts` (+104 lines), `index.ts` (+22 lines), `agent-server.ts` (+6 lines), `package.json` (+8/-4 lines)

The dev agent may use this code as a starting point if it meets the acceptance criteria, or rewrite as needed. All code must be validated against the ACs regardless of whether it pre-existed.

---

## Change Log

| Date       | Version | Description                                                                                                                                                                                                                                                                        | Author                |
| ---------- | ------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------- |
| 2026-01-27 | 0.1     | Initial story creation                                                                                                                                                                                                                                                             | SM                    |
| 2026-01-27 | 0.2     | Validation fixes: rescoped Task 6 (removed AIAgentDispatcher refs, deferred to 16.4), added explicit test file names to Task 7, added QA Results & Debug Log References sections, added API key security guidance, clarified env var precedence wording, added test file locations | SM                    |
| 2026-01-27 | 1.0     | Implementation complete: validated pre-existing code, added AI config passthrough in toAgentNodeConfig(), added AI config logging in initialize(), created 78 new unit tests across 3 test files                                                                                   | Dev (Claude Opus 4.5) |

---

## Dev Agent Record (Agent Populates After Execution)

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

No debug log entries needed — all tests passed on first run. No blocking issues encountered.

### Completion Notes

- Pre-existing code on the `epic-16` branch was evaluated against all ACs and found to meet requirements for Tasks 1-6. Code was validated, not rewritten.
- **New code added by this story:**
  - `toAgentNodeConfig()` in `agent-config.ts` now passes `ai: parseAIConfig(yamlConfig.ai)` through to `AgentNodeConfig` (was missing from pre-existing code)
  - AI config status logging added to `AgentNode.initialize()` (logs `enabled`, `model`, `maxTokensPerRequest` — no API key logged per security requirements)
  - `parseAIConfig` import added to `agent-config.ts` (was type-only import before)
  - Created `ai-agent-config.test.ts` (49 tests) covering defaults, YAML overrides, env var overrides, precedence, and validation
  - Created `provider-factory.test.ts` (10 tests) covering Anthropic/OpenAI creation, MODULE_NOT_FOUND handling, unsupported providers, env var fallback
  - Added 19 tests to `agent-config.test.ts` for `validateAIConfig()` and `toAgentNodeConfig()` AI passthrough
- Pre-existing dispatcher code in `agent-node.ts` was left in place per story instructions (deferred to Story 16.4)
- Two pre-existing test failures are unrelated: `profiler.test.ts` (timing flake) and `wallet-derivation.test.ts` (integration timeout)

### File List

| File                                                                 | Action       | Purpose                                                                      |
| -------------------------------------------------------------------- | ------------ | ---------------------------------------------------------------------------- |
| `packages/connector/package.json`                                    | Pre-existing | AI SDK dependencies (ai, @ai-sdk/anthropic, @ai-sdk/openai, zod)             |
| `packages/connector/src/agent/ai/ai-agent-config.ts`                 | Pre-existing | AI config types, defaults, parser, model string validation                   |
| `packages/connector/src/agent/ai/provider-factory.ts`                | Pre-existing | Provider-agnostic model factory with dynamic imports                         |
| `packages/connector/src/agent/ai/index.ts`                           | Pre-existing | AI module barrel exports                                                     |
| `packages/connector/src/agent/index.ts`                              | Pre-existing | Re-exports AI module                                                         |
| `packages/connector/src/agent/agent-node.ts`                         | Modified     | Added AI config status logging in `initialize()`                             |
| `packages/connector/src/config/agent-config.ts`                      | Modified     | Added `parseAIConfig` import, AI config passthrough in `toAgentNodeConfig()` |
| `packages/connector/src/agent/ai/__tests__/ai-agent-config.test.ts`  | Created      | 49 unit tests for AI config types, parser, defaults, env vars                |
| `packages/connector/src/agent/ai/__tests__/provider-factory.test.ts` | Created      | 10 unit tests for provider factory                                           |
| `packages/connector/src/config/agent-config.test.ts`                 | Modified     | Added 19 tests for validateAIConfig() and AI config passthrough              |

---

## QA Results

### Review Date: 2026-01-27

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Implementation quality is strong. The code is well-structured, follows established patterns in the codebase, and meets all 10 acceptance criteria. The pre-existing code was validated against ACs and augmented with test coverage and minor integration improvements (AI config passthrough, logging). Key observations:

- **ai-agent-config.ts**: Clean type definitions, correct env var merging logic with proper precedence (YAML > env > defaults), defensive validation of model strings and budget values. The `envBool` and `envInt` helpers are well-contained private utilities.
- **provider-factory.ts**: Correct use of dynamic imports to keep AI SDK optional. Error handling for `MODULE_NOT_FOUND` provides actionable install instructions. Clean switch-based provider routing.
- **agent-config.ts validateAIConfig()**: Follows the existing validation pattern established by `validateAgentIdentity()`, `validateDatabaseConfig()`, etc. Comprehensive field-by-field validation with descriptive `AgentConfigurationError` messages including field paths.
- **agent-node.ts**: AI config logging correctly omits API key per security requirements. The `_initializeAIDispatcher` was pre-existing and left in place as instructed.
- **index.ts barrel files**: Exports are correct. The AI barrel (`ai/index.ts`) also exports dispatcher, skill-registry, and other modules beyond this story's scope — these are pre-existing from the epic-16 branch.

### Refactoring Performed

No refactoring was performed. The code meets quality standards as-is.

### Compliance Check

- Coding Standards: ✓ — TypeScript strict mode, kebab-case files, PascalCase interfaces, camelCase functions, UPPER*SNAKE_CASE constants, `*`prefix for private members. No`console.log` — Pino logger used exclusively. All async functions have error handling.
- Project Structure: ✓ — Files located per architecture/source-tree.md (`agent/ai/` subdirectory). Test files co-located in `__tests__/` directory per convention.
- Testing Strategy: ✓ — Jest 29.7.x with ts-jest. AAA pattern followed. External dependencies properly mocked (dynamic imports, `process.env`). Test isolation with `beforeEach`/`afterEach` cleanup.
- All ACs Met: ✓ — See traceability matrix below.

### Acceptance Criteria Traceability

| AC  | Description                                      | Implementation                                                                                                   | Test Coverage                                                                                                  |
| --- | ------------------------------------------------ | ---------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------- |
| 1   | AI config types defined                          | `ai-agent-config.ts:13-64` — `AIAgentPersonality`, `AIBudgetConfig`, `AIAgentConfig`, `AIYamlConfig`             | `ai-agent-config.test.ts` — defaults tests (6 tests)                                                           |
| 2   | `parseAIConfig()` merges YAML+env+defaults       | `ai-agent-config.ts:85-122`                                                                                      | `ai-agent-config.test.ts` — defaults (3), YAML overrides (7), env var overrides (9), precedence (6) = 25 tests |
| 3   | Model string validation/parsing                  | `ai-agent-config.ts:127-143` — `isValidModelString()`, `parseModelString()`                                      | `ai-agent-config.test.ts` — isValidModelString (7 tests), parseModelString (4 tests)                           |
| 4   | `createModelFromConfig()` factory                | `provider-factory.ts:23-40`                                                                                      | `provider-factory.test.ts` — Anthropic (2), OpenAI (2), unsupported (2), MODULE_NOT_FOUND (4) = 10 tests       |
| 5   | Anthropic + OpenAI providers with error messages | `provider-factory.ts:42-80`                                                                                      | `provider-factory.test.ts` — covers both providers, MODULE_NOT_FOUND, unsupported                              |
| 6   | Env var overrides for all AI fields              | `ai-agent-config.ts:87-101`                                                                                      | `ai-agent-config.test.ts` — env var override tests (9 tests)                                                   |
| 7   | `AI_AGENT_DEFAULTS` constant                     | `ai-agent-config.ts:69-77`                                                                                       | `ai-agent-config.test.ts` — 6 tests verifying all default values                                               |
| 8   | `validateAIConfig()` in `AgentConfigLoader`      | `agent-config.ts:681-772`                                                                                        | `agent-config.test.ts` — 15 validateAIConfig tests + 3 AI passthrough tests                                    |
| 9   | Unit tests >80% coverage                         | See coverage data below                                                                                          | 135 total tests, 100% line coverage on AI files                                                                |
| 10  | Dependencies added                               | `package.json:29-30,44,63` — `ai ^4.3.19`, `@ai-sdk/anthropic ^1.2.12`, `@ai-sdk/openai ^1.3.24`, `zod ^3.25.76` | N/A (verified in package.json)                                                                                 |

### Test Coverage Results

| File                  | Stmts  | Branch | Funcs  | Lines  |
| --------------------- | ------ | ------ | ------ | ------ |
| `ai-agent-config.ts`  | 100%   | 94.28% | 100%   | 100%   |
| `provider-factory.ts` | 100%   | 100%   | 100%   | 100%   |
| `agent-config.ts`     | 73.02% | 75.78% | 94.73% | 72.84% |

- `ai-agent-config.ts` and `provider-factory.ts` have 100% line coverage — meets >80% threshold.
- `agent-config.ts` at 73% is below 80% but this file is shared across multiple stories; the uncovered lines are primarily in `loadPrivateKeyFromFile` (encrypted key path), `parsePricing` error paths, and env-loading code unrelated to Story 16.1. The AI-specific code within this file (`validateAIConfig`, `toAgentNodeConfig` AI passthrough) is fully covered.

### Improvements Checklist

- [x] All 10 ACs verified and traced to tests
- [x] API key never logged (confirmed at `agent-node.ts:258-265` — only `enabled`, `model`, `maxTokensPerRequest` logged)
- [x] Dynamic imports used correctly for optional AI SDK packages
- [x] Env var precedence matches spec: YAML > env > defaults
- [x] Provider-specific env var fallback works: config `apiKey` > `AI_API_KEY` > `ANTHROPIC_API_KEY`/`OPENAI_API_KEY`
- [x] Pre-existing dispatcher code left in place per story instructions
- [ ] Minor: `ai-agent-config.ts:129` — uncovered branch in `isValidModelString` for `(parts[0]?.length ?? 0)` null-coalesce path. Low risk — defensive coding, no functional impact.
- [ ] Consider: `agent-config.ts` overall coverage (73%) is below the >80% story threshold, but this is due to pre-existing code paths unrelated to this story. Story-specific additions are fully covered.

### Security Review

- **API Key Handling**: API keys are correctly omitted from log output at `agent-node.ts:258-265`. The structured log only includes `enabled`, `model`, and `maxTokensPerRequest`.
- **API Key Resolution Chain**: `config.apiKey || process.env.AI_API_KEY` in `parseAIConfig`, then `config.apiKey || process.env.ANTHROPIC_API_KEY` (or `OPENAI_API_KEY`) in provider factory. This is correct and provides layered fallback.
- **No hardcoded keys or URLs**: All API keys come from config or environment variables.
- **Dynamic imports**: Correctly prevents loading AI SDK when not needed, reducing attack surface for non-AI deployments.
- **No security vulnerabilities identified**.

### Performance Considerations

- **Dynamic imports**: AI SDK packages are loaded lazily via `import()` — no startup cost for agents that don't use AI. This is the correct pattern.
- **No performance concerns**: The config parsing and validation are one-time operations at startup. No hot-path impact.

### Files Modified During Review

No files were modified during this review.

### Gate Status

Gate: PASS → docs/qa/gates/16.1-ai-sdk-foundation-provider-factory.yml

### Recommended Status

✓ Ready for Done — All acceptance criteria met, all 135 tests passing, 100% line coverage on core AI files, no security concerns, clean implementation following established patterns.
