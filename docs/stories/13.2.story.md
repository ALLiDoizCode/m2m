<!-- Powered by BMAD™ Core -->

# Story 13.2: Agent Event Database

## Status

Done

## Story

**As a** connector developer,
**I want** a libSQL-based event storage system with NIP-01 compatible querying,
**So that** agents can persist and retrieve Nostr events locally with efficient indexing for follow graph routing and event queries.

## Acceptance Criteria

1. AgentEventDatabase stores events with all fields
2. Query by kind, pubkey, time range, tags
3. Indexes enable efficient lookups
4. Delete events by ID
5. Database size limits configurable

## Tasks / Subtasks

- [x] Task 1: Set up libSQL Dependency (AC: 1)
  - [x] Add `@libsql/client` version 0.14.0 to packages/connector/package.json
  - [x] Run `npm install` to install dependency
  - [x] Verify dependency installs correctly and types are available
  - [x] [Source: docs/architecture/tech-stack.md line 34]

- [x] Task 2: Create AgentEventDatabase Class with Schema (AC: 1, 3)
  - [x] Create file: `packages/connector/src/agent/event-database.ts`
  - [x] Define AgentEventDatabaseConfig interface:
    ```typescript
    interface AgentEventDatabaseConfig {
      path: string; // Database file path (e.g., './data/events.db')
      maxSizeBytes?: number; // Maximum database size (default: 100MB)
    }
    ```
  - [x] Create AgentEventDatabase class with constructor accepting config
  - [x] Implement `initialize(): Promise<void>` method to create database and schema:
    ```sql
    CREATE TABLE IF NOT EXISTS events (
      id TEXT PRIMARY KEY,           -- Nostr event ID (64-char hex)
      pubkey TEXT NOT NULL,          -- Author pubkey (64-char hex)
      kind INTEGER NOT NULL,         -- Event kind
      created_at INTEGER NOT NULL,   -- Unix timestamp
      content TEXT,                  -- Event content
      tags TEXT NOT NULL,            -- JSON-serialized tags array
      sig TEXT NOT NULL              -- Signature (128-char hex)
    );
    ```
  - [x] Create indexes for efficient lookups:
    ```sql
    CREATE INDEX IF NOT EXISTS idx_events_pubkey ON events(pubkey);
    CREATE INDEX IF NOT EXISTS idx_events_kind ON events(kind);
    CREATE INDEX IF NOT EXISTS idx_events_created ON events(created_at DESC);
    CREATE INDEX IF NOT EXISTS idx_events_pubkey_kind ON events(pubkey, kind);
    ```
  - [x] Implement `close(): Promise<void>` method for graceful shutdown
  - [x] [Source: docs/prd/epic-13-agent-society-protocol.md lines 82-98]

- [x] Task 3: Implement Event Storage (AC: 1)
  - [x] Import `ValidationError` from `./toon-codec` for consistent error handling
  - [x] Implement `storeEvent(event: NostrEvent): Promise<void>` method
    - [x] Validate event has all required fields (reuse validation pattern from ToonCodec)
    - [x] Serialize tags array to JSON for storage
    - [x] Use INSERT OR REPLACE to handle duplicate event IDs (idempotent)
    - [x] Check database size against maxSizeBytes limit before insert
    - [x] Throw `DatabaseSizeExceededError` if size limit reached
  - [x] Implement `storeEvents(events: NostrEvent[]): Promise<void>` method
    - [x] Use transaction for atomic batch insert
    - [x] Validate all events before beginning transaction
    - [x] Handle partial failures with rollback
  - [x] [Source: docs/prd/epic-13-agent-society-protocol.md lines 82-98, 159]

- [x] Task 4: Implement Event Querying (AC: 2, 3)
  - [x] Define NostrFilter interface (NIP-01 compatible):
    ```typescript
    interface NostrFilter {
      ids?: string[]; // Event IDs to match
      authors?: string[]; // Author pubkeys to match
      kinds?: number[]; // Event kinds to match
      since?: number; // Unix timestamp lower bound (>=)
      until?: number; // Unix timestamp upper bound (<=)
      limit?: number; // Maximum results (default: 100)
      '#e'?: string[]; // Events referenced in tags
      '#p'?: string[]; // Pubkeys referenced in tags
    }
    ```
  - [x] Implement `queryEvents(filter: NostrFilter): Promise<NostrEvent[]>` method
    - [x] Build SQL WHERE clause dynamically based on filter fields
    - [x] Handle `ids` filter: `WHERE id IN (...)`
    - [x] Handle `authors` filter: `WHERE pubkey IN (...)`
    - [x] Handle `kinds` filter: `WHERE kind IN (...)`
    - [x] Handle `since` filter: `WHERE created_at >= ?`
    - [x] Handle `until` filter: `WHERE created_at <= ?`
    - [x] Handle `#e` and `#p` tag filters: JSON_EXTRACT on tags field
    - [x] Apply limit with ORDER BY created_at DESC
    - [x] Deserialize tags from JSON to string[][]
    - [x] Return empty array for no matches (not null)
  - [x] Implement `getEventById(id: string): Promise<NostrEvent | null>` method
    - [x] Direct lookup by primary key
    - [x] Return null if not found
  - [x] [Source: docs/architecture/data-models.md lines 282-300, docs/prd/epic-13-agent-society-protocol.md line 259]

- [x] Task 5: Implement Event Deletion (AC: 4)
  - [x] Implement `deleteEvent(id: string): Promise<boolean>` method
    - [x] Execute DELETE WHERE id = ?
    - [x] Return true if event was deleted, false if not found
  - [x] Implement `deleteEvents(ids: string[]): Promise<number>` method
    - [x] Delete multiple events in single query
    - [x] Return count of events actually deleted
  - [x] Implement `deleteByFilter(filter: NostrFilter): Promise<number>` method
    - [x] Delete events matching filter criteria
    - [x] Return count of events deleted
    - [x] Useful for cleanup of old events
  - [x] [Source: docs/prd/epic-13-agent-society-protocol.md line 261]

- [x] Task 6: Implement Database Size Management (AC: 5)
  - [x] Create `DatabaseSizeExceededError` custom error class:
    ```typescript
    export class DatabaseSizeExceededError extends Error {
      constructor(message: string) {
        super(message);
        this.name = 'DatabaseSizeExceededError';
      }
    }
    ```
  - [x] Implement `getDatabaseSize(): Promise<number>` method
    - [x] Query SQLite page_count \* page_size for accurate size
  - [x] Implement `getEventCount(): Promise<number>` method
    - [x] Return total count of events in database
  - [x] Implement `pruneOldEvents(keepCount: number): Promise<number>` method
    - [x] Delete oldest events by created_at, keeping only keepCount newest
    - [x] Return count of events pruned
    - [x] Use subquery: DELETE FROM events WHERE id NOT IN (SELECT id FROM events ORDER BY created_at DESC LIMIT ?)
  - [x] Implement size check in storeEvent that throws DatabaseSizeExceededError
  - [x] [Source: docs/prd/epic-13-agent-society-protocol.md line 262]

- [x] Task 7: Create Unit Tests for AgentEventDatabase (AC: 1, 2, 3, 4, 5)
  - [x] Create test file: `packages/connector/src/agent/event-database.test.ts`
  - [x] Test database initialization:
    - [x] Creates database file at specified path
    - [x] Creates events table with correct schema
    - [x] Creates all indexes
    - [x] Handles in-memory database (path: ':memory:')
  - [x] Test event storage:
    - [x] Stores single event with all fields
    - [x] Stores batch of events atomically
    - [x] Handles duplicate event IDs (upsert)
    - [x] Validates required fields before storing
  - [x] Test event querying:
    - [x] Query by kind returns matching events
    - [x] Query by pubkey returns author's events
    - [x] Query by time range (since/until) works correctly
    - [x] Query by multiple filters (AND logic)
    - [x] Query with limit returns correct count
    - [x] Query with tag filters (#e, #p) works
    - [x] Empty result returns empty array (not null)
  - [x] Test event deletion:
    - [x] Delete by ID removes event
    - [x] Delete non-existent event returns false
    - [x] Batch delete removes multiple events
    - [x] Delete by filter removes matching events
  - [x] Test database size management:
    - [x] getDatabaseSize returns accurate size
    - [x] getEventCount returns correct count
    - [x] pruneOldEvents keeps newest events
    - [x] Size limit enforcement throws error
  - [x] Test cleanup:
    - [x] close() releases database connection
    - [x] Double close() is safe (idempotent)
  - [x] [Source: docs/architecture/test-strategy-and-standards.md lines 18-60]

- [x] Task 8: Export AgentEventDatabase from Agent Module (AC: 1, 2, 3, 4, 5)
  - [x] Update `packages/connector/src/agent/index.ts` to export:
    - [x] AgentEventDatabase class
    - [x] AgentEventDatabaseConfig interface
    - [x] NostrFilter interface
    - [x] DatabaseSizeExceededError class
  - [x] [Source: docs/prd/epic-13-agent-society-protocol.md lines 209-224]

## Dev Notes

### Previous Story Insights

Story 13.1 (TOON Codec and Event Serialization) completed the serialization foundation:

- **ToonCodec** provides encode/decode/encodeMany/decodeMany for NostrEvent serialization
- **NostrEvent interface** defined with all required fields (id, pubkey, kind, created_at, content, tags, sig)
- **Validation logic** exists in ToonCodec that validates required fields - reuse for AgentEventDatabase
- **ESM compatibility** handled with babel.config.js for Jest tests
- **File structure**: Agent code lives in `packages/connector/src/agent/`

Key insight: Story 13.2 should reuse the NostrEvent interface and validation from ToonCodec (import from `./toon-codec`).
[Source: docs/stories/13.1.story.md Dev Agent Record section]

### Technical Context

**libSQL Overview:**
libSQL is a SQLite fork optimized for concurrent access and cloud deployment:

- **MVCC concurrent writes** - Eliminates single-writer bottleneck (~4x throughput vs SQLite)
- **SQL compatible** - Same schema/queries as SQLite (drop-in replacement)
- **Encryption at rest** - Built-in for sensitive event content
- **Async API** - Non-blocking operations for Node.js
- Library: `@libsql/client` version 0.14.0
  [Source: docs/architecture/tech-stack.md line 34, docs/prd/epic-13-agent-society-protocol.md lines 193-198]

**libSQL API Usage:**

```typescript
import { createClient } from '@libsql/client';

// Create local database client
const client = createClient({
  url: 'file:./data/events.db',
});

// Execute queries
await client.execute('CREATE TABLE IF NOT EXISTS events ...');
await client.execute({
  sql: 'INSERT INTO events VALUES (?, ?, ?, ?, ?, ?, ?)',
  args: [id, pubkey, kind, created_at, content, JSON.stringify(tags), sig],
});

// Query with parameters
const result = await client.execute({
  sql: 'SELECT * FROM events WHERE kind = ?',
  args: [1],
});

// Batch operations with transaction
await client.batch(
  [
    { sql: 'INSERT INTO events ...', args: [...] },
    { sql: 'INSERT INTO events ...', args: [...] },
  ],
  'write'
);

// Close connection
await client.close();
```

**Nostr Event Storage Schema:**
From the Epic 13 PRD, the database schema for event storage:

```sql
CREATE TABLE events (
  id TEXT PRIMARY KEY,           -- Nostr event ID
  pubkey TEXT NOT NULL,          -- Author pubkey
  kind INTEGER NOT NULL,         -- Event kind
  created_at INTEGER NOT NULL,   -- Unix timestamp
  content TEXT,                  -- Event content
  tags TEXT NOT NULL,            -- JSON tags array
  sig TEXT NOT NULL              -- Signature
);

CREATE INDEX idx_events_pubkey ON events(pubkey);
CREATE INDEX idx_events_kind ON events(kind);
CREATE INDEX idx_events_created ON events(created_at DESC);
```

[Source: docs/prd/epic-13-agent-society-protocol.md lines 82-98]

**Tag Query Implementation:**
NIP-01 tag filters (#e, #p) require JSON searching. SQLite (and libSQL) support JSON functions:

```sql
-- Query events referencing a specific pubkey in tags
SELECT * FROM events
WHERE EXISTS (
  SELECT 1 FROM json_each(tags)
  WHERE json_extract(value, '$[0]') = 'p'
  AND json_extract(value, '$[1]') = ?
);
```

Alternatively, for better performance, consider a separate tags table in future iterations.
[Source: NIP-01 specification]

### Data Models

**NostrEvent Interface:**
Reuse from Story 13.1 ToonCodec:

```typescript
// Import from toon-codec.ts (already defined in Story 13.1)
interface NostrEvent {
  id: string; // 32-byte lowercase hex SHA-256
  pubkey: string; // 32-byte lowercase hex public key
  created_at: number; // Unix timestamp in seconds
  kind: number; // Event kind integer
  tags: string[][]; // Array of tag arrays
  content: string; // Event content
  sig: string; // 64-byte lowercase hex Schnorr signature
}
```

[Source: docs/architecture/data-models.md lines 253-279]

**NostrFilter Interface:**
NIP-01 compatible query filter:

```typescript
interface NostrFilter {
  ids?: string[]; // Event IDs to match
  authors?: string[]; // Author pubkeys to match
  kinds?: number[]; // Event kinds to match
  since?: number; // Unix timestamp lower bound (>=)
  until?: number; // Unix timestamp upper bound (<=)
  limit?: number; // Maximum results (default: 100)
  '#e'?: string[]; // Events referenced in tags
  '#p'?: string[]; // Pubkeys referenced in tags
}
```

[Source: docs/architecture/data-models.md lines 282-300]

**AgentEventDatabaseConfig Interface:**

```typescript
interface AgentEventDatabaseConfig {
  path: string; // Database file path or ':memory:' for in-memory
  maxSizeBytes?: number; // Maximum database size in bytes (default: 100MB = 104857600)
}
```

[Source: docs/prd/epic-13-agent-society-protocol.md line 262]

### File Locations

**New Files (Story 13.2):**

```
packages/connector/src/agent/
├── index.ts                    # Agent module exports (update)
├── toon-codec.ts              # ToonCodec (from Story 13.1)
├── toon-codec.test.ts         # ToonCodec tests (from Story 13.1)
├── event-database.ts          # AgentEventDatabase implementation (NEW)
└── event-database.test.ts     # Unit tests (NEW)
```

[Source: docs/prd/epic-13-agent-society-protocol.md lines 209-224]

### Testing Requirements

**Unit Test Location:** `packages/connector/src/agent/event-database.test.ts` (co-located)
[Source: docs/architecture/test-strategy-and-standards.md line 23]

**Test Framework:** Jest 29.7.x with TypeScript support
[Source: docs/architecture/tech-stack.md line 23]

**Required Test Coverage:**

- Database initialization and schema creation
- CRUD operations (create, read, update via upsert, delete)
- All filter types (ids, authors, kinds, since, until, limit, #e, #p)
- Tag querying with JSON extraction
- Size management and pruning
- Error handling for invalid inputs
- Edge cases: empty database, no matches, duplicate IDs

**Test Pattern:**

```typescript
describe('AgentEventDatabase', () => {
  let db: AgentEventDatabase;

  beforeEach(async () => {
    // Use in-memory database for test isolation
    db = new AgentEventDatabase({ path: ':memory:' });
    await db.initialize();
  });

  afterEach(async () => {
    await db.close();
  });

  it('should store and retrieve event by ID', async () => {
    const event = createTestEvent({ kind: 1 });

    await db.storeEvent(event);
    const retrieved = await db.getEventById(event.id);

    expect(retrieved).toEqual(event);
  });
});
```

[Source: docs/architecture/test-strategy-and-standards.md lines 36-59]

### Technical Constraints

**TypeScript Configuration:**

- Strict mode enabled (`strict: true`)
- No `any` types except in test mocks
- Use async/await for all database operations
  [Source: docs/architecture/coding-standards.md lines 38-41]

**Naming Conventions:**

- File: `event-database.ts` (kebab-case)
- Class: `AgentEventDatabase` (PascalCase)
- Interface: `NostrFilter`, `AgentEventDatabaseConfig` (PascalCase)
- Methods: `storeEvent`, `queryEvents`, `deleteEvent` (camelCase)
  [Source: docs/architecture/coding-standards.md lines 14-20]

**Error Handling:**

- Use Pino logger for error logging (no console.log)
- Throw descriptive errors for invalid operations
- Use try-catch around libSQL operations
- Custom error class: `DatabaseSizeExceededError` (for size limits)
- Reuse `ValidationError` from `./toon-codec` for input validation errors
  [Source: docs/architecture/coding-standards.md lines 24, 30-31]

**Database Best Practices:**

- Always use parameterized queries (prevent SQL injection)
- Use transactions for batch operations
- Close database connection on graceful shutdown
- Handle SQLITE_BUSY errors with retry logic if needed
  [Source: docs/architecture/test-strategy-and-standards.md lines 559-631 - resource cleanup]

### Performance Considerations

**Indexing Strategy:**
The indexes defined in the schema optimize the most common query patterns:

- `idx_events_pubkey`: Query events by author (Kind 3 follow list lookups)
- `idx_events_kind`: Query events by kind (filtering text notes, follow lists, etc.)
- `idx_events_created`: Order by time (newest first) for timeline queries
- `idx_events_pubkey_kind`: Composite index for "all Kind 3 events from Alice"

[Source: docs/prd/epic-13-agent-society-protocol.md lines 95-98]

**Default Limits:**

- Query limit default: 100 events (prevent unbounded queries)
- Database max size default: 100MB (configurable via maxSizeBytes)
- Consider adding WAL mode for better concurrent read performance

**Memory Usage:**

- libSQL handles connection pooling internally
- Keep result sets reasonable with LIMIT
- For very large result sets, consider cursor-based pagination (deferred)

### Dependencies

**New npm Dependencies:**

```json
{
  "@libsql/client": "0.14.0"
}
```

[Source: docs/architecture/tech-stack.md line 34]

**Existing Dependencies (from Story 13.1):**

- TypeScript 5.3.3
- Node.js 20.11.0 LTS
- Jest 29.7.x
- nostr-tools 2.10.0 (for types, may not be needed in this story)

### Edge Cases and Error Scenarios

**Empty Content:**

- Kind 3 (Follow List) typically has empty content: `"content": ""`
- Database should store empty strings, not null

**Large Content:**

- Event content can be up to 64KB
- TEXT column in SQLite handles this without issues

**Duplicate Event IDs:**

- Nostr event IDs are deterministic (hash of event data)
- Use INSERT OR REPLACE for idempotent storage
- Later events with same ID overwrite earlier ones

**Invalid Input Handling:**

- Missing required fields: throw `ValidationError` with descriptive message
- Invalid event ID format: validate 64-character hex
- Invalid pubkey format: validate 64-character hex
- Database full: throw `DatabaseSizeExceededError`

**Concurrent Access:**

- libSQL's MVCC handles concurrent reads and writes
- No explicit locking needed at application level
- Transactions ensure atomic batch operations

## Testing

### Test File Location

`packages/connector/src/agent/event-database.test.ts`
[Source: docs/architecture/test-strategy-and-standards.md line 23 - co-located tests]

### Test Framework

Jest 29.7.x with ts-jest for TypeScript support
[Source: docs/architecture/tech-stack.md line 23]

### Test Commands

```bash
# Run AgentEventDatabase unit tests
npm test -- event-database.test.ts

# Run with coverage
npm test -- --coverage event-database.test.ts

# Run all agent module tests
npm test -- packages/connector/src/agent/
```

### Test Coverage Requirements

- > 80% line coverage for AgentEventDatabase
- All query filter types tested
- CRUD operations tested
- Error handling paths tested
- Edge cases: empty database, no matches, duplicate IDs
  [Source: docs/architecture/test-strategy-and-standards.md lines 7-9]

### Acceptance Criteria Verification

| AC# | Test Scenario                     | Verification Method                        |
| --- | --------------------------------- | ------------------------------------------ |
| 1   | Store events with all fields      | `storeEvent()` then `getEventById()` match |
| 2   | Query by kind, pubkey, time, tags | Filter queries return expected results     |
| 3   | Indexes enable efficient lookups  | Schema verification, query execution       |
| 4   | Delete events by ID               | `deleteEvent()` returns true, event gone   |
| 5   | Database size limits              | `getDatabaseSize()`, size limit error      |

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### File List

| File                                                  | Action   | Description                                                                  |
| ----------------------------------------------------- | -------- | ---------------------------------------------------------------------------- |
| `packages/connector/package.json`                     | Modified | Added `@libsql/client` version 0.14.0 dependency                             |
| `packages/connector/src/agent/event-database.ts`      | Created  | AgentEventDatabase class with libSQL-based event storage                     |
| `packages/connector/src/agent/event-database.test.ts` | Created  | 43 unit tests covering all acceptance criteria                               |
| `packages/connector/src/agent/index.ts`               | Modified | Added exports for AgentEventDatabase, NostrFilter, DatabaseSizeExceededError |
| `packages/connector/jest.config.js`                   | Modified | Added @libsql to transformIgnorePatterns for ESM compatibility               |
| `package-lock.json`                                   | Modified | Updated with @libsql/client and its dependencies                             |

### Debug Log References

None - no blocking issues encountered.

### Completion Notes

- All 8 tasks completed successfully
- 43 unit tests passing (79 total in agent module including toon-codec tests)
- TypeScript compilation successful
- Lint checks passing
- Key implementation details:
  - Used Jest mock for toon-codec in event-database tests to avoid ESM transformation conflicts with @toon-format/toon when loading through @libsql/client
  - NostrFilter interface supports NIP-01 compatible queries including #e and #p tag filters using SQLite JSON functions
  - Database size management implemented with pragmas for accurate size calculation
  - Batch operations use libSQL's batch() method for atomic transactions

## Change Log

| Date       | Version | Description                                                                                                                                                              | Author     |
| ---------- | ------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ---------- |
| 2026-01-23 | 0.1     | Initial story draft creation                                                                                                                                             | SM         |
| 2026-01-23 | 0.2     | Validation fixes: Added explicit DatabaseSizeExceededError creation subtask; Clarified ValidationError import from toon-codec; Removed undefined DatabaseError reference | Validation |
| 2026-01-23 | 1.0     | Implementation complete: AgentEventDatabase with libSQL, 43 tests passing, all ACs verified                                                                              | Dev        |

## QA Results

### Review Date: 2026-01-23

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation quality. The AgentEventDatabase follows the same clean patterns established in Story 13.1's ToonCodec. Key strengths:

- **SQL Security**: All queries use parameterized statements with dynamic placeholder generation - no SQL injection vectors
- **Error Handling**: Proper use of custom error classes (`DatabaseSizeExceededError`, `ValidationError` imported from toon-codec)
- **Type Safety**: Full TypeScript strict mode compliance with explicit type assertions for libSQL results
- **API Design**: Clean NIP-01 compatible query interface with sensible defaults (limit: 100, maxSizeBytes: 100MB)

### Refactoring Performed

No refactoring required - the implementation is already clean and follows coding standards.

### Compliance Check

- Coding Standards: ✓ Follows naming conventions, no console.log, proper async/await usage
- Project Structure: ✓ Co-located tests, proper exports from index.ts, kebab-case files
- Testing Strategy: ✓ 43 unit tests with proper setup/teardown, uses in-memory database for isolation
- All ACs Met: ✓ All 5 acceptance criteria have comprehensive test coverage

### Improvements Checklist

All items below are optional future improvements, not blockers:

- [ ] Extract shared validation logic from toon-codec and event-database to shared utility (DRY principle)
- [ ] Add separate tags table for better #e/#p filter performance at scale
- [ ] Add WAL mode configuration option for better concurrent read performance
- [ ] Add integration test with real file-based database

### Security Review

**PASS** - No security concerns identified.

- All SQL queries use parameterized statements via libSQL's `args` parameter
- Input validation occurs before any database operations
- No raw string concatenation in SQL construction
- Tag filters use safe JSON_EXTRACT with parameterized values

### Performance Considerations

**PASS** - Appropriate for MVP scale.

- Proper indexing strategy: `idx_events_pubkey`, `idx_events_kind`, `idx_events_created`, `idx_events_pubkey_kind`
- Tag filters use JSON_EACH with EXISTS subquery - acceptable for MVP, may need dedicated tag table at scale
- Default query limit (100) prevents unbounded result sets
- Database size check occurs before inserts to prevent runaway growth

### Files Modified During Review

None - no refactoring was performed.

### Gate Status

Gate: **PASS** → docs/qa/gates/13.2-agent-event-database.yml

### Recommended Status

✓ **Ready for Done** - All acceptance criteria verified, comprehensive test coverage, clean implementation following established patterns
