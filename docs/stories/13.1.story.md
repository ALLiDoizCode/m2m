<!-- Powered by BMAD™ Core -->

# Story 13.1: TOON Codec and Event Serialization

## Status

Draft

## Story

**As a** connector developer,
**I want** a TOON encoding/decoding wrapper for Nostr events in ILP packet data fields,
**So that** agents can efficiently serialize and transmit Nostr events through the Interledger network with 30-60% size reduction compared to JSON.

## Acceptance Criteria

1. ToonCodec encodes single Nostr event to Buffer
2. ToonCodec decodes Buffer back to Nostr event (lossless)
3. ToonCodec handles arrays of events efficiently
4. Unit tests cover all Nostr event kinds
5. Performance benchmark vs JSON serialization

## Tasks / Subtasks

- [ ] Task 1: Set up TOON and nostr-tools Dependencies (AC: 1, 2)
  - [ ] Add `@toon-format/toon` version 3.0.0 to packages/connector/package.json
  - [ ] Add `nostr-tools` version 2.10.0 to packages/connector/package.json
  - [ ] Run `npm install` to install dependencies
  - [ ] Verify dependencies install correctly and types are available
  - [ ] [Source: docs/architecture/tech-stack.md lines 35-36]

- [ ] Task 2: Create ToonCodec Class for Single Event Encoding/Decoding (AC: 1, 2)
  - [ ] Create file: `packages/connector/src/agent/toon-codec.ts`
  - [ ] Define NostrEvent interface matching nostr-tools Event type:
    ```typescript
    interface NostrEvent {
      id: string; // 32-byte hex event ID
      pubkey: string; // 32-byte hex public key
      created_at: number; // Unix timestamp
      kind: number; // Event kind (1, 3, 5, 10000, etc.)
      tags: string[][]; // Array of tag arrays
      content: string; // Event content
      sig: string; // 64-byte hex signature
    }
    ```
  - [ ] Implement `encode(event: NostrEvent): Buffer` method (AC: 1)
    - [ ] Convert NostrEvent object to TOON format using `@toon-format/toon` serialize()
    - [ ] Return Buffer containing TOON-serialized data
    - [ ] Handle serialization errors with try-catch, throw descriptive error
  - [ ] Implement `decode(buffer: Buffer): NostrEvent` method (AC: 2)
    - [ ] Parse TOON-serialized data using `@toon-format/toon` deserialize()
    - [ ] Validate decoded object has all required NostrEvent fields
    - [ ] Return strongly-typed NostrEvent object
    - [ ] Throw error if buffer contains invalid TOON data or missing fields
  - [ ] Add input validation:
    - [ ] Validate event has required fields before encoding (id, pubkey, kind, created_at, tags, content, sig)
    - [ ] Validate decoded event has all required fields before returning
  - [ ] [Source: docs/prd/epic-13-agent-society-protocol.md lines 50-58, 163]

- [ ] Task 3: Implement Array Event Encoding/Decoding (AC: 3)
  - [ ] Implement `encodeMany(events: NostrEvent[]): Buffer` method (AC: 3)
    - [ ] Serialize array of events as TOON array
    - [ ] Return single Buffer containing all serialized events
    - [ ] Handle empty arrays gracefully (return valid empty TOON array)
  - [ ] Implement `decodeMany(buffer: Buffer): NostrEvent[]` method (AC: 3)
    - [ ] Deserialize TOON array to NostrEvent[]
    - [ ] Validate each event in array has required fields
    - [ ] Return empty array for empty TOON array input
    - [ ] Throw error if any event in array is invalid
  - [ ] Implement efficient streaming for large arrays (if TOON supports):
    - [ ] Consider memory usage for arrays with 100+ events
    - [ ] Document maximum recommended array size
  - [ ] [Source: docs/prd/epic-13-agent-society-protocol.md line 249]

- [ ] Task 4: Implement Unit Tests for All Event Kinds (AC: 4)
  - [ ] Create test file: `packages/connector/src/agent/toon-codec.test.ts`
  - [ ] Test Kind 0 (Metadata) encoding/decoding:
    - [ ] Create test event with JSON content containing profile metadata
    - [ ] Verify round-trip lossless: `decode(encode(event))` equals original
  - [ ] Test Kind 1 (Text Note) encoding/decoding:
    - [ ] Create test event with text content and tags
    - [ ] Verify all fields preserved including unicode content
  - [ ] Test Kind 3 (Follow List) encoding/decoding:
    - [ ] Create test event with multiple p-tags and ilp-tags
    - [ ] Verify complex tag arrays preserved correctly
    - [ ] Test event structure: `{ kind: 3, tags: [["p", pubkey, relay, petname], ["ilp", pubkey, "g.agent.alice"]] }`
  - [ ] Test Kind 5 (Delete) encoding/decoding:
    - [ ] Create test event with e-tags referencing deleted events
    - [ ] Verify e-tag event IDs preserved
  - [ ] Test Kind 10000 (Query) encoding/decoding (custom kind for agent queries):
    - [ ] Create test event with query filter content
    - [ ] Verify query structure preserved
  - [ ] Test array encoding/decoding:
    - [ ] Test empty array: `encodeMany([])` and `decodeMany(result)`
    - [ ] Test single event array
    - [ ] Test multiple events of different kinds
    - [ ] Test 100 events to verify performance at scale
  - [ ] Test error handling:
    - [ ] Invalid TOON buffer should throw descriptive error
    - [ ] Missing required fields should throw validation error
    - [ ] Corrupted buffer should be detected
  - [ ] [Source: docs/architecture/test-strategy-and-standards.md lines 18-60]

- [ ] Task 5: Implement Performance Benchmark vs JSON (AC: 5)
  - [ ] Create benchmark file: `packages/connector/src/agent/toon-codec.benchmark.ts`
  - [ ] Implement benchmark harness:
    - [ ] Generate 1000 sample NostrEvents of varying kinds
    - [ ] Include events with small (100 chars) and large (10KB) content
  - [ ] Benchmark TOON encoding:
    - [ ] Measure time to encode 1000 events
    - [ ] Measure total output size in bytes
  - [ ] Benchmark JSON encoding (baseline):
    - [ ] Measure time to JSON.stringify 1000 events
    - [ ] Measure total output size in bytes
  - [ ] Calculate and report metrics:
    - [ ] Size reduction percentage: `(jsonSize - toonSize) / jsonSize * 100`
    - [ ] Encoding speed ratio: `jsonTime / toonTime`
    - [ ] Decoding speed ratio
  - [ ] Assert minimum performance targets:
    - [ ] TOON size should be at least 25% smaller than JSON (conservative target)
    - [ ] TOON encoding should be at most 2x slower than JSON (acceptable trade-off)
  - [ ] Add npm script: `"benchmark:toon": "ts-node src/agent/toon-codec.benchmark.ts"`
  - [ ] [Source: docs/prd/epic-13-agent-society-protocol.md lines 35-36 (30-60% smaller claim)]

- [ ] Task 6: Export ToonCodec from Agent Module (AC: 1, 2, 3)
  - [ ] Create agent module index: `packages/connector/src/agent/index.ts`
  - [ ] Export ToonCodec class
  - [ ] Export NostrEvent interface
  - [ ] Export any helper types (ToonEncodeError, ToonDecodeError if created)
  - [ ] [Source: docs/prd/epic-13-agent-society-protocol.md lines 209-224 package structure]

## Dev Notes

### Previous Story Insights

Story 12.10 (Production Acceptance Testing and Go-Live) completed the Epic 12 production hardening phase:

- 106 acceptance tests created and passing across all epics
- Production launch scripts and documentation created
- Load test framework ready for 24-hour sustained testing
- Full acceptance test suite validates all 12 epics

Key insight: Epic 13 begins a new phase focused on agent-to-agent communication using Nostr events over ILP. Story 13.1 establishes the serialization foundation that all subsequent agent stories will depend on.
[Source: docs/stories/12.10.story.md Dev Agent Record section]

### Technical Context

**TOON Format Overview:**
TOON (Token-Oriented Object Notation) is a binary serialization format designed for LLM-friendly data exchange:

- 30-60% smaller than JSON for typical payloads
- Efficient parsing with minimal overhead
- Preserves all JSON-compatible data types
- Library: `@toon-format/toon` version 3.0.0
  [Source: docs/architecture/tech-stack.md line 35]

**Nostr Event Structure:**
Standard Nostr events (NIP-01) have this structure that must be preserved exactly:

```typescript
{
  id: string;        // 32-byte lowercase hex SHA-256 of serialized event
  pubkey: string;    // 32-byte lowercase hex public key
  created_at: number; // Unix timestamp in seconds
  kind: number;      // Event kind (integer)
  tags: string[][];  // Array of arrays of strings
  content: string;   // Arbitrary string content
  sig: string;       // 64-byte lowercase hex Schnorr signature
}
```

[Source: docs/prd/epic-13-agent-society-protocol.md lines 50-58]

**ILP Packet Data Field:**
The ToonCodec output will be placed in ILP packet `data` field:

```typescript
interface ILPPreparePacket {
  type: PacketType.PREPARE;
  amount: bigint;
  destination: ILPAddress;
  executionCondition: Buffer;
  expiresAt: Date;
  data: Buffer; // <-- TOON-serialized Nostr event goes here
}
```

[Source: docs/prd/epic-13-agent-society-protocol.md lines 50-58]

**nostr-tools Library:**
The `nostr-tools` library (version 2.10.0) provides:

- Event type definitions
- Event ID generation and verification
- Signature creation and verification
- Various NIP implementations

Note: ToonCodec handles serialization only. Signature verification and event ID validation will be handled by other components (Story 13.3 AgentEventHandler).
[Source: docs/architecture/tech-stack.md line 36]

### Data Models

**NostrEvent Interface:**
[Source: docs/prd/epic-13-agent-society-protocol.md lines 50-58, NIP-01 specification]

```typescript
interface NostrEvent {
  id: string; // 32-byte lowercase hex-encoded SHA-256
  pubkey: string; // 32-byte lowercase hex-encoded public key
  created_at: number; // Unix timestamp in seconds
  kind: number; // Event kind integer
  tags: string[][]; // Array of tag arrays
  content: string; // Event content (may be JSON for some kinds)
  sig: string; // 64-byte lowercase hex-encoded Schnorr signature
}
```

**ToonCodec Class:**
[Source: docs/prd/epic-13-agent-society-protocol.md line 163]

```typescript
class ToonCodec {
  encode(event: NostrEvent): Buffer;
  decode(buffer: Buffer): NostrEvent;
  encodeMany(events: NostrEvent[]): Buffer;
  decodeMany(buffer: Buffer): NostrEvent[];
}
```

### File Locations

**New Files (Story 13.1):**

```
packages/connector/src/agent/
├── index.ts                    # Agent module exports
├── toon-codec.ts              # ToonCodec implementation
├── toon-codec.test.ts         # Unit tests
└── toon-codec.benchmark.ts    # Performance benchmark
```

[Source: docs/prd/epic-13-agent-society-protocol.md lines 209-224]

**Note:** The `packages/connector/src/agent/` directory does not exist yet and must be created as part of this story.

### Testing Requirements

**Unit Test Location:** `packages/connector/src/agent/toon-codec.test.ts` (co-located)
[Source: docs/architecture/test-strategy-and-standards.md line 23]

**Test Framework:** Jest 29.7.x with TypeScript support
[Source: docs/architecture/test-strategy-and-standards.md line 20]

**Required Test Coverage:**

- All Nostr event kinds used in Epic 13: Kind 0, 1, 3, 5, 10000
- Round-trip encoding/decoding (lossless verification)
- Array encoding/decoding with various sizes
- Error handling for invalid inputs
- Edge cases: empty content, large content, unicode, special characters in tags

**Test Pattern:**

```typescript
describe('ToonCodec', () => {
  let codec: ToonCodec;

  beforeEach(() => {
    codec = new ToonCodec();
  });

  it('should encode and decode Kind 1 text note losslessly', () => {
    const event: NostrEvent = createTestEvent({ kind: 1, content: 'Hello, world!' });

    const encoded = codec.encode(event);
    const decoded = codec.decode(encoded);

    expect(decoded).toEqual(event);
  });
});
```

[Source: docs/architecture/test-strategy-and-standards.md lines 36-59]

### Technical Constraints

**TypeScript Configuration:**

- Strict mode enabled (`strict: true`)
- No `any` types except in test mocks
- Use `Buffer` for binary data (Node.js convention)
  [Source: docs/architecture/coding-standards.md lines 38-41]

**Naming Conventions:**

- File: `toon-codec.ts` (kebab-case)
- Class: `ToonCodec` (PascalCase)
- Interface: `NostrEvent` (PascalCase)
- Methods: `encode`, `decode`, `encodeMany`, `decodeMany` (camelCase)
  [Source: docs/architecture/coding-standards.md lines 14-20]

**Logging Standards:**

- Use Pino logger for any error logging (no console.log)
- ToonCodec may not need logging for MVP (pure encoding/decoding)
  [Source: docs/architecture/coding-standards.md line 24]

**Error Handling:**

- Throw descriptive errors for invalid input
- Use try-catch around TOON library calls
- Validate all required fields before encoding/after decoding
  [Source: docs/architecture/coding-standards.md line 31]

### Performance Considerations

**Expected Size Reduction:**
TOON claims 30-60% size reduction vs JSON. Story 13.1 benchmark must verify this claim for Nostr events specifically.
[Source: docs/prd/epic-13-agent-society-protocol.md lines 35-36]

**Memory Usage:**

- For large event arrays, consider streaming if TOON supports it
- Document maximum recommended array size based on benchmark results
- Typical ILP packet max data size is 32KB (per RFC-0027)

**Encoding/Decoding Speed:**

- TOON may be slightly slower than JSON.stringify/parse due to binary format
- Acceptable trade-off for size reduction in network transmission
- Benchmark should verify speed is within 2x of JSON (conservative limit)

### Dependencies

**New npm Dependencies:**

```json
{
  "@toon-format/toon": "3.0.0",
  "nostr-tools": "2.10.0"
}
```

[Source: docs/architecture/tech-stack.md lines 35-36]

**Existing Dependencies (no changes):**

- TypeScript 5.3.3
- Node.js 20.11.0 LTS
- Jest 29.7.x

### Edge Cases and Error Scenarios

**Empty Content:**

- Kind 3 (Follow List) typically has empty content: `"content": ""`
- ToonCodec must preserve empty strings, not convert to null/undefined

**Large Content:**

- Kind 1 notes can have content up to 64KB
- Benchmark should test with 10KB content to verify no truncation

**Unicode and Special Characters:**

- Nostr content may contain any unicode characters
- Tags may contain special characters
- ToonCodec must preserve all characters exactly

**Invalid Input Handling:**

- Corrupted TOON buffer: throw `ToonDecodeError` with message "Invalid TOON format"
- Missing required field: throw `ValidationError` with message "Missing required field: {fieldName}"
- Wrong type for field: throw `ValidationError` with message "Invalid type for field: {fieldName}"

## Testing

### Test File Location

`packages/connector/src/agent/toon-codec.test.ts`
[Source: docs/architecture/test-strategy-and-standards.md line 23 - co-located tests]

### Test Framework

Jest 29.7.x with ts-jest for TypeScript support
[Source: docs/architecture/tech-stack.md line 23]

### Test Commands

```bash
# Run ToonCodec unit tests
npm test -- toon-codec.test.ts

# Run with coverage
npm test -- --coverage toon-codec.test.ts

# Run benchmark (separate script)
npm run benchmark:toon
```

### Test Coverage Requirements

- > 80% line coverage for ToonCodec
- All 5 event kinds tested (0, 1, 3, 5, 10000)
- Array operations tested (empty, single, multiple, large)
- Error handling paths tested
  [Source: docs/architecture/test-strategy-and-standards.md lines 7-9]

### Acceptance Criteria Verification

| AC# | Test Scenario                    | Verification Method                     |
| --- | -------------------------------- | --------------------------------------- |
| 1   | Single event encoding            | `codec.encode(event)` returns Buffer    |
| 2   | Single event decoding (lossless) | `codec.decode(encoded)` equals original |
| 3   | Array encoding/decoding          | `encodeMany`/`decodeMany` round-trip    |
| 4   | All event kinds covered          | Tests for Kind 0, 1, 3, 5, 10000        |
| 5   | Performance vs JSON              | Benchmark shows size reduction          |

## Change Log

| Date       | Version | Description                  | Author |
| ---------- | ------- | ---------------------------- | ------ |
| 2026-01-23 | 0.1     | Initial story draft creation | SM     |
