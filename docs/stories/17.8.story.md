<!-- Powered by BMAD™ Core -->

# Story 17.8: Task Status Tracking

## Status

Done

## Story

**As a** connector operator running an AI agent,
**I want** task status tracking with Kind 7000 progress updates,
**So that** task requesters can monitor long-running tasks with progress indicators and ETAs.

## Acceptance Criteria

1. Emit Kind 7000 when task moves to `processing`
2. Emit Kind 7000 with progress updates for long tasks
3. Include `progress` tag (0-100) when applicable
4. Include `eta` tag (estimated seconds) when applicable
5. Track task state locally for lifecycle management
6. Configurable status update frequency

## Tasks / Subtasks

- [ ] Task 1: Extend types for task tracking (AC: 5)
  - [ ] Add `TaskState` type to `packages/connector/src/agent/dvm/types.ts`
  - [ ] States: `queued`, `processing`, `waiting`, `completed`, `failed`, `cancelled`
  - [ ] Add `TaskTrackingMetadata` interface for local state tracking
  - [ ] Export new types from `packages/connector/src/agent/dvm/index.ts`
  - [ ] [Source: docs/prd/epic-17-nip-90-dvm-compatibility.md#story-178]

- [ ] Task 2: Extend DVM feedback formatter for progress tracking (AC: 1, 2, 3, 4)
  - [ ] Add helper functions to `packages/connector/src/agent/dvm/dvm-feedback.ts`:
    - [ ] `createProgressTag(progress: number): string[]` - Validates 0-100 range
    - [ ] `createEtaTag(seconds: number): string[]` - Estimated time remaining
    - [ ] `formatTaskFeedback(feedback: TaskFeedback): DVMFeedbackEvent` - Wrapper for task-specific feedback
  - [ ] Use existing `formatDVMFeedback()` as base (Story 17.3)
  - [ ] Add progress/eta tags to feedback events
  - [ ] [Source: packages/connector/src/agent/dvm/dvm-feedback.ts]

- [ ] Task 3: Implement task status tracker (AC: 1, 2, 5, 6)
  - [ ] Create `packages/connector/src/agent/dvm/task-status-tracker.ts`
  - [ ] Implement `TaskStatusTracker` class:
    - [ ] Constructor accepts config (update frequency, enable/disable)
    - [ ] Method `trackTask(taskId: string, metadata: TaskTrackingMetadata): void`
    - [ ] Method `updateProgress(taskId: string, progress: number, eta?: number): void`
    - [ ] Method `transitionState(taskId: string, newState: TaskState): void`
    - [ ] Emit Kind 7000 using `formatTaskFeedback()` on state changes
    - [ ] Configurable minimum time between status updates (default 5s)
    - [ ] In-memory Map to track task states
  - [ ] Export from `packages/connector/src/agent/dvm/index.ts`
  - [ ] [Source: docs/prd/epic-17-nip-90-dvm-compatibility.md#story-178]

- [ ] Task 4: Configuration support (AC: 6)
  - [ ] Add task tracking config to agent config structure
  - [ ] Config fields: `enabled: boolean`, `minUpdateIntervalMs: number`, `emitProgressUpdates: boolean`
  - [ ] Default: `enabled: true`, `minUpdateIntervalMs: 5000`, `emitProgressUpdates: true`
  - [ ] [Source: docs/prd/epic-17-nip-90-dvm-compatibility.md — configuration section]

- [ ] Task 5: Write unit tests (AC: all)
  - [ ] Create `packages/connector/src/agent/dvm/__tests__/task-status-tracker.test.ts`
  - [ ] Test state machine transitions (all states)
  - [ ] Test progress tag validation (0-100 range, reject invalid)
  - [ ] Test eta tag formatting
  - [ ] Test update frequency throttling (no spam)
  - [ ] Test Kind 7000 event creation via formatTaskFeedback()
  - [ ] Test config: enabled/disabled modes
  - [ ] **Edge cases:**
    - [ ] Progress > 100 (should clamp or error)
    - [ ] Negative progress (should error)
    - [ ] Rapid updates (should throttle)
    - [ ] Unknown task ID
  - [ ] Follow AAA pattern, >80% coverage
  - [ ] [Source: docs/architecture/test-strategy-and-standards.md]

- [ ] Task 6: Run tests and validate (AC: all)
  - [ ] Run task status tracker tests: `npx jest task-status-tracker.test.ts`
  - [ ] Run full DVM test suite: `npx jest packages/connector/src/agent/dvm/`
  - [ ] Verify no regressions in existing tests
  - [ ] Verify >80% code coverage
  - [ ] [Source: docs/architecture/test-strategy-and-standards.md]

## Dev Notes

### Previous Story Context

- **Story 17.3** (DVM Job Feedback): Created `formatDVMFeedback()` function in `packages/connector/src/agent/dvm/dvm-feedback.ts` to format Kind 7000 feedback events. This story EXTENDS that functionality with progress/eta tags.

- **Story 17.6** (Task Delegation Request): Introduced Kind 5900 task delegation requests.

- **Story 17.7** (Task Delegation Result): Introduced Kind 6900 task delegation results.

**Integration Point:** This story adds progress tracking for tasks (particularly long-running Kind 5900 delegated tasks). The TaskStatusTracker will be used by future stories (17.9, 17.10) during task execution.

[Source: docs/stories/17.3.story.md, docs/stories/17.6.story.md, docs/stories/17.7.story.md]

### Task State Machine

**States:**

- `queued`: Task accepted, waiting to start
- `processing`: Currently executing
- `waiting`: Blocked on dependency (e.g., waiting for delegated task)
- `completed`: Successfully finished
- `failed`: Error occurred during execution
- `cancelled`: Manually stopped or timed out

**State Transitions:**

```
queued → processing → completed
       ↘ waiting → processing → completed
              ↓         ↓
           cancelled  failed
```

[Source: docs/prd/epic-17-nip-90-dvm-compatibility.md#story-178]

### Kind 7000 with Progress/ETA Tags

**Extended Format:**

```json
{
  "kind": 7000,
  "tags": [
    ["e", "<task-request-event-id>"],
    ["p", "<requester-pubkey>"],
    ["status", "processing"],
    ["progress", "50"],
    ["eta", "15"]
  ],
  "content": "Processing translation task..."
}
```

**Tag Specifications:**

- `progress`: Integer 0-100 representing completion percentage (optional, only when applicable)
- `eta`: Integer seconds remaining (optional, only when calculable)
- `status`: Same as existing DVM feedback status from Story 17.3

[Source: docs/prd/epic-17-nip-90-dvm-compatibility.md#story-178]

### TypeScript Types

```typescript
// Add to packages/connector/src/agent/dvm/types.ts
export type TaskState = 'queued' | 'processing' | 'waiting' | 'completed' | 'failed' | 'cancelled';

export interface TaskTrackingMetadata {
  taskId: string; // Event ID of Kind 5900 task request
  requesterPubkey: string;
  startTime: number; // Unix timestamp
  currentState: TaskState;
  progress?: number; // 0-100
  eta?: number; // Estimated seconds remaining
  lastUpdateTime: number; // Unix timestamp of last Kind 7000 emission
}

export interface TaskFeedback {
  kind: 7000;
  status: DVMFeedbackStatus; // Reuse from Story 17.3
  jobEventId: string;
  requesterPubkey: string;
  progress?: number; // 0-100
  eta?: number; // Seconds
  message?: string;
}
```

[Source: docs/prd/epic-17-nip-90-dvm-compatibility.md#story-178]

### File Structure

```
packages/connector/src/agent/dvm/
├── types.ts                          # Modify - Add TaskState, TaskTrackingMetadata, TaskFeedback
├── dvm-feedback.ts                   # Modify - Add progress/eta helpers, formatTaskFeedback()
├── task-status-tracker.ts            # Create - TaskStatusTracker class
├── index.ts                          # Modify - Export new types and TaskStatusTracker
└── __tests__/
    ├── dvm-feedback.test.ts          # Existing - May add tests for new helpers
    └── task-status-tracker.test.ts   # Create - Unit tests for tracker
```

[Source: docs/architecture/source-tree.md, docs/prd/epic-17-nip-90-dvm-compatibility.md]

### Configuration Structure

```typescript
// Agent configuration (location TBD - may be AgentConfig or DVMConfig)
interface TaskTrackingConfig {
  enabled: boolean; // Enable/disable task status tracking
  minUpdateIntervalMs: number; // Minimum ms between status updates (throttle)
  emitProgressUpdates: boolean; // Emit progress updates or only state changes
}

// Defaults
const DEFAULT_TASK_TRACKING_CONFIG: TaskTrackingConfig = {
  enabled: true,
  minUpdateIntervalMs: 5000, // 5 seconds
  emitProgressUpdates: true,
};
```

[Source: docs/prd/epic-17-nip-90-dvm-compatibility.md — configuration section]

### Testing

**Test Framework:** Jest 29.7.x with TypeScript (`ts-jest`)

**Test File Location:** `packages/connector/src/agent/dvm/__tests__/task-status-tracker.test.ts`

**Test Pattern:** AAA (Arrange, Act, Assert) with descriptive test names

**Coverage Requirement:** >80% line coverage

**Test Scenarios:**

1. State machine transitions (all valid transitions)
2. Progress tag validation (0-100, reject out of range)
3. ETA tag formatting (positive integers)
4. Throttling (rapid updates should respect minUpdateIntervalMs)
5. Kind 7000 event creation with progress/eta tags
6. Disabled mode (no events emitted when config.enabled = false)
7. Edge cases: unknown task ID, negative progress, progress > 100

[Source: docs/architecture/test-strategy-and-standards.md]

---

## Change Log

| Date       | Version | Description   | Author |
| ---------- | ------- | ------------- | ------ |
| 2026-01-28 | 1.0     | Story created | SM     |

---

## Dev Agent Record

**Agent Model:** Claude Sonnet 4.5

**Completion Date:** 2026-01-28

**Implementation Summary:**

Completed all tasks for Story 17.8 task status tracking with progress/eta support:

- ✅ Extended types with `TaskState`, `TaskTrackingMetadata`, `TaskFeedback` interfaces
- ✅ Added progress and eta helper functions to `dvm-feedback.ts`
- ✅ Created `formatTaskFeedback()` wrapper for task-specific feedback
- ✅ Implemented `TaskStatusTracker` class with full lifecycle management
- ✅ Configuration support with `TaskTrackingConfig` interface
- ✅ Comprehensive unit tests (21 tests, all passing)
- ✅ Full test suite: 199/199 tests passing (no regressions)

**Files Created:**

- `packages/connector/src/agent/dvm/task-status-tracker.ts` - TaskStatusTracker class
- `packages/connector/src/agent/dvm/__tests__/task-status-tracker.test.ts` - 21 unit tests

**Files Modified:**

- `packages/connector/src/agent/dvm/types.ts` - Added TaskState, TaskTrackingMetadata, TaskFeedback types
- `packages/connector/src/agent/dvm/dvm-feedback.ts` - Added createProgressTag(), createEtaTag(), formatTaskFeedback()
- `packages/connector/src/agent/dvm/index.ts` - Exported new types and functions

**Test Results:** 199/199 tests passed (21 new tests for task tracking)

---

## QA Results

### Review Date: 2026-01-28

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Grade: EXCELLENT**

Story 17.8 delivers a well-architected task status tracking system with comprehensive test coverage. The implementation demonstrates strong TypeScript practices, clean separation of concerns, and thoughtful design decisions.

**Strengths:**

- Clean, type-safe API with clear responsibility boundaries
- Proper use of dependency injection (FeedbackEmitter callback pattern)
- Comprehensive validation (progress range 0-100, non-negative ETA)
- Intelligent throttling mechanism prevents event spam
- State machine correctly maps TaskState to DVMFeedbackStatus
- Excellent test coverage with 21 tests covering all edge cases
- AAA pattern consistently applied in tests
- Proper error handling with descriptive messages

### Refactoring Performed

No refactoring required. The implementation is production-ready as-is.

### Compliance Check

- ✅ **Coding Standards**: Full compliance with TypeScript strict mode, naming conventions, and documentation requirements
- ✅ **Project Structure**: Files correctly placed in `packages/connector/src/agent/dvm/` with co-located tests
- ✅ **Testing Strategy**: Exceeds 80% coverage requirement with 21 comprehensive unit tests following AAA pattern
- ✅ **All ACs Met**: All 6 acceptance criteria fully implemented and validated

### Requirements Traceability

**AC1: Emit Kind 7000 when task moves to `processing`**

- ✅ Test: "should transition to processing state" validates Kind 7000 emission
- ✅ Implementation: `transitionState()` method emits feedback on state changes

**AC2: Emit Kind 7000 with progress updates for long tasks**

- ✅ Test: "should update progress and emit feedback event" validates progress updates
- ✅ Implementation: `updateProgress()` method with throttling support

**AC3: Include `progress` tag (0-100) when applicable**

- ✅ Test: "should validate progress range (0-100)" validates range enforcement
- ✅ Test: "should include progress tag when progress is provided" validates tag inclusion
- ✅ Implementation: `createProgressTag()` with validation

**AC4: Include `eta` tag (estimated seconds) when applicable**

- ✅ Test: "should include eta tag when eta is provided" validates tag inclusion
- ✅ Implementation: `createEtaTag()` with non-negative validation

**AC5: Track task state locally for lifecycle management**

- ✅ Test: "should track a new task" validates tracking
- ✅ Test: "should transition to completed state and clean up task" validates lifecycle
- ✅ Implementation: In-memory Map with automatic cleanup

**AC6: Configurable status update frequency**

- ✅ Test: "should throttle rapid updates" validates throttling
- ✅ Test: "should not emit when emitProgressUpdates is false" validates config
- ✅ Implementation: `TaskTrackingConfig` with `minUpdateIntervalMs`

### Test Architecture Assessment

**Coverage:**

- ✅ 21 unit tests covering all methods and state transitions
- ✅ Edge cases: invalid progress, negative ETA, unknown task ID, throttling
- ✅ Configuration scenarios: enabled/disabled, emitProgressUpdates toggle
- ✅ State machine: all 6 states tested with proper status mapping
- ✅ No regressions: Full DVM suite (199 tests) passes

**Test Quality:**

- ✅ Descriptive test names clearly state intent
- ✅ AAA pattern consistently applied
- ✅ Proper use of mocks (jest.fn() for FeedbackEmitter)
- ✅ Async/await properly handled
- ✅ TypeScript strict mode compliance (proper non-null assertions)

### Non-Functional Requirements

**Security: PASS**

- No security concerns - pure business logic with no external inputs
- Validation prevents injection attacks (progress clamped, ETA validated)

**Performance: PASS**

- In-memory Map provides O(1) lookups
- Throttling prevents event spam (configurable, default 5s)
- Automatic cleanup of completed/failed tasks prevents memory leaks

**Reliability: PASS**

- Comprehensive error handling with descriptive messages
- Unknown task ID errors prevent silent failures
- State transitions always emit feedback (not throttled)
- Callback pattern allows error handling at emission point

**Maintainability: PASS**

- Clear, self-documenting code with excellent JSDoc comments
- Single Responsibility Principle: TaskStatusTracker focuses solely on tracking
- Open/Closed: Extensible via FeedbackEmitter callback
- Well-organized test file mirrors implementation structure

### Technical Debt

**None identified.** The implementation is clean with no shortcuts or deferred work.

### Security Review

No security issues. The module:

- Performs input validation on all user-provided values
- Has no external dependencies beyond existing DVM infrastructure
- Uses type-safe interfaces preventing injection attacks

### Performance Considerations

Excellent performance characteristics:

- O(1) task lookup via Map
- Throttling prevents excessive event emission
- Memory-efficient with automatic cleanup
- No blocking operations

### Gate Status

**Gate:** PASS → docs/qa/gates/17.8-task-status-tracking.yml

**Quality Score:** 100/100

- Zero critical issues
- Zero concerns
- All acceptance criteria met
- Excellent test coverage
- Production-ready implementation

### Recommended Status

✅ **Ready for Done**

All acceptance criteria met, comprehensive test coverage, no issues found. Story is production-ready and should be marked as Done.

### Implementation Highlights

1. **Intelligent Design:** FeedbackEmitter callback pattern decouples tracking from event publishing
2. **Robust Validation:** Progress and ETA validation prevents invalid data from propagating
3. **Smart Throttling:** Updates metadata even when throttled, only skips emission
4. **Clean State Management:** Automatic cleanup prevents memory leaks
5. **Excellent Testing:** 21 tests cover happy paths, edge cases, and error scenarios
