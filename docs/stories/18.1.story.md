# Story 18.1: Capability Event Types & Schema

## Status

Review

## Story

**As a** developer implementing agent capability advertisement,
**I want** TypeScript types and Zod schemas for NIP-XX1 capability events,
**so that** capability data structures are validated and type-safe throughout the application.

## Acceptance Criteria

1. `AgentCapability` type with all required fields
2. `AgentType` enum: dvm, assistant, specialist, coordinator, relay
3. `PricingEntry` type for pricing tags
4. `CapacityInfo` type for capacity tags
5. Zod schema for validation
6. Content JSON schema for metadata
7. Constants for tag names

## Tasks / Subtasks

- [x] Create types.ts in agent/discovery directory (AC: 1,2,3,4)
  - [x] Create `packages/connector/src/agent/discovery/types.ts`
  - [x] Define `AgentType` enum with all five types: dvm, assistant, specialist, coordinator, relay
  - [x] Define `PricingEntry` interface with kind, amount (bigint), and currency fields
  - [x] Define `CapacityInfo` interface with maxConcurrent and queueDepth
  - [x] Define `AgentMetadata` interface with name, about, picture, website, nip05, lud16, and capabilities fields
  - [x] Define `AgentCapability` interface with all required fields per PRD
  - [x] [Source: Epic 18 PRD - Story 18.1 Technical Notes]

- [x] Add Zod validation schemas (AC: 5,6)
  - [x] Import Zod library
  - [x] Create `AgentMetadataSchema` for JSON content validation
  - [x] Create `PricingEntrySchema` for pricing tag validation
  - [x] Create `CapacityInfoSchema` for capacity tag validation
  - [x] Create `AgentCapabilitySchema` for full capability event validation
  - [x] Add runtime validation helper: `validateAgentCapability(data: unknown): AgentCapability`
  - [x] [Source: Epic 18 PRD - Story 18.1 Technical Notes + Tech Stack - Zod schema validation]

- [x] Define tag name constants (AC: 7)
  - [x] Create `TAG_NAMES` constant object with all NIP-XX1 tag names
  - [x] Include: 'd', 'k', 'nip', 'agent-type', 'ilp-address', 'pricing', 'capacity', 'model', 'skills'
  - [x] Export constants for use by publisher and query modules
  - [x] [Source: Epic 18 PRD - Story 18.1 Event Structure]

- [x] Create barrel export in discovery/index.ts
  - [x] Create `packages/connector/src/agent/discovery/index.ts`
  - [x] Export all types from types.ts
  - [x] Export tag name constants
  - [x] [Source: Source Tree - Package structure conventions]

- [x] Write comprehensive unit tests (AC: 1-7)
  - [x] Create `packages/connector/src/agent/discovery/__tests__/types.test.ts`
  - [x] Test AgentCapability type structure with valid data
  - [x] Test all AgentType enum values
  - [x] Test PricingEntry with bigint amounts
  - [x] Test CapacityInfo with concurrent and queue values
  - [x] Test Zod schema validation success cases
  - [x] Test Zod schema validation failure cases (invalid types, missing fields)
  - [x] Test metadata schema with optional fields
  - [x] Test tag name constants correctness
  - [x] [Source: Test Strategy - Unit testing standards, AAA pattern, >80% coverage]

## Dev Notes

### Previous Story Insights

No previous stories in Epic 18 - this is the first story establishing the foundation for capability advertisement.

### Data Models

This story creates NEW data models for NIP-XX1 capability advertisement. The following models are defined in Epic 18 PRD:

**AgentType Enum:**

- Values: 'dvm', 'assistant', 'specialist', 'coordinator', 'relay'
- Purpose: Categorize agent roles in the network
- [Source: Epic 18 PRD - Story 18.1 Technical Notes]

**PricingEntry Interface:**

- `kind: number` - Event kind this pricing applies to
- `amount: bigint` - Price in smallest unit (must use bigint per ILP standards)
- `currency: 'msat' | 'sat' | 'usd'` - Currency unit
- [Source: Epic 18 PRD - Story 18.1 Technical Notes]

**CapacityInfo Interface:**

- `maxConcurrent: number` - Maximum concurrent requests
- `queueDepth: number` - Queue size for pending requests
- [Source: Epic 18 PRD - Story 18.1 Technical Notes]

**AgentMetadata Interface:**

- `name: string` - Agent display name (required)
- `about?: string` - Agent description (optional)
- `picture?: string` - Avatar URL (optional)
- `website?: string` - Homepage URL (optional)
- `nip05?: string` - Nostr NIP-05 identifier (optional)
- `lud16?: string` - Lightning address (optional)
- `capabilities?: object` - Extended capabilities:
  - `languages?: string[]` - Supported languages
  - `domains?: string[]` - Domain expertise areas
  - `maxContextTokens?: number` - Maximum context window
- Stored as JSON in Kind 31990 content field
- [Source: Epic 18 PRD - Story 18.1 Technical Notes]

**AgentCapability Interface:**

- `pubkey: string` - Agent's Nostr public key (64-character hex)
- `identifier: string` - d tag value (typically ILP address)
- `supportedKinds: number[]` - Array of supported event kinds from k tags
- `supportedNips: string[]` - Array of supported NIP identifiers from nip tags
- `agentType: AgentType` - Agent type from agent-type tag
- `ilpAddress: string` - ILP address for payments from ilp-address tag
- `pricing: Map<number, PricingEntry>` - Map of kind to pricing from pricing tags
- `capacity?: CapacityInfo` - Optional capacity information from capacity tags
- `model?: string` - Optional AI model identifier from model tag
- `skills?: string[]` - Optional skills list from skills tags
- `metadata: AgentMetadata` - Parsed JSON content
- `createdAt: number` - Unix timestamp from created_at field
- [Source: Epic 18 PRD - Story 18.1 Technical Notes]

### File Locations

Based on Epic 18 Package Structure, create files in:

```
packages/connector/src/agent/
├── discovery/
│   ├── types.ts                     # THIS STORY - Type definitions
│   ├── index.ts                     # THIS STORY - Barrel export
│   └── __tests__/
│       └── types.test.ts            # THIS STORY - Unit tests
```

[Source: Epic 18 PRD - Package Structure section]

### Technical Constraints

**Zod Integration:**

- Zod already in tech stack (^3.23.0) for AI SDK parameter validation
- Use Zod for runtime validation of capability events
- TypeScript types inferred from Zod schemas for type safety
- Pattern: Define Zod schema first, then `type AgentCapability = z.infer<typeof AgentCapabilitySchema>`
- [Source: Tech Stack - Schema Validation (AI) row]

**Nostr Event Structure:**

- Kind 31990 is parameterized replaceable event (NIP-33)
- `d` tag is required identifier (unique per pubkey)
- All tags are string arrays: `['tag-name', 'value1', 'value2', ...]`
- Content must be valid JSON string
- [Source: Epic 18 PRD - Event Structure, Data Models - NostrEvent]

**BigInt Usage:**

- Pricing amounts MUST use `bigint` type (not number)
- Consistent with ILP packet amount fields
- JSON serialization requires custom handling (BigInt not JSON-serializable by default)
- [Source: Data Models - ILPPacket, Coding Standards - strict type usage]

**TypeScript Standards:**

- Strict mode enabled - no `any` types
- Prefer interfaces over type aliases for object shapes
- Use PascalCase for interfaces and types
- Use kebab-case for file names
- [Source: Coding Standards - TypeScript Specifics, Naming Conventions]

### Testing

**Test File Location:**

- Co-located with source: `packages/connector/src/agent/discovery/__tests__/types.test.ts`
- [Source: Test Strategy - Unit Tests - File Convention]

**Test Standards:**

- Framework: Jest 29.7.x with TypeScript support (ts-jest)
- Coverage Requirement: >80% line coverage for connector package
- Follow AAA pattern (Arrange, Act, Assert)
- Use descriptive test names: "should validate capability with valid data"
- Test edge cases: empty inputs, null values, maximum values
- Mock external dependencies (none for this pure type/validation story)
- [Source: Test Strategy - Unit Tests - AI Agent Requirements]

**Specific Test Cases Required:**

- Valid AgentCapability construction with all fields
- AgentType enum exhaustive testing (all 5 values)
- PricingEntry with bigint amounts (test serialization concerns)
- CapacityInfo with valid concurrent and queue values
- Zod schema success validation (valid data passes)
- Zod schema failure validation (missing required fields, wrong types)
- AgentMetadata with optional fields (some present, some absent)
- Tag name constants match expected values
- [Source: Test Strategy - Unit Tests - Example Unit Test Structure]

**Test Anti-Patterns to Avoid:**

- Do NOT use `any` types in test mocks
- Do NOT test implementation details (internal private methods)
- Test public API behavior only
- [Source: Test Strategy - Anti-Pattern 6: Testing Implementation Details]

## Change Log

| Date       | Version | Description                                       | Author   |
| ---------- | ------- | ------------------------------------------------- | -------- |
| 2026-01-28 | 0.1     | Initial story draft created                       | SM (AI)  |
| 2026-01-28 | 1.0     | Story implementation completed, all tests passing | Dev (AI) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

None - implementation completed without issues.

### Completion Notes List

- Created `packages/connector/src/agent/discovery/types.ts` with all required types and Zod schemas
- Implemented AgentType as union type (not enum) for better TypeScript compatibility
- All interfaces use bigint for pricing amounts as required by ILP standards
- Zod schemas include transformers for bigint values (string/number → bigint)
- TAG_NAMES defined as const object with TypeScript `as const` for type safety
- Created barrel export in `index.ts` for clean module interface
- Comprehensive test suite with 44 tests covering all ACs
- All tests passing with >80% coverage requirement met
- Removed runtime immutability test (TypeScript `as const` only provides compile-time guarantees)

### File List

**Created:**

- `packages/connector/src/agent/discovery/types.ts` - Core types and Zod schemas
- `packages/connector/src/agent/discovery/index.ts` - Barrel export
- `packages/connector/src/agent/discovery/__tests__/types.test.ts` - Unit tests (44 tests)

## QA Results

### Review Date: 2026-01-28

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation of Story 18.1. The type definitions and Zod schemas are well-structured, comprehensive, and follow TypeScript best practices. The implementation correctly uses `bigint` for pricing amounts (ILP standard), implements proper validation with helpful error messages, and provides a clean API through the barrel export pattern.

Key strengths:

- Type-safe AgentType union (preferred over enum for better TypeScript compatibility)
- Comprehensive Zod schemas with proper transformers for bigint values
- Excellent separation of concerns (types, schemas, validation helpers, constants)
- Clean barrel export providing a well-defined module interface

### Refactoring Performed

No refactoring required. The implementation is clean and follows all project standards.

### Compliance Check

- Coding Standards: ✓ All naming conventions, TypeScript strict mode, and style guidelines followed
- Project Structure: ✓ Files correctly placed in `packages/connector/src/agent/discovery/` per Epic 18 structure
- Testing Strategy: ✓ Comprehensive unit tests (44 tests) with AAA pattern, >80% coverage achieved
- All ACs Met: ✓ All 7 acceptance criteria fully satisfied with test validation

### Acceptance Criteria Validation

1. ✓ `AgentCapability` type with all required fields - Implemented with complete interface
2. ✓ `AgentType` enum: dvm, assistant, specialist, coordinator, relay - Implemented as union type
3. ✓ `PricingEntry` type for pricing tags - Implemented with bigint amount support
4. ✓ `CapacityInfo` type for capacity tags - Implemented with proper validation
5. ✓ Zod schema for validation - All schemas implemented with proper transformers
6. ✓ Content JSON schema for metadata - AgentMetadataSchema validates all fields
7. ✓ Constants for tag names - TAG_NAMES constant exported with all required tags

### Requirements Traceability

**Given** the agent capability types and schemas are defined
**When** a developer uses these types to build capability advertisement features
**Then** all capability data is type-safe and runtime-validated

Mapping:

- AC1-4: Type definitions validated by type construction tests
- AC5-6: Zod schemas validated by schema validation tests (success & failure cases)
- AC7: TAG_NAMES constant validated by constant correctness tests

### Security Review

✓ PASS - No security concerns identified. This story implements pure type definitions and validation schemas with no security-critical operations.

### Performance Considerations

✓ PASS - Zod validation is efficient and appropriate for this use case. No performance concerns identified.

### Test Architecture Assessment

**Test Coverage:** Excellent (44 tests covering all ACs)

- Type structure tests validate interface contracts
- Schema validation tests cover both success and failure paths
- Edge cases well-covered (empty values, optional fields, invalid inputs)
- BigInt handling properly tested with multiple input formats

**Test Design Quality:** High

- Follows AAA (Arrange-Act-Assert) pattern consistently
- Descriptive test names clearly indicate intent
- Proper separation of test concerns
- Good use of test data factories (inline test data generation)

**Test Level Appropriateness:** Correct

- Unit tests are appropriate for pure type/schema validation
- No integration tests needed (no external dependencies)
- Mock-free tests appropriate for validation logic

### NFR Validation Summary

- **Security:** PASS - No auth, sensitive data, or security-critical operations
- **Performance:** PASS - Validation schemas are efficient, no bottlenecks
- **Reliability:** PASS - Robust Zod validation with clear error messages
- **Maintainability:** PASS - Clean code structure, comprehensive documentation

### Improvements Checklist

All improvements handled:

- [x] Verified all 7 acceptance criteria fully implemented
- [x] Confirmed test coverage exceeds 80% requirement
- [x] Validated TypeScript strict mode compliance
- [x] Verified Zod schema transformers handle bigint correctly
- [x] Confirmed TAG_NAMES constants match NIP-XX1 specification

Future enhancements (optional, not blocking):

- [ ] Consider adding JSDoc examples for complex types like AgentCapability

### Files Modified During Review

None - no modifications required during review.

### Gate Status

Gate: **PASS** → docs/qa/gates/18.1-capability-event-types-schema.yml

Quality Score: 100/100

### Recommended Status

✓ **Ready for Done** - All acceptance criteria met, comprehensive tests passing, no issues identified. Story is complete and ready for integration.
