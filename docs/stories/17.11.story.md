<!-- Powered by BMAD™ Core -->

# Story 17.11: Integration Tests

## Status

Draft

## Story

**As a** connector operator running an AI agent,
**I want** comprehensive integration tests for all DVM features,
**So that** the complete NIP-90 DVM compatibility is validated end-to-end with documented performance benchmarks.

## Acceptance Criteria

1. Test full DVM flow (request → status → result)
2. Test Kind 5000 query migration
3. Test Kind 5900 task delegation between agents
4. Test job chaining with dependencies
5. Test timeout handling
6. Test retry logic
7. Test interop with standard NIP-90 request format
8. Performance benchmarks documented

## Tasks / Subtasks

- [ ] Task 1: Full DVM flow test (AC: 1)
  - [ ] Test Kind 5XXX → Kind 7000 → Kind 6XXX
  - [ ] Verify all tags present
  - [ ] Verify payment handling

- [ ] Task 2: Query migration test (AC: 2)
  - [ ] Test Kind 10000 (old) still works
  - [ ] Test Kind 5000 (new) works
  - [ ] Verify equivalent results

- [ ] Task 3: Task delegation test (AC: 3)
  - [ ] Multi-agent setup
  - [ ] Kind 5900/6900 flow
  - [ ] Agent discovery

- [ ] Task 4: Job chaining test (AC: 4)
  - [ ] Chain multiple jobs
  - [ ] Dependency resolution
  - [ ] Error propagation

- [ ] Task 5: Timeout/retry tests (AC: 5, 6)
  - [ ] Simulate timeout
  - [ ] Test retry backoff
  - [ ] Test max retries

- [ ] Task 6: NIP-90 interop test (AC: 7)
  - [ ] Test against reference implementation
  - [ ] Verify spec compliance

- [ ] Task 7: Performance benchmarks (AC: 8)
  - [ ] Measure query latency
  - [ ] Measure delegation overhead
  - [ ] Document results

## Dev Notes

**Test Infrastructure:**

- Use real event database
- Multi-agent Docker setup
- Mock external NIP-90 clients

**Benchmark Targets:**

- Kind 5000 query: <100ms p95
- Kind 5900 delegation: <500ms p95
- Job chaining (2 hops): <1s p95

**Integration Test Pattern:**

```typescript
describe('DVM Integration', () => {
  beforeAll(async () => {
    // Start multi-agent network
    await startAgents(3);
  });

  it('should complete full DVM flow', async () => {
    // Send Kind 5000
    const request = createDVMRequest();
    const result = await agent.send(request);

    // Verify Kind 7000 status received
    expect(statusEvents).toHaveLength(1);

    // Verify Kind 6000 result received
    expect(result.kind).toBe(6000);
  });
});
```

[Source: docs/prd/epic-17-nip-90-dvm-compatibility.md#story-1711]

---

## Change Log

| Date       | Version | Description   | Author |
| ---------- | ------- | ------------- | ------ |
| 2026-01-28 | 1.0     | Story created | SM     |

---

## Dev Agent Record

[To be filled by Dev Agent]

---

## QA Results

[To be filled by QA Agent]
