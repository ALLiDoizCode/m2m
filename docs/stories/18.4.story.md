# Story 18.4: Capability Query & Filter

## Status

Approved

## Story

**As a** agent developer implementing capability discovery,
**I want** to query and filter peer capability events from local storage and relays,
**so that** agents can discover peers with specific capabilities, pricing, and availability.

## Acceptance Criteria

1. Query Kind 31990 events from local storage
2. Query Kind 31990 events from relays
3. Filter by supported kind (k tag)
4. Filter by agent type
5. Filter by price range
6. Filter by ILP address prefix
7. Sort by pricing, capacity, freshness
8. Return parsed `AgentCapability` objects

## Tasks / Subtasks

- [ ] Create CapabilityQuery interface (AC: 1-7)
  - [ ] Define query filter structure in `packages/connector/src/agent/discovery/types.ts`
  - [ ] Include optional fields: requiredKinds, agentTypes, maxPrice, ilpAddressPrefix, followedOnly, limit
  - [ ] Document each field with JSDoc comments
  - [ ] [Source: Epic 18 PRD - Story 18.4 Technical Notes]

- [ ] Implement CapabilityQueryService class (AC: 1,2,8)
  - [ ] Create `packages/connector/src/agent/discovery/capability-query.ts`
  - [ ] Add constructor accepting AgentEventDatabase and optional relay client
  - [ ] Implement `findAgents(query: CapabilityQuery): Promise<AgentCapability[]>` method
  - [ ] Query local database for Kind 31990 events
  - [ ] Parse events into AgentCapability objects using helper function
  - [ ] [Source: Epic 18 PRD - Story 18.4, Package Structure]

- [ ] Extend NostrFilter with #k tag support (AC: 3) - PREREQUISITE
  - [ ] Add `'#k'?: string[]` field to NostrFilter interface in `packages/connector/src/agent/event-database.ts`
  - [ ] Implement SQL query logic for filtering on k tags (similar to existing #e and #p logic)
  - [ ] Add test cases for #k tag filtering
  - [ ] [Source: Validation findings - NostrFilter currently only supports #e and #p tags]

- [ ] Implement local storage query (AC: 1)
  - [ ] Use AgentEventDatabase.queryEvents() with NostrFilter
  - [ ] Filter for kind: 31990
  - [ ] Support k tag filtering for required kinds using new #k support
  - [ ] Return matching events from local database
  - [ ] [Source: Story 18.2 - AgentEventDatabase integration]

- [ ] Add relay query support (AC: 2)
  - [ ] Query relays for Kind 31990 events if relay client provided
  - [ ] Merge results from local and relay queries
  - [ ] Deduplicate events by event ID
  - [ ] Handle relay connection errors gracefully
  - [ ] [Source: Epic 18 Architecture - Broadcast to network]

- [ ] Implement filtering by event kind (AC: 3)
  - [ ] Filter AgentCapability objects by supportedKinds array
  - [ ] Match query.requiredKinds against capability.supportedKinds
  - [ ] Support multiple required kinds (AND logic)
  - [ ] [Source: Epic 18 PRD - Story 18.4 Technical Notes]

- [ ] Implement filtering by agent type (AC: 4)
  - [ ] Filter by agentType field
  - [ ] Support multiple agent types (OR logic)
  - [ ] Match against AgentType enum values
  - [ ] [Source: Story 18.1 - AgentType definition]

- [ ] Implement filtering by price range (AC: 5)
  - [ ] Filter by maxPrice for each required kind
  - [ ] Compare against pricing.base from capability
  - [ ] Skip capabilities without pricing when maxPrice specified
  - [ ] [Source: Story 18.3 - Pricing implementation]

- [ ] Implement filtering by ILP address prefix (AC: 6)
  - [ ] Filter by ilpAddress prefix matching
  - [ ] Support partial prefix matches (e.g., "g.agent")
  - [ ] Case-sensitive comparison
  - [ ] [Source: Story 18.2 - ILP address in d tag]

- [ ] Implement sorting (AC: 7)
  - [ ] Add rankCapabilities() method
  - [ ] Sort by pricing (lowest first) if pricing available
  - [ ] Secondary sort by capacity (maxConcurrent) if available
  - [ ] Tertiary sort by freshness (created_at timestamp)
  - [ ] [Source: Epic 18 PRD - Story 18.4 AC 7]

- [ ] Implement capability parsing (AC: 8)
  - [ ] Create parseCapability(event: NostrEvent): AgentCapability helper
  - [ ] Parse d tag for identifier
  - [ ] Parse k tags for supportedKinds array
  - [ ] Parse nip tags for supportedNips
  - [ ] Parse agent-type tag
  - [ ] Parse ilp-address tag
  - [ ] Parse pricing tags into pricing Map
  - [ ] Parse capacity tags if present
  - [ ] Parse content JSON for metadata
  - [ ] Use Zod schema validation (AgentCapabilitySchema from Story 18.1)
  - [ ] [Source: Story 18.1 - AgentCapability type, Story 18.2 - Event structure]

- [ ] Write unit tests for CapabilityQueryService (AC: 1-8)
  - [ ] Create `packages/connector/src/agent/discovery/__tests__/capability-query.test.ts`
  - [ ] Test local storage query (mock AgentEventDatabase)
  - [ ] Test relay query (mock relay client)
  - [ ] Test filtering by required kinds
  - [ ] Test filtering by agent type
  - [ ] Test filtering by price range
  - [ ] Test filtering by ILP address prefix
  - [ ] Test sorting by pricing, capacity, freshness
  - [ ] Test capability parsing from events
  - [ ] Test combined filters
  - [ ] Test edge cases (no matches, invalid events, missing fields)
  - [ ] [Source: Test Strategy - Unit Tests]

- [ ] Write integration tests (AC: 1,2,8)
  - [ ] Test end-to-end query with real database
  - [ ] Test parsing of events created by CapabilityPublisher
  - [ ] Verify roundtrip: publish → query → parse
  - [ ] [Source: Test Strategy - Integration Tests]

## Dev Notes

### Previous Story Insights

Story 18.1 defined the AgentCapability type and AgentCapabilitySchema Zod validator. Story 18.2 implemented CapabilityPublisher which creates Kind 31990 events. Story 18.3 added pricing tags. This story implements the query side - finding and parsing those capability events.

Key insights:

- Kind 31990 event structure is defined in Story 18.2
- Tag parsing logic will mirror tag building logic from CapabilityPublisher
- AgentEventDatabase.queryEvents() accepts NostrFilter (kind, #k, authors, etc.)
- AgentCapability type and schema already exist in types.ts from Story 18.1

[Source: Story 18.1, 18.2, 18.3 completion notes]

### Data Models

**CapabilityQuery Interface:**

```typescript
interface CapabilityQuery {
  /** Filter by required event kinds (AND logic - capability must support all) */
  requiredKinds?: number[];
  /** Filter by agent types (OR logic - capability matches any) */
  agentTypes?: AgentType[];
  /** Maximum price per kind in millisatoshis */
  maxPrice?: bigint;
  /** Filter by ILP address prefix (e.g., "g.agent.alice") */
  ilpAddressPrefix?: string;
  /** Only query followed agents (requires FollowGraphRouter) */
  followedOnly?: boolean;
  /** Limit number of results */
  limit?: number;
}
```

**NostrFilter for Querying:**

```typescript
const filter: NostrFilter = {
  kinds: [31990],
  '#k': query.requiredKinds?.map((k) => k.toString()), // Filter by k tags
  // authors: [...followedPubkeys] if followedOnly
};
```

[Source: Epic 18 PRD - Story 18.4 Technical Notes, Nostr NIP-01 Filter spec]

**AgentCapability Type (from Story 18.1):**

```typescript
interface AgentCapability {
  pubkey: string;
  identifier: string; // d tag (ILP address)
  supportedKinds: number[]; // k tags
  supportedNips: string[]; // nip tags
  agentType: AgentType;
  ilpAddress: string;
  pricing: Map<number, PricingEntry>;
  capacity?: CapacityInfo;
  model?: string;
  skills?: string[];
  metadata: AgentMetadata;
  createdAt: number;
}
```

[Source: Story 18.1 - types.ts AgentCapability interface]

### File Locations

Based on Epic 18 Package Structure:

```
packages/connector/src/agent/discovery/
├── types.ts                         # UPDATE: Add CapabilityQuery interface
├── capability-query.ts              # NEW: CapabilityQueryService class
├── __tests__/
│   └── capability-query.test.ts     # NEW: Unit tests
```

[Source: Epic 18 PRD - Package Structure, Story 18.2 File List]

### Technical Constraints

**NostrFilter Structure:**

- Use AgentEventDatabase.queryEvents(filter: NostrFilter)
- kind: 31990 for capability events
- #k: array of event kinds to filter by k tags
- Can filter by authors if followedOnly is true

[Source: Agent Event Database API, Nostr NIP-01]

**Tag Parsing:**

Tags are arrays of strings. Parse them carefully:

- d tag: `['d', identifier]` → capability.identifier
- k tags: `['k', kind]` → capability.supportedKinds (collect all)
- nip tags: `['nip', nip]` → capability.supportedNips (collect all)
- agent-type tag: `['agent-type', type]` → capability.agentType
- ilp-address tag: `['ilp-address', address]` → capability.ilpAddress
- pricing tags: `['pricing', kind, amount, currency]` → pricing Map
- capacity tag: `['capacity', maxConcurrent, queueDepth]` → capacity object

[Source: Story 18.2 - CapabilityPublisher tag building]

**BigInt Handling:**

- Pricing amounts in tags are strings, convert to bigint
- maxPrice query param is bigint for type safety
- Compare bigints directly for price filtering

[Source: Story 18.3 - BigInt usage in pricing]

**Sorting Priority:**

1. Pricing (lowest first) - prefer cheaper agents
2. Capacity (highest maxConcurrent first) - prefer higher capacity
3. Freshness (newest first) - prefer recent capability updates

[Source: Epic 18 PRD - Story 18.4 AC 7]

**Error Handling:**

- Invalid event structure should be logged and skipped (not thrown)
- Zod validation errors should skip the event
- Relay connection errors should not fail the entire query
- Missing optional fields should not fail parsing

[Source: Coding Standards - Error Handling]

**Relay Integration:**

- Relay querying is optional (relay client may not be provided)
- If relay client exists, query relays and merge with local results
- Deduplicate by event ID (local + relay may have duplicates)
- Relay errors should be logged but not block local results

[Source: Epic 18 Architecture - Broadcast to network]

### Testing

**Test File Locations:**

- `packages/connector/src/agent/discovery/__tests__/capability-query.test.ts` (unit tests)
- Integration tests can be added to existing agent integration test files

[Source: Test Strategy - Unit Tests - File Convention]

**Test Standards:**

- Framework: Jest 29.7.x with TypeScript support (ts-jest)
- Coverage Requirement: >80% line coverage for connector package
- Follow AAA pattern (Arrange, Act, Assert)
- Use descriptive test names
- Mock dependencies: AgentEventDatabase, relay client

[Source: Test Strategy - Unit Tests - AI Agent Requirements]

**Specific Test Cases Required:**

CapabilityQueryService tests:

- Query from local storage returns matching capabilities
- Query with k tag filter returns only matching kinds
- Query with agent type filter returns only matching types
- Query with maxPrice filter excludes expensive capabilities
- Query with ILP address prefix filter matches correctly
- Sorting by pricing works correctly
- Sorting by capacity works correctly
- Sorting by freshness works correctly
- parseCapability handles valid events correctly
- parseCapability skips invalid events gracefully
- Combined filters work correctly (e.g., kind + type + price)
- Empty results when no matches
- Limit parameter restricts results
- followedOnly filter works (integration with FollowGraphRouter)

[Source: Test Strategy - Unit Tests - Example Unit Test Structure]

**Mock Strategy:**

- Mock AgentEventDatabase.queryEvents() to return test events
- Mock relay client (if implementing relay queries in this story)
- Use capability events created by CapabilityPublisher (from Story 18.2 tests) as test data
- Test with various combinations of tags present/missing

[Source: Test Strategy - Unit Tests - Mocking Library]

## Validation Report

### Validation Date: 2026-01-28

### Validated By: Sarah (Product Owner)

### Template Compliance Issues

**PASS** - All template sections present and complete:

- ✅ Status section
- ✅ Story (proper user story format)
- ✅ Acceptance Criteria (8 ACs from Epic 18 PRD)
- ✅ Tasks/Subtasks (13 task groups with subtasks)
- ✅ Dev Notes (comprehensive technical context)
- ✅ Change Log
- ✅ Dev Agent Record (placeholder for implementation)
- ✅ No unfilled placeholders

### Critical Issues (Must Fix - Story Blocked)

**NONE** - Critical issue identified and resolved:

❌ **Originally Found**: NostrFilter missing #k tag support
✅ **Resolution**: Added prerequisite task to extend NostrFilter interface with #k tag filtering

### Should-Fix Issues (Important Quality Improvements)

**NONE** - All quality requirements met.

### Nice-to-Have Improvements (Optional Enhancements)

**NONE** - Story is comprehensive.

### Anti-Hallucination Verification

**PASS** - All technical claims verified against source documents:

✅ **AgentEventDatabase.queryEvents()** (Source: packages/connector/src/agent/event-database.ts:255-333)

- Method exists with correct signature: `queryEvents(filter: NostrFilter): Promise<NostrEvent[]>`
- Dynamically builds SQL WHERE clauses from filter criteria
- Supports kinds, authors, ids, since, until, #e, #p filtering

✅ **NostrFilter Interface** (Source: packages/connector/src/agent/event-database.ts:15-24)

- Interface defined with kinds, authors, ids, since, until, limit, #e, #p
- **GAP FOUND**: Missing #k tag support - added as prerequisite task
- Tag filtering infrastructure exists (#e, #p implemented)

✅ **AgentCapability Type** (Source: packages/connector/src/agent/discovery/types.ts:71-96)

- Complete interface with all required fields
- Includes: pubkey, identifier, supportedKinds, supportedNips, agentType, ilpAddress, pricing, capacity, model, skills, metadata, createdAt
- Zod schema validation exists (AgentCapabilitySchema)

✅ **PricingEntry Type** (Source: packages/connector/src/agent/discovery/types.ts:13-20)

- All fields present: kind (number), amount (bigint), currency ('msat' | 'sat' | 'usd')
- Matches Story 18.3 pricing implementation

✅ **TAG_NAMES Constants** (Source: packages/connector/src/agent/discovery/types.ts:102-121)

- All required constants exported: IDENTIFIER, KIND, NIP, AGENT_TYPE, ILP_ADDRESS, PRICING, CAPACITY, MODEL, SKILLS
- TAG_NAMES.KIND ('k') available for parsing
- TAG_NAMES.IDENTIFIER ('d') available for parsing

✅ **Kind 31990 Event Creation** (Source: packages/connector/src/agent/discovery/capability-publisher.ts:123-128)

- CapabilityPublisher creates Kind 31990 events
- Events signed with agent's private key
- Test confirms kind is 31990 (capability-publisher.test.ts:113)

### File Structure Validation

**PASS** - All file paths are accurate and follow project structure:

✅ `packages/connector/src/agent/event-database.ts` - Exists, needs #k extension
✅ `packages/connector/src/agent/discovery/types.ts` - Exists, has all required types
✅ `packages/connector/src/agent/discovery/capability-publisher.ts` - Exists from Story 18.2
✅ `packages/connector/src/agent/discovery/capability-query.ts` - NEW file to create
✅ `packages/connector/src/agent/discovery/__tests__/capability-query.test.ts` - NEW test file to create

### Acceptance Criteria Coverage

**PASS** - All 8 acceptance criteria fully covered by tasks:

| AC                                          | Coverage    | Tasks                                                    |
| ------------------------------------------- | ----------- | -------------------------------------------------------- |
| AC 1: Query from local storage              | ✅ Complete | Task 3: Implement local storage query                    |
| AC 2: Query from relays                     | ✅ Complete | Task 4: Add relay query support                          |
| AC 3: Filter by event kind                  | ✅ Complete | Task 1: Extend NostrFilter + Task 5: Implement filtering |
| AC 4: Filter by agent type                  | ✅ Complete | Task 6: Implement filtering by agent type                |
| AC 5: Filter by price range                 | ✅ Complete | Task 7: Implement filtering by price range               |
| AC 6: Filter by ILP address prefix          | ✅ Complete | Task 8: Implement filtering by ILP address prefix        |
| AC 7: Sort results                          | ✅ Complete | Task 9: Implement sorting                                |
| AC 8: Return parsed AgentCapability objects | ✅ Complete | Task 2, 10: CapabilityQueryService + parsing             |

### Testing Coverage

**PASS** - Comprehensive test plan:

✅ Task 11: Unit tests for CapabilityQueryService (11 scenarios)
✅ Task 12: Integration tests for end-to-end query
✅ Test file locations correct (co-located pattern)
✅ Mock strategy defined
✅ Coverage requirement >80% specified

### Security Considerations

**PASS** - Appropriate for story scope:

✅ No new security vectors introduced
✅ BigInt handling prevents numeric overflow
✅ Query filtering is read-only operation
✅ No sensitive data exposed

### Task Sequence Validation

**PASS** - Logical implementation order:

1. ✅ Extend NostrFilter (prerequisite for querying)
2. ✅ Create interfaces and service class
3. ✅ Implement local query
4. ✅ Implement relay query
5. ✅ Implement filtering
6. ✅ Implement sorting
7. ✅ Implement parsing
8. ✅ Write tests

No blocking dependencies identified beyond the NostrFilter extension.

### Dev Agent Implementation Readiness

**PASS** - Story is fully self-contained:

✅ **Complete technical context:** All file locations, interfaces, and methods documented
✅ **Clear instructions:** 13 task groups with specific subtasks
✅ **Source references:** Every technical decision traced to source
✅ **No external doc reads needed:** Dev Notes contain all architecture info
✅ **Actionable tasks:** All tasks implementable without clarification
✅ **Test guidance:** Specific test cases and mock strategy provided
✅ **Previous story insights:** Stories 18.1, 18.2, 18.3 context included
✅ **GAP ADDRESSED:** NostrFilter extension task added as prerequisite

### Final Assessment

**GO** ✅ - Story is ready for implementation.

**Implementation Readiness Score:** 10/10

**Confidence Level:** High

**Rationale:**

- All template sections complete and accurate
- All technical claims verified against actual codebase
- No hallucinated APIs, methods, or structures
- Clear task sequence with logical dependencies
- Comprehensive test coverage defined
- NostrFilter gap identified and addressed with prerequisite task
- Filtering and sorting logic well-specified
- Parsing strategy mirrors CapabilityPublisher from Story 18.2
- Integration points with Stories 18.1, 18.2, 18.3 validated

**Next Steps:**

1. Mark story Status: Approved
2. Assign to Dev Agent for implementation
3. Expected completion: All ACs met with >80% test coverage
4. First task: Extend NostrFilter with #k tag support

## Change Log

| Date       | Version | Description                                                                           | Author  |
| ---------- | ------- | ------------------------------------------------------------------------------------- | ------- |
| 2026-01-28 | 0.1     | Initial story draft created                                                           | SM (AI) |
| 2026-01-28 | 1.0     | Story validated and approved - added prerequisite task for NostrFilter #k tag support | PO (AI) |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List
