<!-- Powered by BMAD™ Core -->

# Story 11.6: Payment Channel Integration for Agent Wallets

## Status

Approved

## Story

**As an** AI agent,
**I want** to open and manage payment channels using my wallet,
**So that** I can execute micropayments with low fees and high speed.

## Acceptance Criteria

1. `AgentChannelManager` class implemented in `packages/connector/src/wallet/agent-channel-manager.ts`
2. Channel manager integrates with Epic 8's `PaymentChannelSDK` for EVM channels
3. Channel manager integrates with Epic 9's `XRPChannelSDK` for XRP channels
4. Channel manager opens channels on behalf of agents (using derived wallets)
5. Channel manager tracks all active channels per agent
6. Channel manager handles channel deposits, balance proof signing, and closures
7. Channel manager implements channel rebalancing: close depleted channels, open new ones
8. Channel manager exposes agent API: `openChannel()`, `sendPayment()`, `closeChannel()`
9. Unit tests verify channel operations with agent wallets
10. Integration test demonstrates agent opening channel, sending payments, closing channel

## Tasks / Subtasks

**Task Execution Strategy:** Story 11.6 integrates agent wallets (Stories 11.2-11.5) with payment channels (Epic 8 EVM, Epic 9 XRP) to enable AI agents to execute micropayments. The AgentChannelManager orchestrates wallet lifecycle verification (Story 11.5), wallet signing (Story 11.2), and channel operations (Epic 8/9). Task 1 implements core channel manager infrastructure with database schema. Task 2 implements EVM channel integration (Epic 8). Task 3 implements XRP channel integration (Epic 9). Task 4 implements channel tracking and state management. Task 5 implements channel rebalancing logic. Task 6 implements telemetry integration. Task 7 implements comprehensive unit tests. Task 8 creates integration test with real blockchain channels.

- [ ] Task 1: Implement Channel Manager Infrastructure and Database Schema (AC: 1, 5)
  - [ ] Define `AgentChannel` interface
    - [ ] File: `packages/connector/src/wallet/agent-channel-manager.ts`
    - [ ] Properties: `agentId: string`, `channelId: string`, `chain: 'evm' | 'xrp'`, `peerId: string`, `token: string`, `openedAt: number`, `lastActivityAt?: number`, `closedAt?: number`
    - [ ] [Source: Epic 11 Story 11.6 Technical Specification lines 1109-1122]
  - [ ] Define `ChannelManagerConfig` interface
    - [ ] Properties: `minChannelBalance: bigint`, `maxChannelBalance: bigint`, `rebalanceEnabled: boolean`
    - [ ] Default: `{ minChannelBalance: 1000000000000000000n, maxChannelBalance: 10000000000000000000n, rebalanceEnabled: true }`
    - [ ] [Source: Epic 11 Story 11.6 AC 7 - channel rebalancing]
  - [ ] Define `ChannelOpenParams` interface
    - [ ] Properties: `agentId: string`, `peerId: string`, `chain: 'evm' | 'xrp'`, `token: string`, `amount: bigint`
    - [ ] [Source: Epic 11 Story 11.6 Technical Specification lines 985-991]
  - [ ] Define `ChannelPaymentParams` interface
    - [ ] Properties: `agentId: string`, `channelId: string`, `amount: bigint`
    - [ ] [Source: Epic 11 Story 11.6 Technical Specification lines 1039-1040]
  - [ ] Implement `AgentChannelManager` class constructor
    - [ ] Constructor parameters: `walletDerivation: AgentWalletDerivation`, `evmChannelSDK: PaymentChannelSDK`, `xrpChannelSDK: XRPChannelSDK`, `lifecycleManager: AgentWalletLifecycle`, `telemetryEmitter: TelemetryEmitter`, `config: ChannelManagerConfig`, `dbPath?: string`
    - [ ] Initialize in-memory channel tracking: `agentChannels: Map<string, AgentChannel[]>`
    - [ ] Import `PaymentChannelSDK` from Epic 8: `packages/connector/src/settlement/payment-channel-sdk.ts`
    - [ ] Import `XRPChannelSDK` from Epic 9: `packages/connector/src/settlement/xrp-channel-sdk.ts`
    - [ ] Import `AgentWalletDerivation` from Story 11.2
    - [ ] Import `AgentWalletLifecycle` from Story 11.5
    - [ ] Configure Pino logger for channel manager module
    - [ ] Initialize SQLite database for channel tracking (extend wallet DB)
    - [ ] [Source: Epic 11 Story 11.6 Technical Specification lines 976-982]
  - [ ] Extend database schema
    - [ ] File: `packages/connector/src/wallet/wallet-db-schema.ts` (extend existing schema)
    - [ ] Add `AGENT_CHANNELS_TABLE_SCHEMA`: `CREATE TABLE IF NOT EXISTS agent_channels (agent_id TEXT NOT NULL, channel_id TEXT PRIMARY KEY, chain TEXT NOT NULL, peer_id TEXT NOT NULL, token TEXT NOT NULL, opened_at INTEGER NOT NULL, last_activity_at INTEGER, closed_at INTEGER)`
    - [ ] Create indexes on `agent_id`, `chain`, `peer_id`, `closed_at`
    - [ ] [Source: Epic 11 Story 11.6 AC 5 - track all active channels per agent]
  - [ ] Implement `loadChannelsIntoCache()` private method
    - [ ] Called in constructor to restore channel state from database on restart
    - [ ] Query all non-closed channels: `SELECT * FROM agent_channels WHERE closed_at IS NULL`
    - [ ] Load into `agentChannels` map grouped by agent ID
    - [ ] [Source: Story 11.5 pattern for cache restoration]

- [ ] Task 2: Implement EVM Channel Operations (AC: 2, 4, 6, 8)
  - [ ] Implement `openChannel()` method for EVM (AC: 2, 4, 8)
    - [ ] Method signature: `async openChannel(params: ChannelOpenParams): Promise<string>`
    - [ ] Verify agent wallet is active: `const lifecycle = await this.lifecycleManager.getLifecycleRecord(params.agentId)`
    - [ ] If `lifecycle.state !== 'active'`, throw error: `throw new Error('Agent wallet not active: ${lifecycle.state}')`
    - [ ] Get agent signer for EVM: `const signer = await this.walletDerivation.getAgentSigner(params.agentId, 'evm')`
    - [ ] Get peer wallet address: `const peerWallet = await this.getPeerWallet(params.peerId)`
    - [ ] If `params.chain === 'evm'`, call PaymentChannelSDK:
      - [ ] `const channelId = await this.evmChannelSDK.openChannel(peerWallet.evmAddress, params.token, 3600, params.amount)`
      - [ ] Settlement timeout: 3600 seconds (1 hour) per Epic 8 standards
    - [ ] Track channel in database and cache: `await this.trackAgentChannel(params.agentId, channelId, params.chain, params.peerId, params.token)`
    - [ ] Record wallet activity: `await this.lifecycleManager.recordTransaction(params.agentId, params.token, params.amount)`
    - [ ] Emit telemetry event: `AGENT_CHANNEL_OPENED`
    - [ ] Return channel ID
    - [ ] Log: `logger.info('Agent channel opened', { agentId: params.agentId, channelId, chain: params.chain, peerId: params.peerId })`
    - [ ] [Source: Epic 11 Story 11.6 Technical Specification lines 984-1036, Epic 8 PaymentChannelSDK.openChannel() lines 428-433]
  - [ ] Implement `sendPayment()` method for EVM (AC: 6, 8)
    - [ ] Method signature: `async sendPayment(params: ChannelPaymentParams): Promise<void>`
    - [ ] Get agent channel: `const channel = await this.getAgentChannel(params.agentId, params.channelId)`
    - [ ] If not found, throw error: `throw new Error('Channel not found')`
    - [ ] Get agent signer: `const signer = await this.walletDerivation.getAgentSigner(params.agentId, channel.chain)`
    - [ ] If `channel.chain === 'evm'`:
      - [ ] Get current channel state: `const currentState = await this.evmChannelSDK.getChannelState(params.channelId)`
      - [ ] Calculate new nonce: `const newNonce = currentState.myNonce + 1`
      - [ ] Calculate new transferred amount: `const newTransferred = currentState.myTransferred + params.amount`
      - [ ] Sign balance proof: `const signature = await this.evmChannelSDK.signBalanceProof(params.channelId, newNonce, newTransferred)`
      - [ ] Send balance proof to peer off-chain: `await this.sendBalanceProofToPeer(channel.peerId, { channelId: params.channelId, nonce: newNonce, transferredAmount: newTransferred, signature })`
    - [ ] Record wallet activity: `await this.lifecycleManager.recordTransaction(params.agentId, channel.token, params.amount)`
    - [ ] Update channel last activity: `channel.lastActivityAt = Date.now()`, `await this.updateChannelActivity(params.channelId)`
    - [ ] Emit telemetry event: `AGENT_CHANNEL_PAYMENT_SENT`
    - [ ] Log: `logger.info('Agent channel payment sent', { agentId: params.agentId, channelId: params.channelId, amount: params.amount.toString() })`
    - [ ] [Source: Epic 11 Story 11.6 Technical Specification lines 1038-1077, Epic 8 PaymentChannelSDK.signBalanceProof() lines 438]
  - [ ] Implement `closeChannel()` method for EVM (AC: 6, 8)
    - [ ] Method signature: `async closeChannel(agentId: string, channelId: string): Promise<void>`
    - [ ] Get agent channel: `const channel = await this.getAgentChannel(agentId, channelId)`
    - [ ] If not found, throw error: `throw new Error('Channel not found')`
    - [ ] Get agent signer: `const signer = await this.walletDerivation.getAgentSigner(agentId, channel.chain)`
    - [ ] If `channel.chain === 'evm'`:
      - [ ] Call PaymentChannelSDK: `await this.evmChannelSDK.closeChannel(channelId)`
    - [ ] Mark channel as closed in database: `channel.closedAt = Date.now()`, `await this.updateChannelClosed(channelId)`
    - [ ] Remove from active tracking (in-memory map)
    - [ ] Emit telemetry event: `AGENT_CHANNEL_CLOSED`
    - [ ] Log: `logger.info('Agent channel closed', { agentId, channelId, chain: channel.chain })`
    - [ ] [Source: Epic 11 Story 11.6 Technical Specification lines 1079-1102, Epic 8 PaymentChannelSDK.closeChannel() lines 449-453]
  - [ ] Implement `sendBalanceProofToPeer()` private helper
    - [ ] Method signature: `private async sendBalanceProofToPeer(peerId: string, balanceProof: BalanceProof): Promise<void>`
    - [ ] This is a placeholder for off-chain communication (future: use BTP protocol or HTTP API)
    - [ ] For MVP: log balance proof and assume peer receives it (integration test will mock peer reception)
    - [ ] Log: `logger.info('Sending balance proof to peer', { peerId, balanceProof })`
    - [ ] **Future Enhancement:** Integrate with Epic 7 (BTP Protocol) for off-chain message passing
    - [ ] [Source: Epic 11 Story 11.6 Technical Specification lines 1058-1063]

- [ ] Task 3: Implement XRP Channel Operations (AC: 3, 4, 6, 8)
  - [ ] Extend `openChannel()` method for XRP (AC: 3, 4, 8)
    - [ ] In `openChannel()` method, add XRP branch: `if (params.chain === 'xrp')`
    - [ ] Get peer wallet address: `const peerWallet = await this.getPeerWallet(params.peerId)`
    - [ ] Call XRPChannelSDK: `const channelId = await this.xrpChannelSDK.openChannel(peerWallet.xrpAddress, params.amount.toString(), 3600)`
    - [ ] Settlement delay: 3600 seconds (1 hour) per Epic 9 standards
    - [ ] Track channel (same as EVM path)
    - [ ] Record wallet activity (same as EVM path)
    - [ ] Emit telemetry event (same as EVM path)
    - [ ] [Source: Epic 11 Story 11.6 Technical Specification lines 1012-1020, Epic 9 XRPChannelSDK.openChannel() lines 448-465]
  - [ ] Extend `sendPayment()` method for XRP (AC: 6, 8)
    - [ ] In `sendPayment()` method, add XRP branch: `else if (channel.chain === 'xrp')`
    - [ ] Get current channel state: `const currentState = await this.xrpChannelSDK.getChannelState(params.channelId)`
    - [ ] Calculate new amount: `const newAmount = BigInt(currentState.balance) + params.amount`
    - [ ] Sign claim: `const claim = this.xrpChannelSDK.signClaim(params.channelId, newAmount.toString())`
    - [ ] Send claim to peer off-chain: `await this.sendClaimToPeer(channel.peerId, claim)`
    - [ ] Record wallet activity (same as EVM path)
    - [ ] Update channel last activity (same as EVM path)
    - [ ] Emit telemetry event (same as EVM path)
    - [ ] [Source: Epic 11 Story 11.6 Technical Specification lines 1064-1077, Epic 9 XRPChannelSDK.signClaim() lines 479-486]
  - [ ] Extend `closeChannel()` method for XRP (AC: 6, 8)
    - [ ] In `closeChannel()` method, add XRP branch: `else if (channel.chain === 'xrp')`
    - [ ] Call XRPChannelSDK: `await this.xrpChannelSDK.closeChannel(channelId)`
    - [ ] Mark channel as closed (same as EVM path)
    - [ ] Emit telemetry event (same as EVM path)
    - [ ] [Source: Epic 11 Story 11.6 Technical Specification lines 1086-1090, Epic 9 XRPChannelSDK.closeChannel() lines 512-521]
  - [ ] Implement `sendClaimToPeer()` private helper
    - [ ] Method signature: `private async sendClaimToPeer(peerId: string, claim: XRPClaim): Promise<void>`
    - [ ] This is a placeholder for off-chain communication (same as EVM balance proof)
    - [ ] For MVP: log claim and assume peer receives it
    - [ ] Log: `logger.info('Sending XRP claim to peer', { peerId, claim })`
    - [ ] **Future Enhancement:** Integrate with Epic 7 (BTP Protocol) for off-chain message passing
    - [ ] [Source: Epic 11 Story 11.6 Technical Specification lines 1070-1073]

- [ ] Task 4: Implement Channel Tracking and State Management (AC: 5)
  - [ ] Implement `trackAgentChannel()` private method (AC: 5)
    - [ ] Method signature: `private async trackAgentChannel(agentId: string, channelId: string, chain: 'evm' | 'xrp', peerId: string, token: string): Promise<void>`
    - [ ] Create channel record: `const channel: AgentChannel = { agentId, channelId, chain, peerId, token, openedAt: Date.now() }`
    - [ ] Insert into database: `INSERT INTO agent_channels (agent_id, channel_id, chain, peer_id, token, opened_at) VALUES (?, ?, ?, ?, ?, ?)`
    - [ ] Add to in-memory cache: `this.agentChannels.get(agentId)?.push(channel)` or initialize array if not exists
    - [ ] [Source: Epic 11 Story 11.6 Technical Specification lines 1109-1122]
  - [ ] Implement `getAgentChannel()` private method (AC: 5)
    - [ ] Method signature: `private async getAgentChannel(agentId: string, channelId: string): Promise<AgentChannel | null>`
    - [ ] Check in-memory cache first: `const channels = this.agentChannels.get(agentId)`
    - [ ] If found in cache, return: `return channels?.find(c => c.channelId === channelId) ?? null`
    - [ ] If not in cache, query database: `SELECT * FROM agent_channels WHERE agent_id = ? AND channel_id = ?`
    - [ ] Return channel or null if not found
    - [ ] [Source: Epic 11 Story 11.6 Technical Specification lines 1128-1130]
  - [ ] Implement `getAgentChannels()` public method (AC: 5, 8)
    - [ ] Method signature: `async getAgentChannels(agentId: string): Promise<AgentChannel[]>`
    - [ ] Check in-memory cache first: `const channels = this.agentChannels.get(agentId)`
    - [ ] If found in cache, return: `return channels ?? []`
    - [ ] If not in cache, query database: `SELECT * FROM agent_channels WHERE agent_id = ? AND closed_at IS NULL`
    - [ ] Return all non-closed channels for agent
    - [ ] [Source: Epic 11 Story 11.6 Technical Specification lines 1104-1107]
  - [ ] Implement `updateChannelActivity()` private method
    - [ ] Method signature: `private async updateChannelActivity(channelId: string): Promise<void>`
    - [ ] Update database: `UPDATE agent_channels SET last_activity_at = ? WHERE channel_id = ?`
    - [ ] Update in-memory cache: find channel and set `lastActivityAt = Date.now()`
    - [ ] [Source: Needed for channel rebalancing logic in Task 5]
  - [ ] Implement `updateChannelClosed()` private method
    - [ ] Method signature: `private async updateChannelClosed(channelId: string): Promise<void>`
    - [ ] Update database: `UPDATE agent_channels SET closed_at = ? WHERE channel_id = ?`
    - [ ] Remove from in-memory cache: filter out closed channel from `agentChannels` map
    - [ ] [Source: Needed for closeChannel() implementation]
  - [ ] Implement `getPeerWallet()` private helper
    - [ ] Method signature: `private async getPeerWallet(peerId: string): Promise<AgentWallet>`
    - [ ] Use wallet derivation to get peer wallet: `return await this.walletDerivation.getAgentWallet(peerId)`
    - [ ] Assumption: peers are also agents with wallets (peer-to-peer agent economy)
    - [ ] **Future Enhancement:** Support non-agent peers (external wallets) via configuration
    - [ ] [Source: Epic 11 Story 11.6 Technical Specification lines 1005, 1014]

- [ ] Task 5: Implement Channel Rebalancing Logic (AC: 7)
  - [ ] Implement `checkChannelRebalancing()` public method (AC: 7)
    - [ ] Method signature: `async checkChannelRebalancing(agentId: string): Promise<void>`
    - [ ] If `!config.rebalanceEnabled`, return early
    - [ ] Get all active channels for agent: `const channels = await this.getAgentChannels(agentId)`
    - [ ] For each channel:
      - [ ] Get current channel balance: `const state = await this.getChannelBalance(channel.channelId, channel.chain)`
      - [ ] If balance < `config.minChannelBalance`:
        - [ ] Close depleted channel: `await this.closeChannel(agentId, channel.channelId)`
        - [ ] Open new channel with `config.maxChannelBalance`: `await this.openChannel({ agentId, peerId: channel.peerId, chain: channel.chain, token: channel.token, amount: config.maxChannelBalance })`
        - [ ] Log: `logger.info('Channel rebalanced', { agentId, oldChannelId: channel.channelId, newChannelId })`
    - [ ] [Source: Epic 11 Story 11.6 AC 7]
  - [ ] Implement `getChannelBalance()` private helper
    - [ ] Method signature: `private async getChannelBalance(channelId: string, chain: 'evm' | 'xrp'): Promise<bigint>`
    - [ ] If `chain === 'evm'`:
      - [ ] Get channel state: `const state = await this.evmChannelSDK.getChannelState(channelId)`
      - [ ] Return remaining balance: `return state.myDeposit - state.myTransferred`
    - [ ] If `chain === 'xrp'`:
      - [ ] Get channel state: `const state = await this.xrpChannelSDK.getChannelState(channelId)`
      - [ ] Return remaining balance: `return BigInt(state.amount) - BigInt(state.balance)`
    - [ ] [Source: Epic 8 ChannelState.myDeposit/myTransferred, Epic 9 XRPChannelState.amount/balance]
  - [ ] Add automatic rebalancing trigger in `sendPayment()`
    - [ ] After sending payment, check if balance fell below threshold
    - [ ] If so, trigger rebalancing asynchronously (don't block payment)
    - [ ] Use `setImmediate()` or `Promise.resolve().then()` to avoid blocking caller
    - [ ] [Source: Proactive rebalancing on payment activity]

- [ ] Task 6: Implement Telemetry Integration (AC: 8)
  - [ ] Define `AGENT_CHANNEL_OPENED` telemetry event type
    - [ ] File: `packages/shared/src/types/telemetry.ts` (extend existing telemetry types)
    - [ ] Event type: `'AGENT_CHANNEL_OPENED'`
    - [ ] Add to `TelemetryEventType` enum
    - [ ] [Source: Epic 11 Story 11.6 Technical Specification line 1026, Epic 9 XRPChannelOpenedEvent lines 570-580]
  - [ ] Define `AgentChannelOpenedEvent` interface
    - [ ] Properties: `type: 'AGENT_CHANNEL_OPENED'`, `timestamp: number`, `nodeId: string`, `agentId: string`, `channelId: string`, `chain: 'evm' | 'xrp'`, `peerId: string`, `amount: string`
    - [ ] Add to shared telemetry types union
    - [ ] [Source: Epic 11 Story 11.6 Technical Specification lines 1026-1033, Epic 9 XRPChannelOpenedEvent]
  - [ ] Define `AGENT_CHANNEL_PAYMENT_SENT` telemetry event type
    - [ ] Event type: `'AGENT_CHANNEL_PAYMENT_SENT'`
    - [ ] Add to `TelemetryEventType` enum
    - [ ] [Source: Epic 11 Story 11.6 payment tracking]
  - [ ] Define `AgentChannelPaymentSentEvent` interface
    - [ ] Properties: `type: 'AGENT_CHANNEL_PAYMENT_SENT'`, `timestamp: number`, `nodeId: string`, `agentId: string`, `channelId: string`, `amount: string`
    - [ ] Add to shared telemetry types union
    - [ ] [Source: Epic 11 Story 11.6 payment tracking]
  - [ ] Define `AGENT_CHANNEL_CLOSED` telemetry event type
    - [ ] Event type: `'AGENT_CHANNEL_CLOSED'`
    - [ ] Add to `TelemetryEventType` enum
    - [ ] [Source: Epic 11 Story 11.6 Technical Specification line 1096, Epic 9 XRPChannelClosedEvent]
  - [ ] Define `AgentChannelClosedEvent` interface
    - [ ] Properties: `type: 'AGENT_CHANNEL_CLOSED'`, `timestamp: number`, `nodeId: string`, `agentId: string`, `channelId: string`, `chain: 'evm' | 'xrp'`
    - [ ] Add to shared telemetry types union
    - [ ] [Source: Epic 11 Story 11.6 Technical Specification lines 1095-1101]
  - [ ] Implement telemetry emission in all channel operations
    - [ ] Channel opened: emit event in `openChannel()`
    - [ ] Payment sent: emit event in `sendPayment()`
    - [ ] Channel closed: emit event in `closeChannel()`
    - [ ] Wrap in try-catch to prevent telemetry failures from breaking channel operations
  - [ ] Export new telemetry types from shared package
    - [ ] File: `packages/shared/src/index.ts`
    - [ ] Export `AgentChannelOpenedEvent`, `AgentChannelPaymentSentEvent`, `AgentChannelClosedEvent`
    - [ ] [Source: docs/architecture/source-tree.md line 80]

- [ ] Task 7: Implement Unit Tests (AC: 9)
  - [ ] Create test file: `packages/connector/src/wallet/agent-channel-manager.test.ts`
    - [ ] Co-locate with source file per testing standards
    - [ ] [Source: docs/architecture/test-strategy-and-standards.md line 20]
  - [ ] Mock dependencies
    - [ ] Mock `AgentWalletDerivation` to return test wallets and signers
    - [ ] Mock `PaymentChannelSDK` to simulate EVM channel operations
    - [ ] Mock `XRPChannelSDK` to simulate XRP channel operations
    - [ ] Mock `AgentWalletLifecycle` to return active wallet state
    - [ ] Mock `TelemetryEmitter` to verify event emissions
    - [ ] Mock database with in-memory SQLite (`:memory:`)
    - [ ] [Source: docs/architecture/test-strategy-and-standards.md lines 28-29]
  - [ ] Test: Open EVM channel for agent (AC: 2, 4)
    - [ ] Call `openChannel({ agentId: 'agent-001', peerId: 'agent-002', chain: 'evm', token: 'USDC', amount: 1000000n })`
    - [ ] Verify wallet lifecycle checked (active state)
    - [ ] Verify PaymentChannelSDK.openChannel() called with correct parameters
    - [ ] Verify channel tracked in database
    - [ ] Verify telemetry event `AGENT_CHANNEL_OPENED` emitted
    - [ ] Verify wallet activity recorded
  - [ ] Test: Open XRP channel for agent (AC: 3, 4)
    - [ ] Call `openChannel({ agentId: 'agent-001', peerId: 'agent-002', chain: 'xrp', token: 'XRP', amount: 25000000n })`
    - [ ] Verify XRPChannelSDK.openChannel() called with correct parameters
    - [ ] Verify channel tracked in database
    - [ ] Verify telemetry event emitted
  - [ ] Test: Send payment through EVM channel (AC: 6)
    - [ ] Open EVM channel first
    - [ ] Call `sendPayment({ agentId: 'agent-001', channelId, amount: 100000n })`
    - [ ] Verify PaymentChannelSDK.signBalanceProof() called
    - [ ] Verify balance proof sent to peer (mock sendBalanceProofToPeer)
    - [ ] Verify wallet activity recorded
    - [ ] Verify channel last activity updated
    - [ ] Verify telemetry event `AGENT_CHANNEL_PAYMENT_SENT` emitted
  - [ ] Test: Send payment through XRP channel (AC: 6)
    - [ ] Open XRP channel first
    - [ ] Call `sendPayment({ agentId: 'agent-001', channelId, amount: 5000000n })`
    - [ ] Verify XRPChannelSDK.signClaim() called
    - [ ] Verify claim sent to peer (mock sendClaimToPeer)
    - [ ] Verify wallet activity recorded
  - [ ] Test: Close EVM channel (AC: 6)
    - [ ] Open EVM channel first
    - [ ] Call `closeChannel('agent-001', channelId)`
    - [ ] Verify PaymentChannelSDK.closeChannel() called
    - [ ] Verify channel marked as closed in database
    - [ ] Verify channel removed from active tracking
    - [ ] Verify telemetry event `AGENT_CHANNEL_CLOSED` emitted
  - [ ] Test: Close XRP channel (AC: 6)
    - [ ] Open XRP channel first
    - [ ] Call `closeChannel('agent-001', channelId)`
    - [ ] Verify XRPChannelSDK.closeChannel() called
    - [ ] Verify channel marked as closed
  - [ ] Test: Reject channel open if wallet not active (AC: 4)
    - [ ] Mock lifecycle manager to return SUSPENDED state
    - [ ] Attempt to open channel
    - [ ] Expect error: "Agent wallet not active: suspended"
  - [ ] Test: Track multiple channels per agent (AC: 5)
    - [ ] Open 3 channels for same agent (2 EVM, 1 XRP)
    - [ ] Call `getAgentChannels('agent-001')`
    - [ ] Verify 3 channels returned
    - [ ] Verify channels stored in database
  - [ ] Test: Channel rebalancing (AC: 7)
    - [ ] Open channel with max balance
    - [ ] Mock channel balance to fall below minChannelBalance
    - [ ] Call `checkChannelRebalancing('agent-001')`
    - [ ] Verify old channel closed
    - [ ] Verify new channel opened with maxChannelBalance
  - [ ] Test: Database persistence and restoration (AC: 5)
    - [ ] Open 2 channels
    - [ ] Destroy channel manager instance
    - [ ] Create new channel manager with same database
    - [ ] Verify 2 channels loaded from database
  - [ ] Achieve >80% code coverage for AgentChannelManager
    - [ ] [Source: docs/architecture/test-strategy-and-standards.md line 7 - connector >80%]

- [ ] Task 8: Implement Integration Test (AC: 10)
  - [ ] Create integration test file: `packages/connector/test/integration/agent-channel-integration.test.ts`
    - [ ] [Source: docs/architecture/test-strategy-and-standards.md line 64]
  - [ ] Test: Full agent channel workflow (AC: 10)
    - [ ] **Setup:** Initialize real instances of `AgentWalletDerivation`, `AgentWalletFunder`, `AgentWalletLifecycle`, `PaymentChannelSDK`, `AgentChannelManager`
    - [ ] **Setup:** Use local Anvil for EVM channel transactions
    - [ ] **Setup:** Mock XRPL client for XRP channels (optional: use local rippled if available)
    - [ ] **Setup:** Create two agent wallets (agent-001, agent-002) and fund them
    - [ ] Step 1: Agent 001 opens EVM payment channel to Agent 002: `await channelManager.openChannel({ agentId: 'agent-001', peerId: 'agent-002', chain: 'evm', token: 'USDC', amount: 1000000000000000000n })`
    - [ ] Verify channel creation on-chain using PaymentChannelSDK.getChannelState()
    - [ ] Verify channel tracked in database
    - [ ] Step 2: Agent 001 sends payment to Agent 002 via channel: `await channelManager.sendPayment({ agentId: 'agent-001', channelId, amount: 100000000000000000n })`
    - [ ] Verify balance proof signed and sent
    - [ ] Verify wallet activity recorded
    - [ ] Step 3: Agent 001 sends multiple payments (5 payments): repeat sendPayment() 5 times
    - [ ] Verify cumulative transferred amount tracked correctly
    - [ ] Step 4: Close channel: `await channelManager.closeChannel('agent-001', channelId)`
    - [ ] Verify channel closure on-chain
    - [ ] Verify channel marked as closed in database
    - [ ] Verify all telemetry events emitted: OPENED, PAYMENT_SENT (6 times), CLOSED
    - [ ] [Source: Epic 11 Story 11.6 AC 10]
  - [ ] Test: XRP channel workflow (optional, if local rippled available)
    - [ ] Same workflow as EVM but with XRP chain
    - [ ] Verify XRP claims signed correctly
    - [ ] Verify XRP channel closure
  - [ ] Test: Multi-agent concurrent channel operations
    - [ ] Create 5 agent wallets
    - [ ] Open 10 channels concurrently (5 agents × 2 channels each)
    - [ ] Send payments concurrently
    - [ ] Verify no state corruption or race conditions
  - [ ] Verify test isolation
    - [ ] Use temporary directory for test database
    - [ ] Clean up Anvil instance in `afterEach` hook
    - [ ] Clean up test database files
    - [ ] [Source: docs/architecture/test-strategy-and-standards.md line 120]

## Dev Notes

### Story Context

This is **Story 11.6 in Epic 11: AI Agent Wallet Infrastructure**. Epic 11 delivers comprehensive wallet infrastructure for AI agents to participate in the M2M economy with cryptocurrency micropayments.

**Epic 11 Context:**

- Story 11.1 (complete): HD Wallet Master Seed Management
- Story 11.2 (complete): Agent Wallet Derivation and Address Generation
- Story 11.3 (complete): Agent Wallet Balance Tracking and Monitoring
- Story 11.4 (complete): Automated Agent Wallet Funding
- Story 11.5 (complete): Agent Wallet Lifecycle Management
- Story 11.6 (this story): Payment Channel Integration for Agent Wallets
- Story 11.7: Dashboard Agent Wallet Visualization
- Story 11.8: Wallet Backup and Recovery Procedures
- Story 11.9: Security Hardening for Agent Wallets
- Story 11.10: Documentation and Agent Onboarding

**Relationship to Other Epics:**

- **Depends on:** Epic 11 Stories 11.2 (Agent Wallet Derivation), 11.5 (Lifecycle Management)
- **Integrates with:** Epic 8 (EVM Payment Channels - PaymentChannelSDK), Epic 9 (XRP Payment Channels - XRPChannelSDK)
- **Enables:** Epic 11 Story 11.7 (dashboard displays agent channel state and activity)
- **Future Enhancement:** Epic 7 (BTP Protocol) for off-chain balance proof / claim transmission

**Scope Note:**

Story 11.6 bridges agent wallets (Stories 11.2-11.5) with payment channel infrastructure (Epic 8, Epic 9) to enable AI agents to execute micropayments with low fees and high speed. The AgentChannelManager orchestrates wallet lifecycle verification, wallet signing, and channel operations across both EVM (Base L2) and XRP Ledger. This story is critical for enabling the M2M economy where agents autonomously manage payment channels for high-frequency micropayment transactions.

### Previous Story Insights

**Key Learnings from Epic 11 Story 11.5 (Agent Wallet Lifecycle Management):**

1. **Wallet Lifecycle Verification Required:** Story 11.5 provides `getLifecycleRecord(agentId)` method that Story 11.6 MUST call before opening channels. Only ACTIVE wallets can open channels. [Source: Epic 11 Story 11.5 public API, Epic 11 Story 11.6 Technical Specification line 993-996]

2. **Activity Tracking Integration:** Story 11.5 provides `recordTransaction(agentId, token, amount)` method that Story 11.6 should call after each channel operation (open, payment, close) to track wallet activity. [Source: Epic 11 Story 11.5 activity tracking, Epic 11 Story 11.6 Technical Specification line 1076]

3. **Event-Driven Architecture:** Story 11.5 follows pattern of emitting telemetry events for all state changes. Story 11.6 should emit similar channel events (OPENED, PAYMENT_SENT, CLOSED). [Source: Epic 11 Story 11.5 telemetry pattern]

4. **Database Persistence Pattern:** Story 11.5 uses SQLite with in-memory cache (Map) for fast lookups. Story 11.6 should extend the same `agent-wallets.db` database with `agent_channels` table. [Source: Epic 11 Story 11.5 database pattern]

**Key Learnings from Epic 11 Story 11.2 (Agent Wallet Derivation):**

1. **Signer Retrieval:** Story 11.2 provides `getAgentSigner(agentId, chain)` method that Story 11.6 needs to call to get ethers.Signer or XRPL signer for signing channel operations. [Source: Epic 11 Story 11.2 public API, Story 11.6 needs signing capabilities]

2. **Multi-Chain Support:** Story 11.2 derives both EVM and XRP addresses for each agent. Story 11.6 must support both chains in all channel operations. [Source: Epic 11 Story 11.2 multi-chain derivation]

**Key Learnings from Epic 8 (EVM Payment Channels):**

1. **PaymentChannelSDK API:** Epic 8 provides `PaymentChannelSDK` class with methods: `openChannel()`, `deposit()`, `signBalanceProof()`, `closeChannel()`, `getChannelState()`. Story 11.6 wraps these methods for agent use. [Source: Epic 8 Story 8.6 PaymentChannelSDK lines 424-460]

2. **EIP-712 Balance Proof Signing:** EVM channels use EIP-712 typed data signing for balance proofs. The SDK handles signing internally; Story 11.6 just calls `signBalanceProof()`. [Source: Epic 8 EIP-712 signing lines 465-487]

3. **Settlement Timeout:** EVM channels use 3600-second (1 hour) settlement timeout per Epic 8 standards. [Source: Epic 8 Story 8.6 Technical Specification line 1009]

**Key Learnings from Epic 9 (XRP Payment Channels):**

1. **XRPChannelSDK API:** Epic 9 provides `XRPChannelSDK` class with methods: `openChannel()`, `fundChannel()`, `signClaim()`, `submitClaim()`, `closeChannel()`, `getChannelState()`. Story 11.6 wraps these for agent use. [Source: Epic 9 Story 9.6 XRPChannelSDK lines 441-541]

2. **XRP Claim Signing:** XRP channels use claim signatures (different from EVM balance proofs). The SDK handles signing; Story 11.6 calls `signClaim()`. [Source: Epic 9 XRPChannelSDK.signClaim() lines 479-486]

3. **Settlement Delay:** XRP channels use 3600-second settlement delay per Epic 9 standards. [Source: Epic 9 Story 9.6 Technical Specification line 1018]

**How Story 11.6 Applies These Learnings:**

- Task 2 integrates PaymentChannelSDK for EVM channels with proper lifecycle verification
- Task 3 integrates XRPChannelSDK for XRP channels following same patterns
- Task 4 implements database persistence following Story 11.5 patterns
- Task 6 implements telemetry following Story 11.5 event-driven architecture
- All channel operations call `lifecycleManager.recordTransaction()` for activity tracking

### Data Models

**AgentChannel Interface** [Source: Epic 11 Story 11.6 Technical Specification lines 1109-1122]

```typescript
interface AgentChannel {
  agentId: string; // Unique agent identifier
  channelId: string; // On-chain channel ID (EVM: bytes32, XRP: channel_id)
  chain: 'evm' | 'xrp'; // Blockchain network
  peerId: string; // Peer agent identifier
  token: string; // Token symbol (EVM: USDC/DAI, XRP: XRP)
  openedAt: number; // Unix timestamp (channel opened)
  lastActivityAt?: number; // Unix timestamp (last payment)
  closedAt?: number; // Unix timestamp (channel closed)
}
```

**ChannelManagerConfig Interface**

```typescript
interface ChannelManagerConfig {
  minChannelBalance: bigint; // Minimum channel balance before rebalancing (default: 1 ETH)
  maxChannelBalance: bigint; // Maximum channel deposit on rebalance (default: 10 ETH)
  rebalanceEnabled: boolean; // Enable automatic channel rebalancing (default: true)
}
```

**ChannelOpenParams Interface** [Source: Epic 11 Story 11.6 Technical Specification lines 985-991]

```typescript
interface ChannelOpenParams {
  agentId: string; // Agent opening channel
  peerId: string; // Peer agent identifier
  chain: 'evm' | 'xrp'; // Blockchain network
  token: string; // Token to deposit (EVM: contract address, XRP: 'XRP')
  amount: bigint; // Initial deposit amount
}
```

**ChannelPaymentParams Interface** [Source: Epic 11 Story 11.6 Technical Specification lines 1039-1040]

```typescript
interface ChannelPaymentParams {
  agentId: string; // Agent sending payment
  channelId: string; // Channel ID
  amount: bigint; // Payment amount
}
```

**Key Design Decisions:**

1. **Unified Channel Management:** AgentChannel interface supports both EVM and XRP channels with `chain` discriminator. Simplifies multi-chain channel tracking. [Source: Epic 11 Story 11.6 multi-chain support]

2. **Activity Tracking:** `lastActivityAt` timestamp enables channel rebalancing based on inactivity. Channels with no recent activity can be closed to free up capital. [Source: Epic 11 Story 11.6 AC 7]

3. **Peer-to-Peer Agent Model:** Assumes peers are also agents with wallets (peer ID = agent ID). `getPeerWallet()` uses AgentWalletDerivation to get peer addresses. [Source: M2M economy design assumption]

4. **Rebalancing Thresholds:** Min/max balance configuration enables automatic channel rebalancing when channel depletes. Prevents channel exhaustion and maintains liquidity. [Source: Epic 11 Story 11.6 AC 7]

### API Specifications

**No external APIs** - This story integrates internal components (Epic 8 PaymentChannelSDK, Epic 9 XRPChannelSDK, Story 11.2 AgentWalletDerivation, Story 11.5 AgentWalletLifecycle).

**Internal API: AgentChannelManager** [Source: Epic 11 Story 11.6 Technical Specification lines 976-1131]

**Class: `AgentChannelManager`**

Location: `packages/connector/src/wallet/agent-channel-manager.ts`

**Constructor:**

```typescript
constructor(
  walletDerivation: AgentWalletDerivation,
  evmChannelSDK: PaymentChannelSDK,
  xrpChannelSDK: XRPChannelSDK,
  lifecycleManager: AgentWalletLifecycle,
  telemetryEmitter: TelemetryEmitter,
  config: ChannelManagerConfig,
  dbPath?: string
)
```

**Public Methods:**

1. `async openChannel(params: ChannelOpenParams): Promise<string>`
   - Opens payment channel for agent (EVM or XRP based on params.chain)
   - Verifies wallet is ACTIVE via lifecycleManager.getLifecycleRecord()
   - Calls PaymentChannelSDK.openChannel() for EVM or XRPChannelSDK.openChannel() for XRP
   - Tracks channel in database and in-memory cache
   - Records wallet activity via lifecycleManager.recordTransaction()
   - Emits `AGENT_CHANNEL_OPENED` telemetry event
   - Returns channel ID
   - Throws error if wallet not active or channel open fails

2. `async sendPayment(params: ChannelPaymentParams): Promise<void>`
   - Sends payment through existing channel (EVM or XRP)
   - Signs balance proof (EVM) or claim (XRP) using wallet derivation signer
   - Sends balance proof/claim to peer off-chain (placeholder for MVP)
   - Records wallet activity via lifecycleManager.recordTransaction()
   - Updates channel last activity timestamp
   - Emits `AGENT_CHANNEL_PAYMENT_SENT` telemetry event
   - Throws error if channel not found

3. `async closeChannel(agentId: string, channelId: string): Promise<void>`
   - Closes payment channel on-chain (EVM or XRP)
   - Calls PaymentChannelSDK.closeChannel() or XRPChannelSDK.closeChannel()
   - Marks channel as closed in database
   - Removes channel from active tracking (in-memory cache)
   - Emits `AGENT_CHANNEL_CLOSED` telemetry event
   - Throws error if channel not found

4. `async getAgentChannels(agentId: string): Promise<AgentChannel[]>`
   - Returns all active (non-closed) channels for agent
   - Queries in-memory cache first, falls back to database
   - Used by Story 11.7 dashboard to display agent channel state

5. `async checkChannelRebalancing(agentId: string): Promise<void>`
   - Checks all agent channels for low balance (< minChannelBalance)
   - Closes depleted channels and opens new channels with maxChannelBalance
   - Only runs if config.rebalanceEnabled = true
   - Called automatically after sendPayment() if balance falls below threshold

**Private Methods:**

- `private async trackAgentChannel(agentId, channelId, chain, peerId, token): Promise<void>`
  - Stores channel in database and in-memory cache

- `private async getAgentChannel(agentId, channelId): Promise<AgentChannel | null>`
  - Retrieves channel from cache or database

- `private async updateChannelActivity(channelId): Promise<void>`
  - Updates channel last activity timestamp

- `private async updateChannelClosed(channelId): Promise<void>`
  - Marks channel as closed in database and removes from cache

- `private async getPeerWallet(peerId): Promise<AgentWallet>`
  - Retrieves peer wallet addresses using AgentWalletDerivation

- `private async getChannelBalance(channelId, chain): Promise<bigint>`
  - Queries on-chain channel balance for rebalancing logic

- `private async sendBalanceProofToPeer(peerId, balanceProof): Promise<void>`
  - Placeholder for off-chain balance proof transmission (EVM)
  - **Future Enhancement:** Integrate with Epic 7 BTP Protocol

- `private async sendClaimToPeer(peerId, claim): Promise<void>`
  - Placeholder for off-chain claim transmission (XRP)
  - **Future Enhancement:** Integrate with Epic 7 BTP Protocol

### Component Specifications

**File: `packages/connector/src/wallet/agent-channel-manager.ts` (NEW)** [Source: Epic 11 Story 11.6 AC 1]

Primary component integrating agent wallets (Stories 11.2, 11.5) with payment channels (Epic 8, Epic 9).

**Dependencies:**

- `AgentWalletDerivation` (from Story 11.2): Get agent signers for channel operations
- `PaymentChannelSDK` (from Epic 8): EVM channel operations (Base L2)
- `XRPChannelSDK` (from Epic 9): XRP channel operations
- `AgentWalletLifecycle` (from Story 11.5): Verify wallet active, record transactions
- `TelemetryEmitter` (existing): Channel event emission
- `better-sqlite3` (from Story 11.2): Database persistence
- Pino logger: Structured logging

**Key Design Decisions:**

1. **Multi-Chain Abstraction:** Single `openChannel()` method supports both EVM and XRP via `chain` parameter. Internal branching routes to appropriate SDK. [Source: Epic 11 Story 11.6 multi-chain design]

2. **Lifecycle Integration:** All channel operations verify wallet is ACTIVE before proceeding. Prevents suspended/archived wallets from opening channels. [Source: Epic 11 Story 11.6 Technical Specification lines 993-996]

3. **Off-Chain Communication Placeholder:** `sendBalanceProofToPeer()` and `sendClaimToPeer()` are placeholders for off-chain message passing. MVP logs balance proofs/claims; future integration with Epic 7 BTP Protocol for actual transmission. [Source: Epic 11 Story 11.6 Technical Specification lines 1058-1063, 1070-1073]

4. **Automatic Rebalancing:** `sendPayment()` triggers `checkChannelRebalancing()` asynchronously if balance falls below threshold. Prevents blocking payment execution. [Source: Epic 11 Story 11.6 AC 7]

5. **Database Schema Extension:** Extends existing `agent-wallets.db` (Story 11.2) with `agent_channels` table. All agent wallet data in single database. [Source: Story 11.6 database schema task]

**File: `packages/connector/src/wallet/wallet-db-schema.ts` (MODIFIED)** [Source: Task 1]

Extends existing database schema with channel tracking table.

**New Table:**

- `agent_channels`: Stores all agent channel records (open, active, closed)

**File: `packages/shared/src/types/telemetry.ts` (MODIFIED)** [Source: Task 6]

Extends existing telemetry event types with channel events.

**New Event Types:**

- `AGENT_CHANNEL_OPENED`: Emitted when agent opens channel
- `AGENT_CHANNEL_PAYMENT_SENT`: Emitted when agent sends payment through channel
- `AGENT_CHANNEL_CLOSED`: Emitted when agent closes channel

### File Locations

[Source: docs/architecture/source-tree.md, Epic 11 Story 11.6 AC 1]

**New Files (Story 11.6):**

- `packages/connector/src/wallet/agent-channel-manager.ts` - AgentChannelManager class
- `packages/connector/src/wallet/agent-channel-manager.test.ts` - Unit tests
- `packages/connector/test/integration/agent-channel-integration.test.ts` - Integration test

**Modified Files:**

- `packages/connector/src/wallet/wallet-db-schema.ts` - Add agent_channels table
- `packages/shared/src/types/telemetry.ts` - Add channel telemetry event types
- `packages/shared/src/index.ts` - Export new telemetry types

**No New Directories:** All files in existing wallet module structure from Stories 11.2-11.5.

**Project Structure After Story 11.6:**

```
packages/connector/
├── src/
│   ├── wallet/                     # Wallet module (expanded)
│   │   ├── wallet-seed-manager.ts  # Story 11.1: Master seed management
│   │   ├── wallet-seed-manager.test.ts
│   │   ├── agent-wallet-derivation.ts  # Story 11.2: Agent wallet derivation
│   │   ├── agent-wallet-derivation.test.ts
│   │   ├── agent-balance-tracker.ts    # Story 11.3: Balance tracking
│   │   ├── agent-balance-tracker.test.ts
│   │   ├── agent-wallet-funder.ts      # Story 11.4: Automated funding
│   │   ├── agent-wallet-funder.test.ts
│   │   ├── treasury-wallet.ts          # Story 11.4: Treasury wallet management
│   │   ├── agent-wallet-lifecycle.ts   # Story 11.5: Lifecycle management
│   │   ├── agent-wallet-lifecycle.test.ts
│   │   ├── agent-channel-manager.ts    # NEW: Payment channel integration
│   │   ├── agent-channel-manager.test.ts
│   │   └── wallet-db-schema.ts     # Stories 11.2 + 11.3 + 11.5 + 11.6 schemas
│   ├── settlement/                 # Payment channels (Epic 8, Epic 9)
│   │   ├── payment-channel-sdk.ts      # Epic 8: EVM channels
│   │   ├── xrp-channel-sdk.ts          # Epic 9: XRP channels
│   │   └── ...
│   ├── telemetry/
│   │   └── telemetry-emitter.ts    # Existing: Used for channel events
│   └── ...
├── test/
│   └── integration/
│       ├── wallet-derivation.test.ts          # Story 11.1
│       ├── agent-wallet-uniqueness.test.ts    # Story 11.2
│       ├── agent-balance-tracking.test.ts     # Story 11.3
│       ├── agent-wallet-funding.test.ts       # Story 11.4
│       ├── agent-wallet-lifecycle.test.ts     # Story 11.5
│       └── agent-channel-integration.test.ts  # NEW: Channel integration test
└── package.json                    # No new dependencies (all from Epic 8/9)
```

**Runtime Environment Variables:**

No new environment variables. Uses existing variables from Epic 8 (EVM RPC URL, contract addresses) and Epic 9 (XRP RPC URL).

**Database Files:**

- `./data/wallet/agent-wallets.db`: Stores agent wallet metadata (Story 11.2), balance history (Story 11.3), lifecycle records (Story 11.5), channel tracking (Story 11.6)

### Testing Requirements

[Source: docs/architecture/test-strategy-and-standards.md]

**Unit Tests (Task 7):**

- **Coverage Target:** >80% for `AgentChannelManager` (connector package standard)
- **Test File:** `packages/connector/src/wallet/agent-channel-manager.test.ts`
- **Mocking Strategy:**
  - Mock `AgentWalletDerivation` to return test wallets and signers
  - Mock `PaymentChannelSDK` to simulate EVM channel operations (openChannel, signBalanceProof, closeChannel, getChannelState)
  - Mock `XRPChannelSDK` to simulate XRP channel operations (openChannel, signClaim, closeChannel, getChannelState)
  - Mock `AgentWalletLifecycle` to return active wallet state
  - Mock `TelemetryEmitter` to verify event emissions
  - Use in-memory SQLite database (`:memory:`) for test isolation
  - Use fresh mock instances in `beforeEach()` for test isolation
- **Test Cases:**
  - Open EVM channel for agent (verify SDK calls, database tracking, telemetry)
  - Open XRP channel for agent (verify SDK calls, database tracking, telemetry)
  - Send payment through EVM channel (verify balance proof signing, peer transmission placeholder, activity tracking)
  - Send payment through XRP channel (verify claim signing, peer transmission placeholder, activity tracking)
  - Close EVM channel (verify on-chain closure, database update, telemetry)
  - Close XRP channel (verify on-chain closure, database update, telemetry)
  - Reject channel open if wallet not active (verify lifecycle verification)
  - Track multiple channels per agent (verify database storage and retrieval)
  - Channel rebalancing (verify depleted channel closed, new channel opened)
  - Database persistence and restoration (verify channels loaded from database on restart)
- **Anti-Pattern Awareness:**
  - Use fresh mock instances in `beforeEach()` (avoid test interdependencies)
  - Use `mockResolvedValueOnce()` for sequential SDK calls with different return values
  - Test public behavior (channel opened, payment sent, channel closed), not private implementation details
  - Use in-memory database for fast, isolated tests
  - [Source: docs/architecture/test-strategy-and-standards.md lines 132-663]

**Integration Tests (Task 8):**

- **Coverage Target:** Verify full channel workflow with real blockchain transactions
- **Test File:** `packages/connector/test/integration/agent-channel-integration.test.ts`
- **Test Infrastructure:**
  - Local Anvil instance (EVM test network)
  - Real `ethers` Provider connected to Anvil
  - Real `PaymentChannelSDK` instance with deployed contracts
  - Mock XRPL client (full XRP Testnet integration optional for MVP)
  - Real `AgentWalletDerivation`, `AgentWalletLifecycle`, `AgentChannelManager` instances
  - Temporary file system for test database
- **Test Cases:**
  - Full EVM channel workflow: open → send payments (multiple) → close
  - Full XRP channel workflow: open → send payments → close (if local rippled available)
  - Multi-agent concurrent channel operations (5 agents, 10 channels)
- **Test Isolation:**
  - Use unique database paths per test run
  - Clean up Anvil instance in `afterEach` hook
  - Clean up test database files
  - [Source: docs/architecture/test-strategy-and-standards.md line 120]

**Security Testing:**

- Verify only ACTIVE wallets can open channels (lifecycle verification)
- Verify balance proofs/claims signed correctly (signature validation)
- Verify channel operations tracked in database (audit trail)
- Verify telemetry events emitted for all operations (monitoring)

### Technical Constraints

[Source: docs/architecture/tech-stack.md, docs/architecture/coding-standards.md]

**Language and Runtime:**

- TypeScript 5.3.3 (strict mode enabled)
- Node.js 20.11.0 LTS
- No specific Node.js version constraints for channel management

**Database Constraints:**

- SQLite `better-sqlite3` (from Story 11.2)
- Database path: `./data/wallet/agent-wallets.db` (default, configurable in constructor)
- Channel IDs stored as TEXT (EVM: bytes32 hex string, XRP: channel_id string)
- No SQLite version constraints (Story 11.2 established database patterns)

[Source: Epic 11 Stories 11.2, 11.3, 11.5, 11.6 database usage]

**Payment Channel Constraints:**

- **EVM Channels (Epic 8):**
  - Settlement timeout: 3600 seconds (1 hour) per Epic 8 standards
  - Balance proof signing: EIP-712 typed data (handled by PaymentChannelSDK)
  - Token support: ERC-20 tokens on Base L2 (USDC, DAI, etc.)
  - [Source: Epic 8 Story 8.6 PaymentChannelSDK]

- **XRP Channels (Epic 9):**
  - Settlement delay: 3600 seconds (1 hour) per Epic 9 standards
  - Claim signing: XRP Ledger claim signatures (handled by XRPChannelSDK)
  - Token support: XRP only (native token)
  - [Source: Epic 9 Story 9.6 XRPChannelSDK]

**Error Handling:**

- All async functions must use try-catch [Source: docs/architecture/coding-standards.md line 30]
- Channel operation failures logged but may throw errors (caller handles)
- Off-chain communication failures logged but don't block channel operations (placeholder for MVP)
- Telemetry errors non-blocking (wrapped in try-catch)
- Database errors propagated to caller (no silent failures)

**Logging:**

- Use Pino logger exclusively (NEVER console.log) [Source: docs/architecture/coding-standards.md line 24]
- Log all channel operations at `info` level (include agent ID, channel ID, chain, peer ID)
- Log channel open/close at `info` level
- Log payments at `info` level with amount
- Log errors at `error` level (include agent ID, channel ID, error message)

**Dependencies:**

- `AgentWalletDerivation` (from Story 11.2): Wallet signing
- `PaymentChannelSDK` (from Epic 8): EVM channel operations
- `XRPChannelSDK` (from Epic 9): XRP channel operations
- `AgentWalletLifecycle` (from Story 11.5): Lifecycle verification, activity tracking
- `TelemetryEmitter` (existing): Event emission
- `better-sqlite3` (from Story 11.2): Database persistence
- No new NPM dependencies

[Source: Epic 8 Story 8.6, Epic 9 Story 9.6, Epic 11 Stories 11.2, 11.5, docs/architecture/source-tree.md line 18]

**Performance Considerations:**

- **Channel Open:** ~10-30 seconds (dominated by blockchain transaction confirmation)
  - EVM: 1-5 seconds (Anvil/Base L2)
  - XRP: 3-5 seconds (XRPL)
- **Payment Send (off-chain):** <100ms (signing + database update + telemetry emission)
  - Balance proof signing: ~10-50ms
  - Database write: ~5ms
  - Off-chain transmission: ~0ms (placeholder for MVP, future: 10-100ms for BTP)
- **Channel Close:** ~10-30 seconds (blockchain transaction confirmation)
- **Channel Query:** <5ms (in-memory cache lookup or database query)
- **Rebalancing Check:** ~100ms per channel (depends on RPC query latency)

[Source: Typical blockchain and database operation performance]

**Scalability Considerations:**

- Story 11.6 supports unlimited agent channels (limited by database storage and memory)
- In-memory `agentChannels` map grows linearly with active channels (O(n) memory)
- 10,000 active channels: ~5-10MB memory (assuming 500-1000 bytes per channel object)
- For >100,000 channels: consider database-only storage (no in-memory cache) or partitioning by chain
- Channel rebalancing: O(n) iteration through agent channels (acceptable for MVP, optimize later if needed)

**No performance impact on existing connector functionality** - Channel manager runs independently, doesn't block ILP packet forwarding.

### Project Structure Notes

[Source: docs/architecture/source-tree.md]

**Monorepo Structure:**

- `packages/connector`: Backend ILP connector (includes wallet and settlement modules)
- `packages/dashboard`: React visualization dashboard
- `packages/shared`: Shared types and utilities

**Story 11.6 expands wallet module and integrates with settlement module in connector package:**

```
packages/connector/
├── src/
│   ├── wallet/            # Wallet infrastructure (expanded in Story 11.6)
│   │   ├── wallet-seed-manager.ts         # Story 11.1
│   │   ├── agent-wallet-derivation.ts     # Story 11.2
│   │   ├── agent-balance-tracker.ts       # Story 11.3
│   │   ├── agent-wallet-funder.ts         # Story 11.4
│   │   ├── treasury-wallet.ts             # Story 11.4
│   │   ├── agent-wallet-lifecycle.ts      # Story 11.5
│   │   ├── agent-channel-manager.ts       # Story 11.6 (NEW)
│   │   └── wallet-db-schema.ts            # Stories 11.2-11.6
│   ├── settlement/        # Payment channels (Epic 8, Epic 9)
│   │   ├── payment-channel-sdk.ts         # Epic 8: EVM channels
│   │   ├── xrp-channel-sdk.ts             # Epic 9: XRP channels
│   │   └── ...
│   └── ...
```

**File Naming Conventions:** [Source: docs/architecture/coding-standards.md line 16]

- TypeScript files: kebab-case (e.g., `agent-channel-manager.ts`)
- Test files: `<filename>.test.ts` co-located with source
- Classes: PascalCase (e.g., `AgentChannelManager`)
- Interfaces: PascalCase (e.g., `AgentChannel`)

**Storage Locations:**

- Agent wallets database: `./data/wallet/agent-wallets.db` (from Story 11.2)
- Database tables: `agent_wallets` (Story 11.2), `agent_balances` (Story 11.3), `wallet_lifecycle` (Story 11.5), `agent_channels` (Story 11.6)
- Directory created at runtime if not exists

### Dependencies and Integration Points

**Internal Dependencies:**

- `AgentWalletDerivation` (Story 11.2): `packages/connector/src/wallet/agent-wallet-derivation.ts`
  - Used for getting agent signers for channel signing operations (`getAgentSigner()`)
  - Used for getting peer wallet addresses (`getAgentWallet()`)
  - [Source: Epic 11 Story 11.6 requires wallet signing]

- `PaymentChannelSDK` (Epic 8): `packages/connector/src/settlement/payment-channel-sdk.ts`
  - Used for EVM channel operations: `openChannel()`, `deposit()`, `signBalanceProof()`, `closeChannel()`, `getChannelState()`
  - [Source: Epic 8 Story 8.6 PaymentChannelSDK API]

- `XRPChannelSDK` (Epic 9): `packages/connector/src/settlement/xrp-channel-sdk.ts`
  - Used for XRP channel operations: `openChannel()`, `fundChannel()`, `signClaim()`, `closeChannel()`, `getChannelState()`
  - [Source: Epic 9 Story 9.6 XRPChannelSDK API]

- `AgentWalletLifecycle` (Story 11.5): `packages/connector/src/wallet/agent-wallet-lifecycle.ts`
  - Used for lifecycle verification: `getLifecycleRecord()` to verify wallet is ACTIVE before opening channels
  - Used for activity tracking: `recordTransaction()` to record channel operations
  - [Source: Epic 11 Story 11.5 public API]

- `TelemetryEmitter` (existing): `packages/connector/src/telemetry/telemetry-emitter.ts`
  - Used for channel event emission
  - [Source: Epic 11 Story 11.6 AC 8]

- Pino Logger: `packages/connector/src/utils/logger.ts` (existing)
  - Used for structured logging throughout channel operations
  - [Source: docs/architecture/tech-stack.md line 27]

**External Dependencies (No New NPM Packages):**

Story 11.6 reuses all dependencies from Epic 8, Epic 9, and Stories 11.2, 11.5:

- `ethers` (from Epic 8): EVM interaction
- `xrpl` (from Epic 9): XRP Ledger interaction
- `better-sqlite3` (from Story 11.2): Database persistence
- `pino` (existing): Structured logging

**Integration Points:**

**Story 11.7 (Dashboard Agent Wallet Visualization):**

- Story 11.7 will call `getAgentChannels(agentId)` to display agent channel state
- Story 11.7 will subscribe to `AGENT_CHANNEL_OPENED`, `AGENT_CHANNEL_PAYMENT_SENT`, `AGENT_CHANNEL_CLOSED` telemetry events for real-time updates
- Story 11.7 will display channel details: channel ID, chain (EVM/XRP), peer ID, opened timestamp, last activity
- [Source: Epic 11 Story 11.7 dashboard integration requirements]

**Epic 7 (BTP Protocol):**

- **Future Enhancement:** Story 11.6 placeholders `sendBalanceProofToPeer()` and `sendClaimToPeer()` will integrate with Epic 7 BTP Protocol for off-chain message passing
- BTP will enable agents to send balance proofs/claims to peers without on-chain transactions
- [Source: Epic 11 Story 11.6 Technical Specification lines 1058-1063, future enhancement]

**Epic 8 (EVM Payment Channels) / Epic 9 (XRP Payment Channels):**

- Story 11.6 wraps Epic 8/9 SDKs with agent-specific logic (lifecycle verification, activity tracking, telemetry)
- All EVM channel operations route through PaymentChannelSDK
- All XRP channel operations route through XRPChannelSDK
- [Source: Epic 11 Story 11.6 integrates with Epic 8/9]

**No integration with other epics in Story 11.6** - This story bridges agent wallets (Epic 11) with payment channels (Epic 8, Epic 9).

### Security Considerations

[Source: Epic 11 Story 11.6 security requirements, Epic 11 Story 11.9]

**Security Requirements:**

1. **Lifecycle Verification:** Only ACTIVE wallets can open channels. SUSPENDED or ARCHIVED wallets rejected. [Source: Epic 11 Story 11.6 Technical Specification lines 993-996]

2. **Signature Security:** All channel operations (balance proofs, claims) signed using agent's derived private key. No key exposure; signing delegated to wallets from Story 11.2. [Source: Epic 11 Story 11.2 security design]

3. **Channel Operation Audit Trail:** All channel operations (open, payment, close) logged at `info` level and tracked in database. [Source: Epic 11 Story 11.6 logging requirements]

4. **Telemetry Event Integrity:** All channel operations emit telemetry events for monitoring and audit. Telemetry failures non-blocking (don't break channel operations). [Source: Epic 11 Story 11.6 AC 8]

5. **Off-Chain Communication Security:** Balance proofs/claims transmitted off-chain (placeholder for MVP). Future: BTP Protocol provides authenticated, encrypted message passing. [Source: Future Epic 7 integration]

**Threat Model:**

- **Threat:** Unauthorized channel open (agent wallet not active)
  - **Mitigation:** Lifecycle verification in `openChannel()`. Only ACTIVE wallets proceed.

- **Threat:** Invalid balance proof / claim signature
  - **Mitigation:** SDKs (Epic 8, Epic 9) handle signature validation. Story 11.6 delegates to SDKs.

- **Threat:** Off-chain message interception or tampering (balance proofs, claims)
  - **Mitigation (Future):** Epic 7 BTP Protocol provides authenticated, encrypted message passing. MVP logs messages (placeholder).

- **Threat:** Database corruption (channel records lost)
  - **Mitigation:** Channel records persisted to database on every operation. Future: Epic 11 Story 11.8 adds backup procedures.

**Security Testing (Task 7):**

- Verify only ACTIVE wallets can open channels (lifecycle verification test)
- Verify balance proofs/claims signed correctly (signature validation test with real SDKs)
- Verify channel operations tracked in database (audit trail test)
- Verify telemetry events emitted for all operations (monitoring test)

**Security Best Practices:**

- Validate lifecycle state in all channel operations (prevent invalid operations)
- Log all channel operations with timestamps and agent/peer identifiers (audit trail)
- Delegate signing to SDKs (no direct key management in Story 11.6)
- Emit telemetry events for monitoring (detect anomalous channel activity)

### Performance Considerations

[Source: Epic 11 Success Metrics, typical blockchain and database operation performance]

**Performance Goals:**

- **Channel Open:** <30 seconds (EVM: ~5 seconds, XRP: ~5 seconds, dominated by blockchain confirmation)
  - Agent signer retrieval: <10ms (Story 11.2 cache)
  - Lifecycle verification: <5ms (Story 11.5 in-memory lookup)
  - SDK channel open: 1-5 seconds (Anvil/Base L2) or 3-5 seconds (XRPL)
  - Database write: ~5ms (SQLite)
  - Telemetry emission: ~1ms (non-blocking)

- **Payment Send (off-chain):** <100ms (no blockchain transaction for off-chain payment)
  - Channel lookup: <5ms (in-memory cache or database)
  - Channel state query: ~50-100ms (RPC call to get current state)
  - Balance proof/claim signing: ~10-50ms (EIP-712 or XRPL signing)
  - Off-chain transmission: ~0ms (placeholder for MVP, future: 10-100ms for BTP)
  - Database write (activity update): ~5ms (SQLite)
  - Telemetry emission: ~1ms (non-blocking)

- **Channel Close:** <30 seconds (blockchain transaction confirmation)
  - SDK channel close: 1-5 seconds (Anvil/Base L2) or 3-5 seconds (XRPL)
  - Database write: ~5ms (SQLite)
  - Telemetry emission: ~1ms (non-blocking)

- **Channel Query:** <5ms (in-memory cache lookup or database query)

- **Rebalancing Check:** ~100ms per channel (depends on RPC query latency for channel balance)
  - Iterate all agent channels: O(n) where n = number of channels
  - For 10 channels: ~1 second total
  - Runs asynchronously after `sendPayment()` (doesn't block payment)

**Optimization Notes:**

- **In-Memory Cache:** `agentChannels` map provides O(1) lookup for channel queries (no database query needed for active channels)
- **Async Rebalancing:** Rebalancing triggered asynchronously after payment to avoid blocking payment execution
- **Off-Chain Payments:** Balance proofs/claims signed off-chain (no blockchain transaction), enabling high-frequency micropayments
- **Batch Rebalancing (Future Enhancement):** Close and open multiple channels in single transaction batch (reduce transaction overhead)

**Scalability Considerations:**

- Story 11.6 supports unlimited agent channels (limited by database storage and memory)
- In-memory `agentChannels` map: ~500-1000 bytes per channel object
  - 10,000 active channels: ~5-10MB memory
  - 100,000 active channels: ~50-100MB memory (acceptable)
  - 1,000,000 active channels: ~500MB-1GB memory (consider database-only storage)
- Database storage: ~200 bytes per channel record
  - 1,000,000 channel records: ~200MB database size (SQLite handles efficiently)
- For >1,000,000 channels: consider partitioning database by chain or using separate channel database

**No performance impact on existing connector functionality** - Channel manager runs independently, doesn't block ILP packet forwarding.

## Change Log

| Date       | Version | Description                       | Author |
| ---------- | ------- | --------------------------------- | ------ |
| 2026-01-08 | 1.0     | Initial story draft for Epic 11.6 | Claude |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### File List

**Files to be created by Developer Agent implementing this story:**

**New Files:**

- `packages/connector/src/wallet/agent-channel-manager.ts` - Channel manager implementation
- `packages/connector/src/wallet/agent-channel-manager.test.ts` - Unit tests
- `packages/connector/test/integration/agent-channel-integration.test.ts` - Integration test

**Modified Files:**

- `packages/connector/src/wallet/wallet-db-schema.ts` - Add agent_channels database table
- `packages/shared/src/types/telemetry.ts` - Add channel telemetry event types
- `packages/shared/src/index.ts` - Export new telemetry types

### Completion Notes

**Story Status:** Draft - Ready for implementation

**This section will be filled in by the Developer Agent after implementation is complete.**

### Debug Log

**This section will be used by the Developer Agent to track any implementation issues or blockers encountered.**

## QA Results

**This section will be filled in by the QA Agent after story implementation and review.**
