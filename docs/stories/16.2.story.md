<!-- Powered by BMAD™ Core -->

# Story 16.2: Skill Registry & Built-in Agent Skills

## Status

Done

## Story

**As a** connector operator,
**I want** a skill registry that manages modular AI capabilities mapped to Nostr event kinds, with all built-in skills implemented and tested,
**So that** the AI agent can discover, invoke, and orchestrate event-specific skills through the Vercel AI SDK tool system, with each skill wrapping an existing handler as an AI SDK tool with a description, Zod schema, and execute function.

## Acceptance Criteria

1. A `SkillRegistry` class manages skill registration with `register()`, `unregister()`, `get()`, `has()`, `getSkillNames()`, and `size` accessors
2. The `AgentSkill<T>` interface defines skills with: `name`, `description`, `parameters` (Zod schema), `execute` function, and optional `eventKinds` array
3. A `SkillExecuteContext` interface extends `EventHandlerContext` with optional `reasoning` field for AI metadata
4. `toTools(context)` converts all registered skills to AI SDK `CoreTool` format compatible with `generateText()`
5. `getSkillsForKind(kind)` returns skills associated with a specific Nostr event kind
6. `getSkillSummary()` returns an array of skill metadata (name, description, eventKinds) for system prompt generation
7. Six built-in skills are implemented: `store_note` (Kind 1), `update_follow` (Kind 3), `delete_events` (Kind 5), `query_events` (Kind 10000), `forward_packet`, and `get_agent_info`
8. Each built-in skill uses a factory pattern (`createXxxSkill()`) and defines parameters with Zod schemas
9. A `registerBuiltInSkills(registry, config)` function registers all built-in skills with a `RegisterSkillsConfig` providing `followGraphRouter`, `registeredKinds`, and optional `queryMaxResults`
10. All skill registry and skill code has unit tests with >80% coverage, plus integration tests verifying end-to-end skill registration and execution

## Tasks / Subtasks

- [x] Task 1: Implement SkillRegistry class (AC: 1, 2, 3, 4, 5, 6)
  - [x] Create `packages/connector/src/agent/ai/skill-registry.ts`
  - [x] Define `SkillExecuteContext` interface extending `EventHandlerContext` with optional `reasoning?: string`
  - [x] Define `AgentSkill<T extends z.ZodTypeAny>` interface with `name`, `description`, `parameters`, `execute`, `eventKinds?`
  - [x] Define `SkillSummary` interface with `name`, `description`, `eventKinds`
  - [x] Implement `SkillRegistry` class with:
    - [x] `register(skill)` — stores skill, throws on duplicate name
    - [x] `unregister(name)` — removes by name, returns boolean
    - [x] `get(name)` — returns skill or undefined
    - [x] `has(name)` — checks existence
    - [x] `getSkillNames()` — returns string array
    - [x] `get size()` — returns count
    - [x] `toTools(context)` — converts all skills to AI SDK `CoreTool` objects using `tool()` from `ai` package
    - [x] `getSkillsForKind(kind)` — filters by `eventKinds` array
    - [x] `getSkillSummary()` — returns `SkillSummary[]`
  - [x] [Source: architecture/ai-agent-skills.md#core-components, architecture/components.md#SkillRegistry]

- [x] Task 2: Implement store_note skill (AC: 7, 8)
  - [x] Create `packages/connector/src/agent/ai/skills/store-note-skill.ts`
  - [x] Define `StoreNoteParams` Zod schema with `reason: z.string()`
  - [x] Implement `createStoreNoteSkill()` factory returning `AgentSkill`
  - [x] Set `eventKinds: [1]` and clear description for AI
  - [x] Execute: store event via `context.database.storeEvent(context.event)`
  - [x] Handle `DatabaseSizeExceededError` with code `'T00'`
  - [x] [Source: architecture/ai-agent-skills.md#skill-anatomy-annotated-example]

- [x] Task 3: Implement update_follow skill (AC: 7, 8)
  - [x] Create `packages/connector/src/agent/ai/skills/update-follow-skill.ts`
  - [x] Define `UpdateFollowParams` Zod schema with `reason: z.string()`
  - [x] Implement `createUpdateFollowSkill(followGraphRouter)` factory
  - [x] Set `eventKinds: [3]`
  - [x] Execute: validate kind === 3, call `followGraphRouter.updateFromFollowEvent(event)`, store event in database
  - [x] [Source: architecture/ai-agent-skills.md#built-in-skills-reference]

- [x] Task 4: Implement delete_events skill (AC: 7, 8)
  - [x] Create `packages/connector/src/agent/ai/skills/delete-events-skill.ts`
  - [x] Define `DeleteEventsParams` Zod schema with `reason: z.string()`
  - [x] Implement `createDeleteEventsSkill()` factory
  - [x] Set `eventKinds: [5]`
  - [x] Execute: validate kind === 5 (NIP-09), extract event IDs from `'e'` tags, verify authorship (only delete if requester is author), call `database.deleteEvents(authorizedIds)`
  - [x] Return success even if no events match (idempotent)
  - [x] [Source: architecture/ai-agent-skills.md#built-in-skills-reference]

- [x] Task 5: Implement query_events skill (AC: 7, 8)
  - [x] Create `packages/connector/src/agent/ai/skills/query-events-skill.ts`
  - [x] Define `QueryEventsParams` Zod schema with `reason: z.string()`
  - [x] Implement `createQueryEventsSkill(queryMaxResults?)` factory
  - [x] Set `eventKinds: [10000]`
  - [x] Execute: validate kind === 10000, parse NIP-01 filter from `event.content` (JSON), apply `maxResults` limit (default 100), return events via `responseEvents`
  - [x] Return error code `'F01'` for malformed filters
  - [x] [Source: architecture/ai-agent-skills.md#built-in-skills-reference]

- [x] Task 6: Implement forward_packet skill (AC: 7, 8)
  - [x] Create `packages/connector/src/agent/ai/skills/forward-packet-skill.ts`
  - [x] Define `ForwardPacketParams` Zod schema with `destinationPubkey: z.string()` and `reason: z.string()`
  - [x] Implement `createForwardPacketSkill(followGraphRouter)` factory
  - [x] No `eventKinds` (universal skill)
  - [x] Execute: if `destinationPubkey === "auto"` use routing table via ILP destination, otherwise look up by Nostr pubkey; return error `'F02'` if no route found
  - [x] Note: In MVP, forwarding is informational — connector routing layer handles actual forwarding
  - [x] [Source: architecture/ai-agent-skills.md#built-in-skills-reference]

- [x] Task 7: Implement get_agent_info skill (AC: 7, 8)
  - [x] Create `packages/connector/src/agent/ai/skills/get-agent-info-skill.ts`
  - [x] Define `GetAgentInfoParams` Zod schema with `reason: z.string()`
  - [x] Implement `createGetAgentInfoSkill(followGraphRouter, registeredKinds)` factory
  - [x] No `eventKinds` (universal skill)
  - [x] Execute: build JSON with `agentPubkey`, `supportedKinds`, `followCount`, `peers` array; return as Kind 10001 response event
  - [x] [Source: architecture/ai-agent-skills.md#built-in-skills-reference]

- [x] Task 8: Create skills registration index (AC: 9)
  - [x] Create `packages/connector/src/agent/ai/skills/index.ts`
  - [x] Define `RegisterSkillsConfig` interface with `followGraphRouter`, `registeredKinds: () => number[]`, `queryMaxResults?: number`
  - [x] Implement `registerBuiltInSkills(registry, config)` that registers all 6 skills
  - [x] Re-export all skill factory functions
  - [x] [Source: architecture/ai-agent-skills.md#step-6-register-the-skill]

- [x] Task 9: Update AI module barrel exports (AC: 1)
  - [x] Ensure `packages/connector/src/agent/ai/index.ts` exports SkillRegistry, skill types, and skills barrel
  - [x] Verify `packages/connector/src/agent/index.ts` re-exports AI module
  - [x] [Source: architecture/source-tree.md — ai/ section]

- [x] Task 10: Write unit tests for SkillRegistry (AC: 10)
  - [x] Create `packages/connector/src/agent/ai/__tests__/skill-registry.test.ts`
    - [x] Test `register()` — single skill, multiple skills
    - [x] Test duplicate name rejection (throws error)
    - [x] Test `unregister()` — removes skill, returns false for non-existent
    - [x] Test `get()` — returns skill or undefined
    - [x] Test `has()` — checks existence
    - [x] Test `getSkillNames()` — returns all names
    - [x] Test `getSkillsForKind()` — filters by event kind, returns empty for unknown kinds
    - [x] Test `getSkillSummary()` — returns metadata array with name, description, eventKinds
    - [x] Test `toTools(context)` — converts skills to AI SDK `CoreTool` format with correct structure
  - [x] [Source: architecture/test-strategy-and-standards.md#unit-tests]

- [x] Task 11: Write integration tests for skills (AC: 10)
  - [x] Create or extend `packages/connector/src/agent/ai/__tests__/integration.test.ts`
    - [x] Test all 6 skills register successfully via `registerBuiltInSkills()`
    - [x] Test skills are associated with correct event kinds (Kind 1 → store_note, Kind 3 → update_follow, Kind 5 → delete_events, Kind 10000 → query_events)
    - [x] Test `store_note` skill execution (stores event, handles DB errors)
    - [x] Test `query_events` skill execution (valid and malformed filters)
    - [x] Test `delete_events` skill execution (authorship verification)
    - [x] Test `get_agent_info` skill execution (returns correct metadata)
    - [x] Test `forward_packet` skill execution (route finding and route-not-found)
    - [x] Test `update_follow` skill execution (updates routing table)
  - [x] All tests follow AAA pattern, mock external dependencies
  - [x] [Source: architecture/test-strategy-and-standards.md#unit-tests]

## Dev Notes

### Previous Story Insights (from Story 16.1)

- Story 16.1 completed AI SDK Foundation & Provider Factory
- AI config types (`AIAgentConfig`, `AIYamlConfig`, etc.) are defined in `packages/connector/src/agent/ai/ai-agent-config.ts`
- Provider factory dynamically imports `@ai-sdk/*` packages via `createModelFromConfig()`
- AI config is parsed and validated through `AgentConfigLoader` and passed to `AgentNode`
- Pre-existing code on the `epic-16` branch includes the full skill registry and all built-in skills — the dev agent should evaluate this code against the ACs and validate, enhance, or rewrite as needed
- Two pre-existing test failures are unrelated to AI code: `profiler.test.ts` (timing flake) and `wallet-derivation.test.ts` (integration timeout)

[Source: docs/stories/16.1.story.md#dev-agent-record]

### Data Models

**AgentSkill interface:**

```typescript
interface AgentSkill<T extends z.ZodTypeAny = z.ZodTypeAny> {
  name: string; // Unique skill name (used as AI SDK tool name)
  description: string; // AI-readable description of when/how to use skill
  parameters: T; // Zod schema for AI-provided parameters
  execute: (params: z.infer<T>, context: SkillExecuteContext) => Promise<EventHandlerResult>;
  eventKinds?: number[]; // Nostr event kinds this skill handles
}
```

**SkillExecuteContext interface:**

```typescript
interface SkillExecuteContext extends EventHandlerContext {
  reasoning?: string; // AI reasoning for invoking this skill
}
```

**EventHandlerContext interface (base from event-handler.ts):**

```typescript
interface EventHandlerContext {
  event: NostrEvent; // Incoming Nostr event
  packet: ILPPreparePacket; // Original ILP packet
  amount: bigint; // Payment amount
  source: string; // Source peer identifier
  agentPubkey: string; // This agent's Nostr pubkey
  database: AgentEventDatabase; // Database reference
}
```

**EventHandlerResult interface (from event-handler.ts):**

```typescript
interface EventHandlerResult {
  success: boolean;
  responseEvent?: NostrEvent; // Single response
  responseEvents?: NostrEvent[]; // Multiple responses
  error?: { code: string; message: string };
}
```

**SkillSummary interface:**

```typescript
interface SkillSummary {
  name: string; // Skill name
  description: string; // AI-readable description
  eventKinds?: number[]; // Associated Nostr event kinds
}
```

**RegisterSkillsConfig interface:**

```typescript
interface RegisterSkillsConfig {
  followGraphRouter: FollowGraphRouter;
  registeredKinds: () => number[];
  queryMaxResults?: number; // Default: 100
}
```

[Source: architecture/components.md#SkillRegistry, architecture/ai-agent-skills.md#core-components, packages/connector/src/agent/event-handler.ts]

### API Specifications

**SkillRegistry class API:**

- `register(skill: AgentSkill): void` — throws on duplicate name
- `unregister(name: string): boolean` — returns false if not found
- `get(name: string): AgentSkill | undefined`
- `has(name: string): boolean`
- `getSkillNames(): string[]`
- `get size(): number`
- `toTools(context: SkillExecuteContext): Record<string, CoreTool>` — converts all skills to AI SDK tools using `tool()` from `ai` package. Each tool wraps the skill's `execute()` with the Zod `parameters` schema.
- `getSkillsForKind(kind: number): AgentSkill[]` — filters skills by `eventKinds` array
- `getSkillSummary(): SkillSummary[]` — returns `{ name, description, eventKinds }` for each skill

**Built-in Skills:**

| Skill Name       | Event Kind(s) | Factory Function                                              | Dependencies                                |
| ---------------- | ------------- | ------------------------------------------------------------- | ------------------------------------------- |
| `store_note`     | [1]           | `createStoreNoteSkill()`                                      | None (uses context.database)                |
| `update_follow`  | [3]           | `createUpdateFollowSkill(followGraphRouter)`                  | FollowGraphRouter                           |
| `delete_events`  | [5]           | `createDeleteEventsSkill()`                                   | None (uses context.database)                |
| `query_events`   | [10000]       | `createQueryEventsSkill(maxResults?)`                         | None (uses context.database)                |
| `forward_packet` | —             | `createForwardPacketSkill(followGraphRouter)`                 | FollowGraphRouter                           |
| `get_agent_info` | —             | `createGetAgentInfoSkill(followGraphRouter, registeredKinds)` | FollowGraphRouter, registeredKinds callback |

**ILP Error Codes used by skills:**

- `F01` — Invalid packet / malformed filter (query_events)
- `F02` — Unreachable / no route found (forward_packet)
- `F99` — Application error / unsupported kind
- `T00` — Temporary failure / storage limit exceeded (store_note)
- `T03` — Connector busy

[Source: architecture/components.md#SkillRegistry, architecture/ai-agent-skills.md#built-in-skills-reference]

### File Locations

| File                                                               | Purpose                                                                 |
| ------------------------------------------------------------------ | ----------------------------------------------------------------------- |
| `packages/connector/src/agent/ai/skill-registry.ts`                | Create — SkillRegistry class, AgentSkill interface, SkillExecuteContext |
| `packages/connector/src/agent/ai/skills/index.ts`                  | Create — registerBuiltInSkills(), RegisterSkillsConfig, re-exports      |
| `packages/connector/src/agent/ai/skills/store-note-skill.ts`       | Create — Kind 1 store note skill                                        |
| `packages/connector/src/agent/ai/skills/update-follow-skill.ts`    | Create — Kind 3 follow update skill                                     |
| `packages/connector/src/agent/ai/skills/delete-events-skill.ts`    | Create — Kind 5 event deletion skill                                    |
| `packages/connector/src/agent/ai/skills/query-events-skill.ts`     | Create — Kind 10000 query events skill                                  |
| `packages/connector/src/agent/ai/skills/forward-packet-skill.ts`   | Create — Packet forwarding skill                                        |
| `packages/connector/src/agent/ai/skills/get-agent-info-skill.ts`   | Create — Agent introspection skill                                      |
| `packages/connector/src/agent/ai/index.ts`                         | Modify — export SkillRegistry, skill types                              |
| `packages/connector/src/agent/ai/__tests__/skill-registry.test.ts` | Create — SkillRegistry unit tests                                       |
| `packages/connector/src/agent/ai/__tests__/integration.test.ts`    | Create — Integration tests for skill registration and execution         |

[Source: architecture/source-tree.md — ai/ section, docs/prd/epic-16-ai-agent-node.md#package-structure]

### Testing Requirements

- **Framework:** Jest 29.7.x with ts-jest
- **Location:** `packages/connector/src/agent/ai/__tests__/` for AI module tests
- **Patterns:** AAA (Arrange, Act, Assert), descriptive test names, mock all external deps
- **Coverage:** >80% line coverage for connector package
- **Key mocks:**
  - `AgentEventDatabase` (mock `storeEvent`, `queryEvents`, `deleteEvents`, `countEvents`)
  - `FollowGraphRouter` (mock `updateFromFollowEvent`, `getKnownAgents`, `getNextHop`)
  - `ILPPreparePacket` (mock with test factory functions)
  - `NostrEvent` (mock with test event builders for each kind)
- **Test isolation:** Fresh mock instances in `beforeEach()`, create fresh `SkillRegistry` per test
- **Critical:** Skills wrap existing handler logic — test the skill's `execute()` function directly, not through the AI dispatcher (dispatcher is Story 16.4)
- **AI SDK tool conversion:** Verify `toTools()` output has correct structure for `generateText()` consumption — each tool should have `description`, `parameters`, and `execute` properties

[Source: architecture/test-strategy-and-standards.md#unit-tests]

### Technical Constraints

- **Zod for parameters:** All skill parameters must use Zod schemas — this is required for AI SDK `tool()` compatibility
- **Factory pattern:** Each skill must use a `createXxxSkill()` factory function (not class instantiation) to allow dependency injection
- **Skill name uniqueness:** Skill names must be unique across the registry — used as tool names in the AI SDK
- **Minimal AI params:** Keep Zod schemas minimal. The AI doesn't need to pass event data (already in context). Typically just a `reason: z.string()` field.
- **No console.log:** Use Pino logger exclusively
- **Error codes:** Use ILP error code conventions (F-prefix for final, T-prefix for temporary, R-prefix for relative)
- **Authorship verification:** The `delete_events` skill must verify that the requester (event.pubkey) is the author of events being deleted — NIP-09 requirement
- **Query result limits:** The `query_events` skill must enforce a `maxResults` limit (default 100) to prevent unbounded query responses
- **Idempotent operations:** Delete and store operations should be idempotent where possible
- **Forward is informational:** In MVP, the `forward_packet` skill is informational — the connector routing layer handles actual packet forwarding
- **Import style:** Use `import type` for type-only imports per TypeScript convention

[Source: architecture/coding-standards.md#critical-rules, architecture/ai-agent-skills.md#skill-anatomy-annotated-example]

### Existing Code Context

**Existing handlers (Epic 13) that skills wrap:**

| Handler             | File                               | Kind  | What it does            |
| ------------------- | ---------------------------------- | ----- | ----------------------- |
| `note-handler.ts`   | `agent/handlers/note-handler.ts`   | 1     | Stores text notes       |
| `follow-handler.ts` | `agent/handlers/follow-handler.ts` | 3     | Updates follow graph    |
| `delete-handler.ts` | `agent/handlers/delete-handler.ts` | 5     | Deletes events (NIP-09) |
| `query-handler.ts`  | `agent/handlers/query-handler.ts`  | 10000 | Queries event database  |

Skills should mirror the logic from these handlers but be self-contained (not call the handler functions directly). The skills access `context.database` and `context.event` to perform operations.

**AgentEventDatabase API (used by skills):**

- `storeEvent(event: NostrEvent): Promise<void>`
- `deleteEvents(eventIds: string[]): Promise<number>` (returns count deleted)
- `queryEvents(filter: NostrFilter): Promise<NostrEvent[]>`
- `countEvents(filter: NostrFilter): Promise<number>`

**FollowGraphRouter API (used by skills):**

- `updateFromFollowEvent(event: NostrEvent): void`
- `getKnownAgents(): Map<string, ILPAddress>`
- `getNextHop(destination: ILPAddress): string | null`

[Source: packages/connector/src/agent/handlers/, packages/connector/src/agent/event-handler.ts, architecture/components.md#AgentEventDatabase]

### Pre-existing Code Warning

**There is uncommitted code on the `epic-16` branch that was written ahead of the formal story process.** The dev agent should evaluate this code against the story requirements:

- **Untracked:** `packages/connector/src/agent/ai/skill-registry.ts` — SkillRegistry class (166 lines)
- **Untracked:** `packages/connector/src/agent/ai/skills/` — all 6 skill files + index.ts (7 files, ~436 lines)
- **Untracked:** `packages/connector/src/agent/ai/__tests__/skill-registry.test.ts` — unit tests (168 lines)
- **Untracked:** `packages/connector/src/agent/ai/__tests__/integration.test.ts` — integration tests (503 lines)

The dev agent may use this code as a starting point if it meets the acceptance criteria, or rewrite as needed. All code must be validated against the ACs regardless of whether it pre-existed.

---

## Change Log

| Date       | Version | Description            | Author |
| ---------- | ------- | ---------------------- | ------ |
| 2026-01-27 | 0.1     | Initial story creation | SM     |

---

## Dev Agent Record (Agent Populates After Execution)

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

No debug log entries — implementation was clean with no blocking issues.

### Completion Notes

- Pre-existing code on `epic-16` branch was evaluated against all 10 ACs and found largely compliant
- Added named `SkillSummary` interface (was inline type before) to match AC 6 and story data model spec
- Added `SkillSummary` and `RegisterSkillsConfig` type exports to barrel files
- Enhanced unit tests: added dedicated `has()`, `size`, and improved `toTools()` structure validation tests (21 total)
- Enhanced integration tests: added `update_follow` execution test, `store_note` DB error test, and `forward_packet` auto-routing test (27 total)
- All 7 AI module test suites pass: 146 tests, 0 failures
- Lint passes clean with no errors
- Pre-existing `memory-profile.test.ts` flake (timing) and `wallet-derivation.test.ts` timeout are unrelated to this story

### File List

| File                                                               | Status    | Purpose                                                                 |
| ------------------------------------------------------------------ | --------- | ----------------------------------------------------------------------- |
| `packages/connector/src/agent/ai/skill-registry.ts`                | Modified  | Added `SkillSummary` interface, updated `getSkillSummary()` return type |
| `packages/connector/src/agent/ai/skills/store-note-skill.ts`       | Validated | Kind 1 store note skill (no changes needed)                             |
| `packages/connector/src/agent/ai/skills/update-follow-skill.ts`    | Validated | Kind 3 follow update skill (no changes needed)                          |
| `packages/connector/src/agent/ai/skills/delete-events-skill.ts`    | Validated | Kind 5 event deletion skill (no changes needed)                         |
| `packages/connector/src/agent/ai/skills/query-events-skill.ts`     | Validated | Kind 10000 query events skill (no changes needed)                       |
| `packages/connector/src/agent/ai/skills/forward-packet-skill.ts`   | Validated | Packet forwarding skill (no changes needed)                             |
| `packages/connector/src/agent/ai/skills/get-agent-info-skill.ts`   | Validated | Agent introspection skill (no changes needed)                           |
| `packages/connector/src/agent/ai/skills/index.ts`                  | Validated | registerBuiltInSkills + re-exports (no changes needed)                  |
| `packages/connector/src/agent/ai/index.ts`                         | Modified  | Added `SkillSummary` and `RegisterSkillsConfig` type exports            |
| `packages/connector/src/agent/index.ts`                            | Modified  | Added `SkillSummary` type re-export                                     |
| `packages/connector/src/agent/ai/__tests__/skill-registry.test.ts` | Modified  | Enhanced with has(), size, and toTools structure tests                  |
| `packages/connector/src/agent/ai/__tests__/integration.test.ts`    | Modified  | Added update_follow, store_note DB error, forward_packet auto tests     |

---

## QA Results

### Review Date: 2026-01-27

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Strong implementation overall. The SkillRegistry and all six built-in skills are well-structured, follow the factory pattern consistently, and integrate cleanly with the Vercel AI SDK `tool()` API. The code is well-documented with JSDoc, follows kebab-case file naming, and uses TypeScript strict mode throughout. All 146 tests pass across 7 test suites with no failures.

Key strengths:

- Clean separation of concerns: registry, individual skills, and registration index are all properly modular
- Consistent factory pattern (`createXxxSkill()`) across all skills with proper dependency injection
- Proper use of Zod schemas for AI SDK tool parameters
- Correct authorship verification in `delete_events` skill (NIP-09 compliance)
- Idempotent delete operations (returns success even when no events match)
- Query result limiting with configurable `maxResults` in `query_events`
- Proper error code conventions (F01, F02, F99, T00)

### Refactoring Performed

None. No code changes made during this review.

### Compliance Check

- Coding Standards: ✓ — Follows kebab-case files, PascalCase classes/interfaces, camelCase functions. No console.log usage. ESLint passes clean.
- Project Structure: ✓ — Files match `architecture/source-tree.md` ai/ section exactly. Barrel exports chain correctly from skills/ → ai/ → agent/.
- Testing Strategy: ✓ — Tests co-located in `__tests__/` directory, use AAA pattern, mock external dependencies, fresh instances per test via `beforeEach()`.
- All ACs Met: ✓ — See traceability matrix below.

### Requirements Traceability

| AC  | Description                                                                       | Implementation                                                        | Test Coverage                                                        |
| --- | --------------------------------------------------------------------------------- | --------------------------------------------------------------------- | -------------------------------------------------------------------- |
| 1   | SkillRegistry with register/unregister/get/has/getSkillNames/size                 | `skill-registry.ts:68-177` — all methods present                      | `skill-registry.test.ts` — 21 tests covering all methods             |
| 2   | AgentSkill\<T\> interface with name, description, parameters, execute, eventKinds | `skill-registry.ts:45-59` — complete interface definition             | Validated via type usage in all skill factories                      |
| 3   | SkillExecuteContext extends EventHandlerContext with reasoning                    | `skill-registry.ts:19-22` — extends with `reasoning?: string`         | Used in test context factories                                       |
| 4   | toTools(context) converts to AI SDK CoreTool format                               | `skill-registry.ts:135-150` — uses `tool()` from `ai` package         | `skill-registry.test.ts` — 4 tests including structure validation    |
| 5   | getSkillsForKind(kind) filters by event kind                                      | `skill-registry.ts:156-165` — iterates and filters by `eventKinds`    | `skill-registry.test.ts` — 2 tests (match and no-match)              |
| 6   | getSkillSummary() returns SkillSummary[]                                          | `skill-registry.ts:170-176` — named SkillSummary interface at line 27 | `skill-registry.test.ts` — 1 test verifying structure                |
| 7   | Six built-in skills implemented                                                   | All 6 skill files in `skills/` directory                              | `integration.test.ts` — registration test confirms 6 skills          |
| 8   | Factory pattern with Zod schemas                                                  | Each skill uses `createXxxSkill()` with Zod `z.object()`              | Each skill tested via factory invocation                             |
| 9   | registerBuiltInSkills(registry, config)                                           | `skills/index.ts:29-39` with RegisterSkillsConfig interface           | `integration.test.ts` — end-to-end registration tests                |
| 10  | Unit tests + integration tests >80% coverage                                      | 21 unit + 27 integration tests = 48 skill-related tests               | All 146 tests pass (includes AI config, system prompt, token budget) |

### Improvements Checklist

- [ ] `forward-packet-skill.ts:36` — Parameter named `_context` but IS used (line 42). Rename to `context` to follow naming conventions (underscore prefix implies unused)
- [ ] `store-note-skill.ts` — Missing kind validation (unlike update_follow, delete_events, query_events which all validate their respective kinds). Consider adding `if (context.event.kind !== 1)` guard for consistency
- [ ] `agent/index.ts` — `RegisterSkillsConfig` type is exported from `ai/index.ts` but not re-exported from the agent barrel. Consider adding for completeness
- [ ] `integration.test.ts` — Worker process force-exit warning suggests potential timer/handle leak. Consider adding `--detectOpenHandles` to diagnose and fix. Low priority as it doesn't affect test results.

### Security Review

No security concerns found. Key security aspects validated:

- **Authorship verification**: `delete_events` skill correctly verifies `event.pubkey` matches original event author before deletion (NIP-09)
- **Query limiting**: `query_events` enforces `maxResults` cap (default 100) to prevent unbounded responses
- **Error handling**: `store_note` handles `DatabaseSizeExceededError` gracefully with T00 error code
- **No injection vectors**: Zod schemas validate all AI-provided parameters; event data comes from pre-validated context
- **No console.log**: All files use proper error returns, no logging (skills are stateless)

### Performance Considerations

No performance concerns found. Key observations:

- `getSkillsForKind()` iterates all skills (O(n)) — acceptable since n=6 and unlikely to grow large
- `toTools()` creates new closures on each call — acceptable since called once per event dispatch
- Query result limiting prevents unbounded database queries

### Files Modified During Review

No files modified.

### Gate Status

Gate: PASS → docs/qa/gates/16.2-skill-registry-built-in-agent-skills.yml

### Recommended Status

✓ Ready for Done — All 10 acceptance criteria are met with thorough test coverage. The 4 unchecked items above are non-blocking improvements that can be addressed in future work.
