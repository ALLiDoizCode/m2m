<!-- Powered by BMAD™ Core -->

# Story 17.2: DVM Job Result Formatter (Kind 6XXX)

## Status

Done

## Story

**As a** connector operator running an AI agent,
**I want** a formatter that creates properly structured NIP-90 DVM job result events (Kind 6XXX),
**So that** the agent can return standardized job results to requesters, ensuring interoperability with the Nostr DVM ecosystem and other NIP-90 compliant clients.

## Acceptance Criteria

1. Formatter creates Kind 6XXX events where kind = request kind + 1000 (e.g., Kind 5000 request → Kind 6000 result)
2. Result includes `request` tag with stringified original request event JSON
3. Result includes `e` tag referencing the request event ID
4. Result includes `p` tag with the requester's pubkey
5. Result includes `amount` tag with actual payment received (from ILP packet, as string)
6. Content field contains the result data (text, JSON string, or other formats)
7. Formatter handles various content types (text, JSON objects, binary as base64)
8. Formatter creates unsigned event template ready for signing with agent's Nostr key
9. Unit tests cover all result formats, tag generation, and error scenarios with >80% branch coverage

## Tasks / Subtasks

- [x] Task 1: Extend DVM types module with result types (AC: 1, 4, 6)
  - [x] Add to `packages/connector/src/agent/dvm/types.ts`
  - [x] Define `DVMResultStatus = 'success' | 'error' | 'partial'` type
  - [x] Define `DVMJobResult` interface with fields: `kind`, `requestEvent`, `content`, `amount`, `status`
  - [x] Define `DVMResultEvent` interface (unsigned Nostr event template)
  - [x] Define `DVM_RESULT_KIND_OFFSET = 1000` constant
  - [x] Export all new types and constants from module
  - [Source: docs/prd/epic-17-nip-90-dvm-compatibility.md#story-172]

- [x] Task 2: Implement DVM job result formatter core (AC: 1, 2, 3, 4, 5, 6, 7, 8)
  - [x] Create `packages/connector/src/agent/dvm/dvm-result-formatter.ts`
  - [x] Import types from `./types.ts` and `NostrEvent` from `../toon-codec`
  - [x] Implement `formatDVMJobResult(result: DVMJobResult): DVMResultEvent` main function
  - [x] Calculate result kind: `result.requestEvent.kind + DVM_RESULT_KIND_OFFSET`
  - [x] Implement `createRequestTag(requestEvent: NostrEvent): string[]` helper
    - [x] Stringify request event JSON: `JSON.stringify(requestEvent)`
    - [x] Return `['request', stringifiedEvent]`
  - [x] Implement `createEventTag(requestEventId: string): string[]` helper
    - [x] Return `['e', requestEventId]` (standard Nostr event reference)
  - [x] Implement `createPubkeyTag(requesterPubkey: string): string[]` helper
    - [x] Return `['p', requesterPubkey]` (standard Nostr pubkey reference)
  - [x] Implement `createAmountTag(amount: bigint): string[]` helper
    - [x] Convert bigint to string: `amount.toString()`
    - [x] Return `['amount', amountString]`
  - [x] Implement `createStatusTag(status: DVMResultStatus): string[]` helper
    - [x] Return `['status', status]`
  - [x] Implement `formatContent(content: string | object | Buffer, status: DVMResultStatus): string` helper
    - [x] If `status === 'error'`: wrap in error object if not already JSON
    - [x] If `content` is object: `JSON.stringify(content)`
    - [x] If `content` is Buffer: convert to base64 string
    - [x] If `content` is string: return as-is
  - [x] Assemble `DVMResultEvent` with all tags and content
  - [x] Set `created_at` to current Unix timestamp (seconds)
  - [x] Leave `id`, `pubkey`, and `sig` empty (to be filled by signing)
  - [Source: docs/architecture/coding-standards.md#typescript-specifics]

- [x] Task 3: Add error result handling (AC: 6, 7)
  - [x] Implement `formatDVMErrorResult(requestEvent: NostrEvent, errorCode: string, errorMessage: string, amount: bigint): DVMResultEvent`
  - [x] Create error content structure: `{ error: true, code: errorCode, message: errorMessage }`
  - [x] Set status to 'error'
  - [x] Reuse core formatting logic from `formatDVMJobResult`
  - [Source: docs/prd/epic-17-nip-90-dvm-compatibility.md#payment-integration-note]

- [x] Task 4: Update DVM module exports (AC: 8)
  - [x] Update `packages/connector/src/agent/dvm/index.ts` barrel file
  - [x] Export types: `DVMJobResult`, `DVMResultEvent`, `DVMResultStatus`, `DVM_RESULT_KIND_OFFSET`
  - [x] Export functions: `formatDVMJobResult`, `formatDVMErrorResult`
  - [Source: docs/architecture/source-tree.md — agent/dvm/ section]

- [x] Task 5: Write unit tests for DVM result formatter (AC: 9)
  - [x] Create `packages/connector/src/agent/dvm/__tests__/dvm-result-formatter.test.ts`
  - [x] Test Kind calculation (5000 → 6000, 5100 → 6100, 5900 → 6900)
  - [x] Test `request` tag contains valid stringified JSON of original request
  - [x] Test `e` tag contains correct request event ID
  - [x] Test `p` tag contains correct requester pubkey
  - [x] Test `amount` tag contains bigint converted to string
  - [x] Test `status` tag for success, error, partial values
  - [x] Test content formatting for plain text
  - [x] Test content formatting for JSON object (serialization)
  - [x] Test content formatting for Buffer (base64 encoding)
  - [x] Test error result formatting with error code and message
  - [x] Test `created_at` is set to reasonable Unix timestamp
  - [x] Test that `id`, `pubkey`, `sig` are empty strings (unsigned)
  - [x] **Edge case tests:**
    - [x] Test empty string content
    - [x] Test large content (near 64KB)
    - [x] Test Unicode content (emojis, CJK characters)
    - [x] Test deeply nested JSON object serialization
    - [x] Test zero amount (0n)
    - [x] Test very large amount (max safe bigint)
  - [x] All tests follow AAA pattern with clear descriptions
  - [x] Run coverage: `npx jest --coverage --collectCoverageFrom='src/agent/dvm/**/*.ts' dvm-result-formatter.test.ts`
  - [x] Verify >80% branch coverage on result formatter source files
  - [Source: docs/architecture/test-strategy-and-standards.md#unit-tests]

- [x] Task 6: Run full test suite and validate (AC: 1-9)
  - [x] Run DVM result formatter tests: `npx jest dvm-result-formatter.test.ts`
  - [x] Verify all tests pass
  - [x] Run full connector test suite: `npm test` from `packages/connector`
  - [x] Verify no regressions in existing tests (including parser tests from 17.1)
  - [x] Document any test failures and fixes
  - [Source: docs/architecture/test-strategy-and-standards.md]

## Dev Notes

### Previous Story Insights (from Story 17.1)

- **Story 17.1** (DVM Job Request Parser): Established DVM module structure at `packages/connector/src/agent/dvm/`. Created `types.ts` with `DVMJobRequest`, `DVMInput`, `DVMParseError` types. Created `dvm-job-parser.ts` with `parseDVMJobRequest()` function. Test helper pattern `createDVMJobEvent()` established for generating test Nostr events. 100% branch coverage achieved. [Source: docs/stories/17.1.story.md#dev-agent-record]

- **Parser module patterns**: Synchronous pure functions, no side effects, typed errors with codes, event reference preservation. These patterns should be followed for the formatter. [Source: packages/connector/src/agent/dvm/dvm-job-parser.ts]

### Data Models

**DVMJobResult interface (input to formatter):**

```typescript
interface DVMJobResult {
  /** Result kind will be calculated as requestEvent.kind + 1000 */
  kind?: number; // Optional, calculated if not provided
  /** Original request event (required for tags and kind calculation) */
  requestEvent: NostrEvent;
  /** Result content (string, object, or Buffer) */
  content: string | object | Buffer;
  /** Payment amount received from ILP packet */
  amount: bigint;
  /** Result status */
  status: DVMResultStatus;
}
```

[Source: docs/prd/epic-17-nip-90-dvm-compatibility.md#story-172]

**DVMResultStatus type:**

```typescript
type DVMResultStatus = 'success' | 'error' | 'partial';
```

[Source: docs/prd/epic-17-nip-90-dvm-compatibility.md#story-172]

**DVMResultEvent interface (output from formatter, unsigned):**

```typescript
interface DVMResultEvent {
  /** Empty string - to be filled after signing */
  id: string;
  /** Empty string - to be filled with agent pubkey before signing */
  pubkey: string;
  /** Calculated kind (request kind + 1000) */
  kind: number;
  /** Unix timestamp in seconds */
  created_at: number;
  /** Result content (may be JSON string, plain text, or base64) */
  content: string;
  /** Tags array with request, e, p, amount, status */
  tags: string[][];
  /** Empty string - to be filled after signing */
  sig: string;
}
```

[Source: packages/connector/src/agent/toon-codec.ts — NostrEvent interface]

**DVM_RESULT_KIND_OFFSET constant:**

```typescript
const DVM_RESULT_KIND_OFFSET = 1000;
// Kind 5000 request → Kind 6000 result
// Kind 5100 request → Kind 6100 result
// Kind 5900 request → Kind 6900 result
```

[Source: docs/prd/epic-17-nip-90-dvm-compatibility.md#kind-allocation]

### API Specifications

**NIP-90 Job Result Event Structure:**

Per NIP-90 specification, job results must include:

| Tag       | Format                               | Description                           | Required |
| --------- | ------------------------------------ | ------------------------------------- | -------- |
| `request` | `['request', '<stringified-event>']` | Original request event as JSON string | Yes      |
| `e`       | `['e', '<request-event-id>']`        | Reference to request event            | Yes      |
| `p`       | `['p', '<requester-pubkey>']`        | Requester's public key                | Yes      |
| `amount`  | `['amount', '<msat-amount>']`        | Payment amount in millisatoshis       | Yes      |
| `status`  | `['status', '<status>']`             | Result status (success/error/partial) | Optional |

[Source: NIP-90 specification — https://nips.nostr.com/90]

**Content Field Formats:**

| Content Type | Formatter Handling             | Example                                       |
| ------------ | ------------------------------ | --------------------------------------------- |
| String       | Pass through unchanged         | `"Hello, world!"`                             |
| Object       | JSON.stringify()               | `{"result": "translated text"}`               |
| Buffer       | Convert to base64              | `"SGVsbG8gV29ybGQ="`                          |
| Error        | JSON object with error details | `{"error":true,"code":"F99","message":"..."}` |

[Source: docs/prd/epic-17-nip-90-dvm-compatibility.md#story-172]

### Example DVM Job Result Events

**Success Result (Kind 6000 - General Query Response):**

```json
{
  "id": "",
  "pubkey": "",
  "kind": 6000,
  "created_at": 1706400100,
  "content": "{\"price\":\"42000.00\",\"currency\":\"USD\"}",
  "tags": [
    ["request", "{\"id\":\"abc123...\",\"pubkey\":\"def456...\",\"kind\":5000,...}"],
    ["e", "abc123..."],
    ["p", "def456..."],
    ["amount", "5000"],
    ["status", "success"]
  ],
  "sig": ""
}
```

**Error Result (Kind 6000 - Query Error):**

```json
{
  "id": "",
  "pubkey": "",
  "kind": 6000,
  "created_at": 1706400100,
  "content": "{\"error\":true,\"code\":\"F99\",\"message\":\"Query execution failed\"}",
  "tags": [
    ["request", "{\"id\":\"abc123...\",\"pubkey\":\"def456...\",\"kind\":5000,...}"],
    ["e", "abc123..."],
    ["p", "def456..."],
    ["amount", "5000"],
    ["status", "error"]
  ],
  "sig": ""
}
```

**Translation Result (Kind 6100):**

```json
{
  "id": "",
  "pubkey": "",
  "kind": 6100,
  "created_at": 1706400100,
  "content": "Hola, ¿cómo estás?",
  "tags": [
    ["request", "{\"id\":\"xyz789...\",\"pubkey\":\"abc123...\",\"kind\":5100,...}"],
    ["e", "xyz789..."],
    ["p", "abc123..."],
    ["amount", "10000"],
    ["status", "success"]
  ],
  "sig": ""
}
```

**Partial Result (Kind 6200 - Summarization Partial):**

```json
{
  "id": "",
  "pubkey": "",
  "kind": 6200,
  "created_at": 1706400100,
  "content": "Partial summary available...",
  "tags": [
    ["request", "{...}"],
    ["e", "eventid..."],
    ["p", "pubkey..."],
    ["amount", "3000"],
    ["status", "partial"]
  ],
  "sig": ""
}
```

### File Locations

| File                                                                      | Purpose                                              |
| ------------------------------------------------------------------------- | ---------------------------------------------------- |
| `packages/connector/src/agent/dvm/types.ts`                               | Modify — Add DVMJobResult, DVMResultEvent types      |
| `packages/connector/src/agent/dvm/dvm-result-formatter.ts`                | Create — DVM job result formatter implementation     |
| `packages/connector/src/agent/dvm/index.ts`                               | Modify — Export result formatter types and functions |
| `packages/connector/src/agent/dvm/__tests__/dvm-result-formatter.test.ts` | Create — Result formatter unit tests                 |

[Source: docs/architecture/source-tree.md — agent/dvm/ section, docs/prd/epic-17-nip-90-dvm-compatibility.md#package-structure]

### Testing Requirements

- **Framework:** Jest 29.7.x with ts-jest
- **Location:** `packages/connector/src/agent/dvm/__tests__/` for DVM module tests
- **Patterns:** AAA (Arrange, Act, Assert), descriptive test names
- **Coverage:** >80% branch coverage for formatter functions
- **Test Data:** Reuse `createDVMJobEvent()` helper from parser tests for request events
- **Mocking:** No external dependencies to mock — pure formatting logic
- **Validation:** Test both positive (valid results) and edge cases

**Test Helper Function (extend from 17.1):**

```typescript
function createDVMJobResult(overrides?: Partial<DVMJobResult>): DVMJobResult {
  const requestEvent = createDVMJobEvent();
  return {
    requestEvent,
    content: 'Test result content',
    amount: 5000n,
    status: 'success',
    ...overrides,
  };
}
```

[Source: docs/architecture/test-strategy-and-standards.md#unit-tests]

### Technical Constraints

- **Kind calculation:** Result kind = request kind + 1000 (e.g., 5000 → 6000)
- **Amount as string:** The `amount` tag value must be a string representation of bigint
- **JSON stringification:** Request event must be valid JSON when stringified
- **Unsigned output:** The formatter returns an unsigned event template; signing happens separately
- **No async operations:** Formatter is synchronous — no network calls or database access
- **Buffer handling:** Binary content should be encoded as base64 string
- **Error content structure:** Error results must have `{ error: true, code, message }` structure
- **Type safety:** Use TypeScript strict types, avoid `any`
- **No console.log:** Use Pino logger if logging is needed (unlikely in pure formatter)

[Source: docs/architecture/coding-standards.md#critical-rules, docs/architecture/tech-stack.md]

### Existing Code Context

**NostrEvent type (from toon-codec.ts):**

```typescript
interface NostrEvent {
  id: string; // 64-char hex event ID (empty for unsigned)
  pubkey: string; // 64-char hex author pubkey (empty for unsigned)
  kind: number; // Event kind integer
  created_at: number; // Unix timestamp in seconds
  content: string; // Event content
  tags: string[][]; // Array of tag arrays
  sig: string; // 128-char hex signature (empty for unsigned)
}
```

[Source: packages/connector/src/agent/toon-codec.ts]

**Existing DVM types (from types.ts):**

```typescript
const DVM_KIND_RANGE = { min: 5000, max: 5999 };
type DVMInputType = 'text' | 'url' | 'event' | 'job';
interface DVMInput { data: string; type: DVMInputType; relay?: string; marker?: string; }
interface DVMJobRequest { kind: number; inputs: DVMInput[]; ... }
```

[Source: packages/connector/src/agent/dvm/types.ts]

### Integration Notes

This story creates the result formatting capability for DVM job responses. The formatter output (`DVMResultEvent`) will be consumed by:

- **Story 17.4** (Migrate Query Handler) — Format Kind 6000 responses
- **Story 17.7** (Task Delegation Result) — Format Kind 6900 responses

The formatter does NOT handle:

- Event signing (signing is separate, see below)
- Job feedback events (Story 17.3)
- Payment validation (uses existing `EventHandler._validatePayment()`)

**Event Signing Pattern (for reference):**

The unsigned `DVMResultEvent` will be signed by the consuming code (e.g., AgentServer) using nostr-tools. The codebase currently uses `getPublicKey` from nostr-tools; event signing will use either:

- `finalizeEvent` (nostr-tools recommended API), or
- Manual signing with `getEventHash` + `schnorr.sign`

```typescript
import { finalizeEvent } from 'nostr-tools';

// After formatting:
const unsignedEvent = formatDVMJobResult(result);
unsignedEvent.pubkey = agentPubkey;

// Sign with agent's private key:
const signedEvent = finalizeEvent(unsignedEvent, Buffer.from(agentPrivkey, 'hex'));
```

**Note:** Event signing implementation is deferred to the story that integrates the formatter (Story 17.4 or later). This formatter's responsibility is only to produce a valid unsigned event structure.

[Source: packages/connector/package.json — nostr-tools 2.10.0 dependency]

---

## Change Log

| Date       | Version | Description                                                        | Author |
| ---------- | ------- | ------------------------------------------------------------------ | ------ |
| 2026-01-28 | 0.1     | Initial story creation                                             | SM     |
| 2026-01-28 | 0.2     | Added edge case tests, QA Results section, clarified signing notes | PO     |

---

## Dev Agent Record (Agent Populates After Execution)

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

None - no blocking issues encountered during implementation.

### Completion Notes

- **All tasks completed successfully** - All 6 tasks and their subtasks have been implemented and verified.
- **100% test coverage achieved** - The DVM result formatter has 100% statement, branch, function, and line coverage.
- **39 tests pass** covering kind calculation, all tag types, content formatting (text, JSON, Buffer/base64), error handling, timestamps, and unsigned event fields.
- **No regressions** - Parser tests from Story 17.1 still pass (41 tests). Full test suite shows 2669 tests passing.
- **Pre-existing failures noted** - 5 test failures exist in performance/throughput tests (`throughput-benchmark.test.ts`, `agent-wallet-uniqueness.test.ts`, `wallet-derivation.test.ts`) due to machine performance timing thresholds. These are unrelated to Story 17.2 changes.
- **Implementation follows patterns from Story 17.1** - Synchronous pure functions, no side effects, TypeScript strict types.

### File List

| File                                                                      | Status   | Purpose                                                                                     |
| ------------------------------------------------------------------------- | -------- | ------------------------------------------------------------------------------------------- |
| `packages/connector/src/agent/dvm/types.ts`                               | Modified | Added `DVM_RESULT_KIND_OFFSET`, `DVMResultStatus`, `DVMJobResult`, `DVMResultEvent` types   |
| `packages/connector/src/agent/dvm/dvm-result-formatter.ts`                | Created  | DVM job result formatter with `formatDVMJobResult()` and `formatDVMErrorResult()` functions |
| `packages/connector/src/agent/dvm/index.ts`                               | Modified | Added exports for result formatter types and functions                                      |
| `packages/connector/src/agent/dvm/__tests__/dvm-result-formatter.test.ts` | Created  | 39 unit tests covering all acceptance criteria and edge cases                               |

---

## QA Results (QA Agent Populates After Review)

### Review Date: 2026-01-28

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Excellent implementation.** The DVM job result formatter follows the established patterns from Story 17.1 (parser) with clean, synchronous, pure functions. The code demonstrates strong adherence to TypeScript best practices and NIP-90 specification requirements.

**Strengths:**

- **Pure functions with no side effects** - All helper functions (`createRequestTag`, `createEventTag`, etc.) are stateless and testable
- **TypeScript strict types** - No `any` types, proper use of interfaces (`DVMJobResult`, `DVMResultEvent`, `DVMResultStatus`)
- **Clear separation of concerns** - Content formatting logic isolated in `formatContent()` helper
- **Consistent patterns** - Follows the module structure and naming conventions from Story 17.1
- **Well-documented** - JSDoc comments explain function purposes and parameters

**Implementation Quality:**

- `dvm-result-formatter.ts`: 172 lines, well-structured with 7 functions
- `types.ts`: Extended cleanly with 4 new exports (`DVM_RESULT_KIND_OFFSET`, `DVMResultStatus`, `DVMJobResult`, `DVMResultEvent`)
- Module barrel file properly updated with all exports

### Refactoring Performed

No refactoring was necessary. The implementation is clean and follows project coding standards.

### Compliance Check

- Coding Standards: ✓ Follows naming conventions, no console.log, TypeScript strict mode
- Project Structure: ✓ Files in correct locations per source-tree.md
- Testing Strategy: ✓ >80% branch coverage achieved (100%), AAA pattern followed, edge cases covered
- All ACs Met: ✓ All 9 acceptance criteria fully implemented and tested

### Requirements Traceability

| AC# | Acceptance Criteria                         | Test Coverage                                                    | Status |
| --- | ------------------------------------------- | ---------------------------------------------------------------- | ------ |
| 1   | Kind 6XXX calculation (request kind + 1000) | 3 tests (5000→6000, 5100→6100, 5900→6900)                        | ✓      |
| 2   | `request` tag with stringified JSON         | 2 tests (valid JSON, all fields preserved)                       | ✓      |
| 3   | `e` tag with request event ID               | 1 test (correct ID)                                              | ✓      |
| 4   | `p` tag with requester pubkey               | 1 test (correct pubkey)                                          | ✓      |
| 5   | `amount` tag as string                      | 3 tests (normal, zero, large bigint)                             | ✓      |
| 6   | Content field with result data              | 5 tests (text, empty, Unicode, CJK, large)                       | ✓      |
| 7   | Content type handling (text/JSON/Buffer)    | 7 tests (plain text, JSON, nested, array, Buffer, binary, empty) | ✓      |
| 8   | Unsigned event template                     | 3 tests (empty id, pubkey, sig)                                  | ✓      |
| 9   | Unit tests >80% branch coverage             | 39 tests, 100% coverage on formatter                             | ✓      |

### Improvements Checklist

All items addressed satisfactorily:

- [x] Kind calculation implemented correctly
- [x] All required NIP-90 tags generated
- [x] Content type formatting handles all cases
- [x] Error result convenience function provided
- [x] Unsigned event fields properly initialized
- [x] 100% test coverage achieved
- [x] Edge cases thoroughly tested (Unicode, large content, bigint limits)

### Security Review

**Status: PASS**

No security concerns identified:

- Pure formatting functions with no I/O operations
- No user input validation required (consumed by internal code)
- No secrets or sensitive data handling
- Content is passed through without interpretation (safe)
- JSON stringification is safe for untrusted data

### Performance Considerations

**Status: PASS**

- Synchronous operations only (no async overhead)
- Single-pass content formatting (O(n) for content length)
- No memory leaks - no event listeners or timers
- Buffer.isBuffer() check is efficient native method
- JSON.stringify() is efficient for typical result sizes

### Files Modified During Review

None - no modifications required.

### Gate Status

Gate: **PASS** → docs/qa/gates/17.2-dvm-job-result-formatter.yml

### Recommended Status

**✓ Ready for Done**

All acceptance criteria met with 100% test coverage. Implementation follows established patterns and coding standards. No issues identified.
