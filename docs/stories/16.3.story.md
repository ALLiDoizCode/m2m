<!-- Powered by BMAD™ Core -->

# Story 16.3: System Prompt & Agent Personality

## Status

Draft

## Story

**As a** connector operator,
**I want** a system prompt builder that constructs dynamic, context-aware prompts incorporating agent personality, available skills, protocol context, and per-request event details,
**So that** the AI agent has a well-defined identity, clear decision framework, and full event context for each request, enabling intelligent and consistent event handling through the Vercel AI SDK.

## Acceptance Criteria

1. A `SystemPromptBuilder` class constructs system prompts with sections for Identity, Protocol Context, Available Skills, Decision Framework, Instructions, and Current Event
2. The `build(context: PromptContext)` method returns a complete system prompt string combining static sections with dynamic per-request event context
3. The `buildStatic()` method returns only the static portion (Identity, Protocol Context, Skills, Decision Framework, Instructions) for token counting or caching purposes
4. Agent personality is configurable via `AIAgentPersonality` (name, role, instructions) with sensible defaults ("AI Agent", "ILP connector and Nostr event relay")
5. The Available Skills section is dynamically generated from `SkillRegistry.getSkillSummary()`, listing each skill with its name, associated event kinds, and description
6. The Decision Framework section provides clear rules for skill selection: kind-matching first, forwarding second, rejection with explanation for unsupported kinds
7. The Current Event section includes event kind, author pubkey, event ID, created_at timestamp (ISO format), source peer, payment amount, ILP destination, content preview (truncated at 500 chars), and tags summary (first 10 tags)
8. The `PromptContext` interface defines the dynamic context fields: event (NostrEvent), source (string), amount (bigint), destination (string)
9. All system prompt builder code has unit tests with >80% coverage covering identity defaults, personality overrides, skill listing, event context formatting, content truncation, and tags summary
10. The static prompt portion stays concise and well-structured to minimize token usage

## Tasks / Subtasks

- [ ] Task 1: Validate pre-existing SystemPromptBuilder implementation (AC: 1, 2, 3, 4, 5, 6, 7, 8, 10)
  - [ ] Read and evaluate `packages/connector/src/agent/ai/system-prompt.ts` against all acceptance criteria
  - [ ] Verify `PromptContext` interface includes all required fields: `event` (NostrEvent), `source` (string), `amount` (bigint), `destination` (string)
  - [ ] Verify `SystemPromptBuilder` constructor accepts `agentPubkey`, `ilpAddress?`, `personality?`, `skillRegistry`
  - [ ] Verify `build(context)` returns complete prompt with all sections: Identity, Protocol Context, Available Skills, Decision Framework, Instructions (if configured), Current Event
  - [ ] Verify `buildStatic()` returns prompt WITHOUT Current Event section
  - [ ] Verify Identity section uses personality `name` and `role` with defaults ("AI Agent", "ILP connector and Nostr event relay")
  - [ ] Verify Available Skills section calls `skillRegistry.getSkillSummary()` and formats each skill with name, event kinds, and description
  - [ ] Verify Decision Framework includes kind-matching, forwarding, and rejection rules
  - [ ] Verify Current Event section includes: kind, author pubkey, event ID, created_at (ISO), source, amount, destination, content preview (truncated at 500 chars), tags summary (first 10)
  - [ ] Verify ILP address is included in Identity when provided, omitted when not
  - [ ] Make any necessary fixes or enhancements to meet ACs
  - [ ] [Source: docs/prd/epic-16-ai-agent-node.md#architecture, architecture/ai-agent-skills.md#core-components]

- [ ] Task 2: Verify barrel exports for SystemPromptBuilder (AC: 1, 8)
  - [ ] Verify `packages/connector/src/agent/ai/index.ts` exports `SystemPromptBuilder` class
  - [ ] Verify `PromptContext` type is exported (add if missing)
  - [ ] Verify `packages/connector/src/agent/index.ts` re-exports relevant types
  - [ ] [Source: architecture/source-tree.md — ai/ section]

- [ ] Task 3: Validate pre-existing unit tests (AC: 9)
  - [ ] Read and evaluate `packages/connector/src/agent/ai/__tests__/system-prompt.test.ts`
  - [ ] Verify tests cover identity defaults (uses "AI Agent" when no personality)
  - [ ] Verify tests cover personality overrides (name, role, instructions)
  - [ ] Verify tests cover skill listing from registry
  - [ ] Verify tests cover event context formatting (kind, pubkey, source, amount, destination)
  - [ ] Verify tests cover content truncation at 500 characters
  - [ ] Verify tests cover tags summary (shows first 10 tags, total count)
  - [ ] Verify tests cover `buildStatic()` excludes event context
  - [ ] Add missing test cases if any AC is not covered:
    - [ ] Test ILP address included when provided
    - [ ] Test ILP address omitted when not provided
    - [ ] Test empty content handling (no Content line when content is empty)
    - [ ] Test amount formatting (bigint to string)
    - [ ] Test ISO date formatting of created_at
    - [ ] Test tags truncation when > 10 tags (ellipsis indicator)
    - [ ] Test multiple skills listed in Available Skills section
    - [ ] Test Decision Framework contains all 5 rules
    - [ ] Test protocol context mentions Nostr and ILP
  - [ ] Ensure all tests follow AAA pattern with descriptive test names
  - [ ] [Source: architecture/test-strategy-and-standards.md#unit-tests]

- [ ] Task 4: Run tests and verify coverage (AC: 9)
  - [ ] Run `npx jest system-prompt.test.ts --coverage` from `packages/connector`
  - [ ] Verify >80% line coverage for `system-prompt.ts`
  - [ ] Fix any failing tests
  - [ ] [Source: architecture/test-strategy-and-standards.md#unit-tests]

## Dev Notes

### Previous Story Insights (from Story 16.2)

- Story 16.2 completed the Skill Registry & Built-in Agent Skills
- `SkillRegistry` class is implemented at `packages/connector/src/agent/ai/skill-registry.ts` with `getSkillSummary()` returning `SkillSummary[]` (name, description, eventKinds)
- All 6 built-in skills are registered and tested (store_note, update_follow, delete_events, query_events, forward_packet, get_agent_info)
- `SkillSummary` and `RegisterSkillsConfig` types are exported from AI barrel
- Pre-existing code on the `epic-16` branch includes `system-prompt.ts` and `system-prompt.test.ts` — the dev agent should evaluate this code against the ACs and validate, enhance, or rewrite as needed
- Two pre-existing test failures are unrelated to AI code: `profiler.test.ts` (timing flake) and `wallet-derivation.test.ts` (integration timeout)

[Source: docs/stories/16.2.story.md#dev-agent-record]

### Data Models

**PromptContext interface:**

```typescript
interface PromptContext {
  /** The incoming Nostr event */
  event: NostrEvent;
  /** Source peer identifier */
  source: string;
  /** Payment amount */
  amount: bigint;
  /** ILP destination address */
  destination: string;
}
```

[Source: packages/connector/src/agent/ai/system-prompt.ts:19-28]

**AIAgentPersonality interface (from Story 16.1):**

```typescript
interface AIAgentPersonality {
  name?: string; // Default: "AI Agent"
  role?: string; // Default: "ILP connector and Nostr event relay"
  instructions?: string;
}
```

[Source: packages/connector/src/agent/ai/ai-agent-config.ts]

**SkillSummary interface (from Story 16.2):**

```typescript
interface SkillSummary {
  name: string;
  description: string;
  eventKinds?: number[];
}
```

[Source: packages/connector/src/agent/ai/skill-registry.ts]

**NostrEvent interface (from toon-codec.ts):**

```typescript
interface NostrEvent {
  id: string;
  pubkey: string;
  created_at: number; // Unix timestamp
  kind: number;
  tags: string[][];
  content: string;
  sig: string;
}
```

[Source: packages/connector/src/agent/toon-codec.ts]

### API Specifications

**SystemPromptBuilder class:**

Constructor config:

```typescript
{
  agentPubkey: string;       // This agent's Nostr pubkey
  ilpAddress?: string;       // Optional ILP address
  personality?: AIAgentPersonality;  // Optional personality config
  skillRegistry: SkillRegistry;     // Registry with registered skills
}
```

Methods:

- `build(context: PromptContext): string` — Full system prompt with all sections + event context
- `buildStatic(): string` — Static sections only (for token counting/caching)

**System prompt sections (in order):**

1. **Identity** — Agent name, role, pubkey, ILP address
2. **Protocol Context** — Nostr events in ILP packets, processing steps, known event kinds
3. **Available Skills** — Dynamically generated from `skillRegistry.getSkillSummary()`
4. **Decision Framework** — 5 rules for skill selection priority
5. **Instructions** — Custom personality instructions (only if configured)
6. **Current Event** — Dynamic per-request event details (only in `build()`, not `buildStatic()`)

[Source: architecture/ai-agent-skills.md#core-components, architecture/components.md#AIAgentDispatcher]

### File Locations

| File                                                              | Purpose                                                       |
| ----------------------------------------------------------------- | ------------------------------------------------------------- |
| `packages/connector/src/agent/ai/system-prompt.ts`                | Validate — SystemPromptBuilder class, PromptContext interface |
| `packages/connector/src/agent/ai/index.ts`                        | Verify — SystemPromptBuilder and PromptContext exports        |
| `packages/connector/src/agent/index.ts`                           | Verify — re-exports from AI module                            |
| `packages/connector/src/agent/ai/__tests__/system-prompt.test.ts` | Validate/Enhance — unit tests                                 |

[Source: architecture/source-tree.md — ai/ section]

### Testing Requirements

- **Framework:** Jest 29.7.x with ts-jest
- **Location:** `packages/connector/src/agent/ai/__tests__/system-prompt.test.ts`
- **Patterns:** AAA (Arrange, Act, Assert), descriptive test names, mock all external deps
- **Coverage:** >80% line coverage for `system-prompt.ts`
- **Key mocks:**
  - `SkillRegistry` — mock with test skills or create real instance with test skills registered
  - `NostrEvent` — mock events with various kinds, content lengths, tag counts
- **Test isolation:** Fresh `SystemPromptBuilder` and `SkillRegistry` instances in `beforeEach()`
- **Critical test scenarios:**
  - Default personality ("AI Agent", "ILP connector and Nostr event relay")
  - Custom personality (name, role, instructions all set)
  - ILP address present vs. absent
  - Content truncation at 500 characters
  - Tags summary with > 10 tags (ellipsis)
  - Empty content (no Content line)
  - All Decision Framework rules present
  - `buildStatic()` excludes "Current Event" section
  - Multiple skills listed in Available Skills

[Source: architecture/test-strategy-and-standards.md#unit-tests]

### Technical Constraints

- **Token efficiency:** The static prompt portion should be concise. Avoid verbose descriptions that inflate token usage per request.
- **Content truncation:** Event content is truncated at 500 characters with `...` appended. This prevents large events from consuming excessive tokens.
- **Tags limit:** Only the first 10 tags are shown in the prompt, with a total count and ellipsis for more.
- **Bigint handling:** `amount` is a `bigint` and must be converted to string for prompt inclusion (`.toString()`).
- **ISO date format:** `created_at` (Unix timestamp) is converted to ISO format via `new Date(created_at * 1000).toISOString()`.
- **No console.log:** Use Pino logger exclusively (though SystemPromptBuilder itself likely needs no logging).
- **Import style:** Use `import type` for type-only imports per TypeScript convention.
- **Prompt structure uses Markdown:** Sections use `##` headers for clear delineation.

[Source: architecture/coding-standards.md#critical-rules, packages/connector/src/agent/ai/system-prompt.ts]

### Existing Code Context

**Pre-existing `system-prompt.ts` (186 lines):**

- `PromptContext` interface with `event`, `source`, `amount`, `destination` fields
- `SystemPromptBuilder` class with constructor accepting `agentPubkey`, `ilpAddress?`, `personality?`, `skillRegistry`
- `build(context)` and `buildStatic()` methods
- Private methods: `_buildIdentity()`, `_buildProtocolContext()`, `_buildSkillsSection()`, `_buildDecisionFramework()`, `_buildEventContext(context)`
- Identity defaults: "AI Agent", "ILP connector and Nostr event relay"
- Content truncation at 500 chars
- Tags summary limited to first 10
- ILP address conditionally included

**Pre-existing `system-prompt.test.ts` (154 lines):**

- Tests for identity, protocol context, skill listing, decision framework, event context
- Tests for content truncation and tags summary
- Tests for personality name/role/instructions
- Tests for `buildStatic()` excluding event context
- Uses helper functions: `createTestPromptContext()`, `createTestRegistry()`

The dev agent should evaluate this code against the ACs and enhance test coverage if needed.

[Source: packages/connector/src/agent/ai/system-prompt.ts, packages/connector/src/agent/ai/__tests__/system-prompt.test.ts]

### Pre-existing Code Warning

**There is uncommitted code on the `epic-16` branch that was written ahead of the formal story process.** The dev agent should evaluate this code against the story requirements:

- **Untracked:** `packages/connector/src/agent/ai/system-prompt.ts` — SystemPromptBuilder class (186 lines)
- **Untracked:** `packages/connector/src/agent/ai/__tests__/system-prompt.test.ts` — unit tests (154 lines)

The dev agent may use this code as a starting point if it meets the acceptance criteria, or rewrite as needed. All code must be validated against the ACs regardless of whether it pre-existed.

---

## Change Log

| Date       | Version | Description            | Author |
| ---------- | ------- | ---------------------- | ------ |
| 2026-01-27 | 0.1     | Initial story creation | SM     |

---

## Dev Agent Record (Agent Populates After Execution)

### Agent Model Used

_To be populated_

### Debug Log References

_To be populated_

### Completion Notes

_To be populated_

### File List

_To be populated_

---

## QA Results

_To be populated after implementation and review_
