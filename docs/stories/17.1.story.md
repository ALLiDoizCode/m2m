<!-- Powered by BMAD™ Core -->

# Story 17.1: DVM Job Request Parser (Kind 5XXX)

## Status

Done

## Story

**As a** connector operator running an AI agent,
**I want** a parser that extracts NIP-90 DVM job request data from Kind 5XXX Nostr events,
**So that** the agent can process standardized job requests from the Nostr DVM ecosystem, enabling interoperability with other NIP-90 compliant clients and services.

## Acceptance Criteria

1. Parser extracts `i` tags (input data with type hints) supporting all four input types: `text`, `url`, `event`, and `job`
2. Parser extracts `output` tag (expected output MIME type)
3. Parser extracts `param` tags (key-value parameters) into a Map structure
4. Parser extracts `bid` tag (informational — actual payment is ILP amount)
5. Parser extracts `relays` tag (relay hints) as string array
6. Parser validates job request structure (kind in 5000-5999 range, required tags present)
7. Parser returns typed `DVMJobRequest` object with all extracted fields
8. Invalid requests throw descriptive `DVMParseError` with specific error codes and messages
9. Unit tests cover all input types, valid/invalid scenarios, edge cases, and achieve >80% branch coverage on DVM module source files

## Tasks / Subtasks

- [x] Task 1: Create DVM types module (AC: 1, 2, 3, 4, 5, 7)
  - [x] Create `packages/connector/src/agent/dvm/types.ts`
  - [x] Define `DVMInput` interface with `data`, `type`, `relay?`, `marker?` fields
  - [x] Define `DVMInputType = 'text' | 'url' | 'event' | 'job'` type
  - [x] Define `DVMErrorCode = 'INVALID_KIND' | 'INVALID_INPUT_TYPE' | 'INVALID_BID'` type
  - [x] Define `DVM_ERROR_CODES` constant object for programmatic error code access
  - [x] Define `DVMJobRequest` interface with all fields from Technical Notes
  - [x] Define `DVMParseError` class extending Error with typed `code: DVMErrorCode` and `field?` properties
  - [x] Define `DVM_KIND_RANGE = { min: 5000, max: 5999 }` constant
  - [x] Export all types and constants from module
  - [Source: docs/prd/epic-17-nip-90-dvm-compatibility.md#story-171]

- [x] Task 2: Implement DVM job parser core (AC: 1, 2, 3, 4, 5, 6, 7, 8)
  - [x] Create `packages/connector/src/agent/dvm/dvm-job-parser.ts`
  - [x] Import types from `./types.ts` and `NostrEvent` from `../toon-codec`
  - [x] Implement `parseDVMJobRequest(event: NostrEvent): DVMJobRequest` main function
  - [x] Validate kind is in 5000-5999 range, throw `DVMParseError` with code `INVALID_KIND` if not
  - [x] Implement `parseInputTags(tags: string[][]): DVMInput[]` helper
    - [x] Extract all `['i', data, type, relay?, marker?]` tags
    - [x] Validate type is one of: 'text', 'url', 'event', 'job'
    - [x] Throw `DVMParseError` with code `INVALID_INPUT_TYPE` for unknown types
  - [x] Implement `parseOutputTag(tags: string[][]): string | undefined` helper
    - [x] Extract `['output', mimeType]` tag, return undefined if not present
  - [x] Implement `parseParamTags(tags: string[][]): Map<string, string>` helper
    - [x] Extract all `['param', key, value]` tags into Map
    - [x] Handle duplicate keys (last value wins)
  - [x] Implement `parseBidTag(tags: string[][]): bigint | undefined` helper
    - [x] Extract `['bid', amount]` tag, parse as bigint
    - [x] Throw `DVMParseError` with code `INVALID_BID` if not a valid number
  - [x] Implement `parseRelaysTag(tags: string[][]): string[]` helper
    - [x] Extract `['relays', ...urls]` tag values
    - [x] Return empty array if not present
  - [x] Return complete `DVMJobRequest` object with `event` reference included
  - [Source: docs/architecture/agent-society-protocol.md#ilp-packet-usage]

- [x] Task 3: Create DVM module index and exports (AC: 7)
  - [x] Create `packages/connector/src/agent/dvm/index.ts` barrel file
  - [x] Export types: `DVMJobRequest`, `DVMInput`, `DVMInputType`, `DVMParseError`, `DVM_KIND_RANGE`
  - [x] Export function: `parseDVMJobRequest`
  - [x] Update `packages/connector/src/agent/index.ts` to re-export DVM module
  - [Source: docs/architecture/source-tree.md — agent/ section]

- [x] Task 4: Write unit tests for DVM job parser (AC: 9)
  - [x] Create `packages/connector/src/agent/dvm/__tests__/dvm-job-parser.test.ts`
  - [x] Test valid job request parsing with all tag types present
  - [x] Test input tag parsing for each type (text, url, event, job)
  - [x] Test input tag with relay hint and marker
  - [x] Test multiple inputs in single request
  - [x] Test output tag extraction (present and absent)
  - [x] Test param tag extraction (single, multiple, duplicate keys)
  - [x] Test bid tag extraction (valid bigint, missing)
  - [x] Test relays tag extraction (present, absent, multiple URLs)
  - [x] Test kind validation (5000 valid, 4999 invalid, 6000 invalid)
  - [x] Test invalid input type throws DVMParseError with INVALID_INPUT_TYPE
  - [x] Test invalid bid format throws DVMParseError with INVALID_BID
  - [x] Test empty event (no i tags) returns empty inputs array
  - [x] Test event reference preserved in DVMJobRequest.event field
  - [x] All tests follow AAA pattern with clear descriptions
  - [x] Run coverage: `npx jest --coverage --collectCoverageFrom='src/agent/dvm/**/*.ts' dvm-job-parser.test.ts`
  - [x] Verify >80% branch coverage on DVM module source files (`types.ts`, `dvm-job-parser.ts`)
  - [Source: docs/architecture/test-strategy-and-standards.md#unit-tests]

- [x] Task 5: Run full test suite and validate (AC: 1-9)
  - [x] Run DVM parser tests: `npx jest dvm-job-parser.test.ts`
  - [x] Verify all tests pass
  - [x] Run full connector test suite: `npm test` from `packages/connector`
  - [x] Verify no regressions in existing tests
  - [x] Document any test failures and fixes
  - [Source: docs/architecture/test-strategy-and-standards.md]

## Dev Notes

### Previous Story Insights (from Story 16.7)

- **Story 16.7** (Integration Tests): Established patterns for testing AI agent dispatch pipeline with mocked AI model. Created `createMockGenerateTextResponse()` helper and `createFullDispatcher()` for integration test setup. 91.4% branch coverage achieved across AI module. Tests follow AAA pattern consistently. [Source: docs/stories/16.7.story.md#dev-agent-record]

- **Epic 16 completion**: AI Agent module is fully functional with SkillRegistry, SystemPromptBuilder, TokenBudget, and fallback AgentEventHandler. The DVM parser will integrate with this infrastructure in later stories (17.4+). [Source: docs/architecture/ai-agent-skills.md]

### Data Models

**DVMJobRequest interface:**

```typescript
interface DVMJobRequest {
  kind: number; // 5000-5999
  inputs: DVMInput[]; // From 'i' tags
  outputType?: string; // From 'output' tag
  params: Map<string, string>; // From 'param' tags
  bid?: bigint; // From 'bid' tag (informational)
  relays: string[]; // From 'relays' tag
  event: NostrEvent; // Original event
}
```

[Source: docs/prd/epic-17-nip-90-dvm-compatibility.md#story-171]

**DVMInput interface:**

```typescript
interface DVMInput {
  data: string;
  type: 'text' | 'url' | 'event' | 'job';
  relay?: string;
  marker?: string;
}
```

[Source: docs/prd/epic-17-nip-90-dvm-compatibility.md#story-171]

**DVMErrorCode type and constants:**

```typescript
type DVMErrorCode = 'INVALID_KIND' | 'INVALID_INPUT_TYPE' | 'INVALID_BID';

const DVM_ERROR_CODES = {
  INVALID_KIND: 'INVALID_KIND',
  INVALID_INPUT_TYPE: 'INVALID_INPUT_TYPE',
  INVALID_BID: 'INVALID_BID',
} as const satisfies Record<DVMErrorCode, DVMErrorCode>;
```

**DVMParseError class:**

```typescript
class DVMParseError extends Error {
  readonly code: DVMErrorCode;
  readonly field?: string;

  constructor(code: DVMErrorCode, message: string, field?: string) {
    super(message);
    this.name = 'DVMParseError';
    this.code = code;
    this.field = field;
  }
}
```

[Source: docs/architecture/error-handling-strategy.md — Business Logic Errors pattern]

### API Specifications

**NIP-90 Tag Formats (from specification):**

| Tag      | Format                                              | Description                       |
| -------- | --------------------------------------------------- | --------------------------------- |
| `i`      | `['i', '<data>', '<type>', '<relay?>','<marker?>']` | Input data with type hint         |
| `output` | `['output', '<mime-type>']`                         | Expected output format            |
| `param`  | `['param', '<key>', '<value>']`                     | Key-value parameter               |
| `bid`    | `['bid', '<msat-amount>']`                          | Max payment (informational)       |
| `relays` | `['relays', '<url1>', '<url2>', ...]`               | Preferred relay URLs              |
| `e`      | `['e', '<event-id>', '<relay?>','<marker?>']`       | Event reference (standard Nostr)  |
| `p`      | `['p', '<pubkey>', '<relay?>', '<petname?>']`       | Pubkey reference (standard Nostr) |

[Source: NIP-90 specification — https://nips.nostr.com/90]

**Input Type Semantics:**

| Type    | Description                  | Resolution                                |
| ------- | ---------------------------- | ----------------------------------------- |
| `text`  | Direct string value          | Use data value directly                   |
| `url`   | HTTP/HTTPS resource URL      | Fetch content from URL                    |
| `event` | Nostr event reference        | Retrieve event by ID from relay           |
| `job`   | Output from previous DVM job | Retrieve result event and extract content |

[Source: NIP-90 specification — https://nips.nostr.com/90]

### Example DVM Job Request Events

**Valid Job Request (Kind 5000 - General Query):**

```json
{
  "id": "abc123...",
  "pubkey": "def456...",
  "kind": 5000,
  "created_at": 1706400000,
  "content": "",
  "tags": [
    ["i", "What is the current BTC price?", "text"],
    ["output", "application/json"],
    ["param", "format", "detailed"],
    ["param", "currency", "USD"],
    ["bid", "5000"],
    ["relays", "wss://relay1.example.com", "wss://relay2.example.com"]
  ],
  "sig": "..."
}
```

**Valid Job Request (Kind 5100 - Translation with URL input):**

```json
{
  "id": "xyz789...",
  "pubkey": "abc123...",
  "kind": 5100,
  "created_at": 1706400000,
  "content": "",
  "tags": [
    ["i", "https://example.com/article.txt", "url"],
    ["i", "es", "text", "", "target_language"],
    ["output", "text/plain"]
  ],
  "sig": "..."
}
```

**Valid Job Request (Minimal - only required tags):**

```json
{
  "id": "min123...",
  "pubkey": "min456...",
  "kind": 5000,
  "created_at": 1706400000,
  "content": "",
  "tags": [["i", "Hello world", "text"]],
  "sig": "..."
}
```

**Invalid Job Request (Kind outside DVM range):**

```json
{
  "kind": 4999,
  "tags": [["i", "test", "text"]]
}
```

→ Should throw `DVMParseError` with code `INVALID_KIND`

**Invalid Job Request (Unknown input type):**

```json
{
  "kind": 5000,
  "tags": [["i", "data", "unknown_type"]]
}
```

→ Should throw `DVMParseError` with code `INVALID_INPUT_TYPE`

**Invalid Job Request (Malformed bid):**

```json
{
  "kind": 5000,
  "tags": [
    ["i", "test", "text"],
    ["bid", "not_a_number"]
  ]
}
```

→ Should throw `DVMParseError` with code `INVALID_BID`

### File Locations

| File                                                                | Purpose                            |
| ------------------------------------------------------------------- | ---------------------------------- |
| `packages/connector/src/agent/dvm/types.ts`                         | Create — DVM type definitions      |
| `packages/connector/src/agent/dvm/dvm-job-parser.ts`                | Create — DVM job request parser    |
| `packages/connector/src/agent/dvm/index.ts`                         | Create — DVM module barrel exports |
| `packages/connector/src/agent/index.ts`                             | Modify — re-export DVM module      |
| `packages/connector/src/agent/dvm/__tests__/dvm-job-parser.test.ts` | Create — Parser unit tests         |

[Source: docs/architecture/source-tree.md — agent/ section, docs/prd/epic-17-nip-90-dvm-compatibility.md#package-structure]

### Testing Requirements

- **Framework:** Jest 29.7.x with ts-jest
- **Location:** `packages/connector/src/agent/dvm/__tests__/` for DVM module tests
- **Patterns:** AAA (Arrange, Act, Assert), descriptive test names
- **Coverage:** >80% branch coverage for parser functions
- **Test Data:** Create helper function `createDVMJobEvent(overrides)` for test event generation
- **Mocking:** No external dependencies to mock — pure parsing logic
- **Validation:** Test both positive (valid inputs) and negative (error conditions) paths

**Test Helper Function:**

```typescript
function createDVMJobEvent(overrides?: Partial<NostrEvent>): NostrEvent {
  return {
    id: 'a'.repeat(64),
    pubkey: 'b'.repeat(64),
    kind: 5000,
    created_at: Math.floor(Date.now() / 1000),
    content: '',
    tags: [['i', 'test input', 'text']],
    sig: 'c'.repeat(128),
    ...overrides,
  };
}
```

[Source: docs/architecture/test-strategy-and-standards.md#unit-tests]

### Technical Constraints

- **Kind range validation:** Only kinds 5000-5999 are valid DVM job requests
- **Tag extraction:** Use standard Nostr tag array format `['tagname', ...values]`
- **Bigint for bid:** The `bid` field is in millisatoshis and may exceed Number.MAX_SAFE_INTEGER, use `bigint`
- **No async operations:** Parser is synchronous — no network calls or database access
- **Error specificity:** Each error type has a unique code for programmatic handling
- **Event preservation:** Original `NostrEvent` is attached to result for downstream access
- **Type safety:** Use TypeScript discriminated unions for input types
- **No console.log:** Use Pino logger if logging is needed (unlikely in pure parser)

[Source: docs/architecture/coding-standards.md#critical-rules, docs/architecture/tech-stack.md]

### Existing Code Context

**NostrEvent type (from toon-codec.ts):**

```typescript
interface NostrEvent {
  id: string; // 64-char hex event ID
  pubkey: string; // 64-char hex author pubkey
  kind: number; // Event kind (integer)
  created_at: number; // Unix timestamp (seconds)
  content: string; // Event content
  tags: string[][]; // Array of tag arrays
  sig: string; // 128-char hex signature
}
```

[Source: packages/connector/src/agent/toon-codec.ts]

**AgentEventHandler pattern (for reference):**

The parser follows a similar pattern to the existing event handler — pure data transformation with typed inputs and outputs. Errors are thrown (not returned) for invalid inputs, consistent with `InsufficientPaymentError` pattern.

[Source: packages/connector/src/agent/event-handler.ts]

### Integration Notes

This story creates the foundation for DVM job processing. The parser output (`DVMJobRequest`) will be consumed by:

- **Story 17.4** (Migrate Query Handler) — Parse Kind 5000 requests
- **Story 17.6** (Task Delegation Request) — Parse Kind 5900 requests

The parser does NOT handle:

- Job result formatting (Story 17.2)
- Job feedback events (Story 17.3)
- Payment validation (uses existing `EventHandler._validatePayment()`)

[Source: docs/prd/epic-17-nip-90-dvm-compatibility.md#stories]

---

## Change Log

| Date       | Version | Description                                                                                                                                                                                              | Author |
| ---------- | ------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------ |
| 2026-01-28 | 0.1     | Initial story creation                                                                                                                                                                                   | SM     |
| 2026-01-28 | 0.2     | Validation fixes: Added DVMErrorCode type union and DVM_ERROR_CODES constant; clarified coverage command; added test helper example; added NIP-90 URL references; added example valid/invalid DVM events | SM     |
| 2026-01-28 | 1.0     | Implementation complete: DVM types, parser, exports, and 41 unit tests with 100% coverage                                                                                                                | Dev    |

---

## Dev Agent Record (Agent Populates After Execution)

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

None - no debug issues encountered during implementation.

### Completion Notes

- Implemented NIP-90 DVM job request parser as specified
- All tag types fully supported: `i` (input), `output`, `param`, `bid`, `relays`
- Input types validated: `text`, `url`, `event`, `job`
- Kind range validation: 5000-5999 (DVM range per NIP-90)
- Comprehensive error handling with typed `DVMParseError` and specific error codes
- 41 unit tests covering all positive and negative paths
- **100% branch coverage** achieved on all DVM module source files
- Full test suite run: DVM tests pass, 3 pre-existing failures in wallet/performance tests (unrelated to this story)
- Linting passes with no errors
- Module exports properly integrated into agent index.ts

### File List

| File                                                                | Status   | Purpose                                                             |
| ------------------------------------------------------------------- | -------- | ------------------------------------------------------------------- |
| `packages/connector/src/agent/dvm/types.ts`                         | Created  | DVM type definitions (DVMJobRequest, DVMInput, DVMParseError, etc.) |
| `packages/connector/src/agent/dvm/dvm-job-parser.ts`                | Created  | DVM job request parser implementation                               |
| `packages/connector/src/agent/dvm/index.ts`                         | Created  | DVM module barrel exports                                           |
| `packages/connector/src/agent/dvm/__tests__/dvm-job-parser.test.ts` | Created  | Unit tests for DVM parser (41 tests)                                |
| `packages/connector/src/agent/index.ts`                             | Modified | Added DVM module re-exports                                         |

---

## QA Results

### Review Date: 2026-01-28

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: Excellent** - Clean, well-structured implementation following established patterns.

The DVM job parser is a pure synchronous parsing module with excellent separation of concerns:

- `types.ts` contains all interfaces, types, and error classes
- `dvm-job-parser.ts` contains parsing logic with clean helper functions
- Proper barrel exports in `index.ts`

Code demonstrates understanding of:

- NIP-90 specification requirements
- TypeScript strict mode patterns
- Error handling best practices (typed error codes, field references)
- BigInt for large numeric values (bid amounts)

### Refactoring Performed

None required - code quality meets standards.

### Compliance Check

- Coding Standards: ✓ All rules followed (no console.log, proper naming, strict types)
- Project Structure: ✓ Files in correct location (`packages/connector/src/agent/dvm/`)
- Testing Strategy: ✓ 41 unit tests with AAA pattern, 100% coverage
- All ACs Met: ✓ All 9 acceptance criteria fully implemented and tested

### Requirements Traceability (Given-When-Then)

| AC  | Test Coverage   | Scenario                                                                                   |
| --- | --------------- | ------------------------------------------------------------------------------------------ |
| 1   | ✓ 7 tests       | **Given** event with `i` tags, **When** parsed, **Then** DVMInput[] with all 4 types       |
| 2   | ✓ 3 tests       | **Given** event with `output` tag, **When** parsed, **Then** outputType string             |
| 3   | ✓ 4 tests       | **Given** event with `param` tags, **When** parsed, **Then** Map with last-wins duplicates |
| 4   | ✓ 4 tests       | **Given** event with `bid` tag, **When** parsed, **Then** bigint or error on invalid       |
| 5   | ✓ 3 tests       | **Given** event with `relays` tag, **When** parsed, **Then** string[] of URLs              |
| 6   | ✓ 6 tests       | **Given** event, **When** kind outside 5000-5999, **Then** DVMParseError thrown            |
| 7   | ✓ All tests     | **Given** valid event, **When** parsed, **Then** typed DVMJobRequest returned              |
| 8   | ✓ 5 tests       | **Given** invalid input, **When** parsed, **Then** DVMParseError with code/field           |
| 9   | ✓ 100% coverage | **Given** test suite, **When** run with coverage, **Then** >80% branch coverage            |

### Improvements Checklist

- [x] All acceptance criteria implemented
- [x] All tests pass with 100% coverage
- [x] Proper error handling with typed codes
- [x] JSDoc documentation on public APIs
- [x] Module properly exported from agent index.ts
- [ ] **Future consideration**: Add input validation for relay URL format (e.g., must start with `wss://` or `ws://`)
- [ ] **Future consideration**: Add input validation for event ID format (64-char hex)

### Security Review

**Status: No concerns**

This is a pure parsing module with no:

- External network calls
- Database operations
- Authentication/authorization logic
- User input that could lead to injection

The parser safely handles:

- Malformed tags (skipped gracefully)
- Invalid bid values (throws typed error)
- Unknown input types (throws typed error)

### Performance Considerations

**Status: No concerns**

- Synchronous, single-pass parsing
- No allocations beyond result objects
- O(n) where n = number of tags
- No regex or expensive string operations

### Files Modified During Review

None - no refactoring needed.

### Gate Status

**Gate: PASS** → `docs/qa/gates/17.1-dvm-job-request-parser.yml`

### Recommended Status

**✓ Ready for Done**

All acceptance criteria met, 100% test coverage, clean implementation following established patterns. No blocking issues identified.
