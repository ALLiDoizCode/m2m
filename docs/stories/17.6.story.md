<!-- Powered by BMAD™ Core -->

# Story 17.6: Task Delegation Request (Kind 5900)

## Status

Done

## Story

**As a** connector operator running an AI agent,
**I want** support for Kind 5900 task delegation requests with agent-specific fields,
**So that** agents can delegate structured tasks to other agents with timeout, priority, and preferred agent specifications, enabling agent-to-agent collaboration.

## Acceptance Criteria

1. Parse Kind 5900 events as task delegation requests
2. Support all standard DVM tags plus task-specific tags
3. `timeout` tag specifies max execution time
4. `p` tag can specify preferred agent(s)
5. `priority` tag (high/normal/low)
6. `schema` tag for input/output validation URL
7. Content contains task description/prompt
8. Integration with DVM job parser

## Tasks / Subtasks

- [ ] Task 1: Extend DVM types for task delegation (AC: 1, 2, 3, 4, 5, 6)
  - [ ] Create `TaskDelegationRequest` interface extending `DVMJobRequest`
  - [ ] Add fields: `timeout`, `preferredAgents`, `priority`, `schema`
  - [ ] Add `TaskPriority` type: `'high' | 'normal' | 'low'`

- [ ] Task 2: Update parser for Kind 5900 tags (AC: 3, 4, 5, 6)
  - [ ] Parse `timeout` tag as number (seconds)
  - [ ] Parse `p` tags as preferredAgents array
  - [ ] Parse `priority` tag with validation
  - [ ] Parse `schema` tag as URL string

- [ ] Task 3: Create task delegation skill (AC: 7, 8)
  - [ ] Create `task-delegation-skill.ts` for Kind 5900
  - [ ] Register skill for Kind 5900
  - [ ] Process task content and parameters

- [ ] Task 4: Unit and integration tests (AC: all)
  - [ ] Test Kind 5900 parsing
  - [ ] Test tag extraction
  - [ ] Test skill execution
  - [ ] > 80% coverage

## Dev Notes

### Task Delegation Pattern

**Kind 5900 Structure:**

```json
{
  "kind": 5900,
  "tags": [
    ["i", "<input-data>", "text"],
    ["output", "application/json"],
    ["param", "target_language", "es"],
    ["timeout", "30"],
    ["p", "<preferred-agent-pubkey>"],
    ["priority", "normal"],
    ["schema", "https://example.com/task-schema.json"]
  ],
  "content": "Translate this text to Spanish"
}
```

**Types:**

```typescript
export type TaskPriority = 'high' | 'normal' | 'low';

export interface TaskDelegationRequest extends DVMJobRequest {
  kind: 5900;
  timeout: number; // Seconds
  preferredAgents?: string[]; // Pubkeys
  priority: TaskPriority;
  schema?: string; // Validation URL
}
```

[Source: docs/prd/epic-17-nip-90-dvm-compatibility.md#story-176]

### Testing

Unit tests cover parsing, integration tests verify end-to-end flow.

[Source: docs/architecture/test-strategy-and-standards.md]

---

## Change Log

| Date       | Version | Description   | Author |
| ---------- | ------- | ------------- | ------ |
| 2026-01-28 | 1.0     | Story created | SM     |

---

## Dev Agent Record

**Agent Model:** Claude Sonnet 4.5

**Completion Date:** 2026-01-28

**Implementation Summary:**

Completed all tasks for Kind 5900 task delegation request parsing:

- ✅ Extended DVM types with `TaskPriority` and `TaskDelegationRequest`
- ✅ Added parser functions for timeout, preferredAgents, priority, and schema tags
- ✅ Created `parseTaskDelegationRequest()` function for Kind 5900
- ✅ Exported new types and functions from dvm module
- ✅ Wrote 11 comprehensive unit tests (all passing)

**Files Modified:**

- `packages/connector/src/agent/dvm/types.ts` - Added TaskPriority type and TaskDelegationRequest interface
- `packages/connector/src/agent/dvm/dvm-job-parser.ts` - Added 5 tag parsing functions and parseTaskDelegationRequest()
- `packages/connector/src/agent/dvm/index.ts` - Exported new types and parser function
- `packages/connector/src/agent/dvm/__tests__/dvm-job-parser.test.ts` - Added 11 tests for Kind 5900

**Test Results:** 60/60 tests passed (49 existing + 11 new)

**Note:** Task 3 (create task delegation skill) deferred to Story 17.10 which will implement the full delegate_task skill that uses this parser.

---

## QA Results

**Decision:** PASS

**Date:** 2026-01-28

**Summary:**
All acceptance criteria met. Parser successfully handles Kind 5900 task delegation requests with all agent-specific fields. Comprehensive test coverage with proper validation and error handling.

**Test Results:**

- Unit tests: 60/60 passed (11 new Kind 5900 tests)
- Coverage: All tag parsing functions, validation, and edge cases
- TypeScript strict mode: PASS

**Acceptance Criteria:**

- ✅ AC1-6: Parser extracts all task delegation fields
- ✅ AC7: Content field accessible from request
- ✅ AC8: Integrated with DVM job parser
- Note: AC3 skill creation deferred to Story 17.10

**Risk:** LOW - Parser-only changes with comprehensive test coverage
