# Prometheus Alert Rules for ILP Connector
# Defines alerts for monitoring connector health, performance, and settlement operations

groups:
  - name: ilp-connector-alerts
    rules:
      # High Packet Error Rate - Warning if >5% error rate for 2 minutes
      - alert: HighPacketErrorRate
        expr: |
          (
            sum(rate(ilp_packets_processed_total{status="error"}[5m]))
            /
            sum(rate(ilp_packets_processed_total[5m]))
          ) > 0.05
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "High packet error rate detected"
          description: "Packet error rate is {{ $value | humanizePercentage }} which exceeds 5% threshold. Check connector logs for error details."
          runbook_url: "docs/operators/incident-response-runbook.md#high-packet-error-rate"

      # Settlement Failures - Critical if any failure for 1 minute
      - alert: SettlementFailures
        expr: rate(settlements_executed_total{status="failure"}[5m]) > 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Settlement failures detected"
          description: "Settlement failures occurring on method {{ $labels.method }}. Immediate investigation required."
          runbook_url: "docs/operators/incident-response-runbook.md#settlement-failures"

      # TigerBeetle Unavailable - Critical if down for 1 minute
      - alert: TigerBeetleUnavailable
        expr: up{job="tigerbeetle"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "TigerBeetle is unavailable"
          description: "TigerBeetle database is not responding. Balance tracking is offline."
          runbook_url: "docs/operators/incident-response-runbook.md#tigerbeetle-unavailable"

      # Channel Dispute - High severity when any dispute detected
      - alert: ChannelDispute
        expr: payment_channels_active{status="disputed"} > 0
        for: 0m
        labels:
          severity: high
        annotations:
          summary: "Payment channel dispute detected"
          description: "A payment channel dispute has been detected on {{ $labels.method }}. Manual intervention may be required."
          runbook_url: "docs/operators/incident-response-runbook.md#channel-dispute"

      # High P99 Latency - Warning if p99 >10ms for 5 minutes
      - alert: HighP99Latency
        expr: histogram_quantile(0.99, rate(ilp_packet_latency_seconds_bucket[5m])) > 0.01
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High packet processing latency"
          description: "P99 latency is {{ $value | humanizeDuration }} which exceeds 10ms threshold. Performance may be degraded."
          runbook_url: "docs/operators/incident-response-runbook.md#high-latency"

      # Low Throughput - Warning if <1000 TPS for 5 minutes
      - alert: LowThroughput
        expr: sum(rate(ilp_packets_processed_total[5m])) < 1000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Low packet throughput"
          description: "Packet throughput is {{ $value | humanize }} packets/second, below 1000 TPS threshold."
          runbook_url: "docs/operators/incident-response-runbook.md#low-throughput"

      # Connector Down - Critical if connector is unreachable
      - alert: ConnectorDown
        expr: up{job="ilp-connector"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "ILP Connector is down"
          description: "The ILP Connector at {{ $labels.instance }} is not responding to scrapes."
          runbook_url: "docs/operators/incident-response-runbook.md#connector-down"

      # High Memory Usage - Warning if heap usage >80%
      - alert: HighMemoryUsage
        expr: |
          (
            nodejs_heap_size_used_bytes
            /
            nodejs_heap_size_total_bytes
          ) > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High memory usage"
          description: "Heap memory usage is {{ $value | humanizePercentage }}. Consider investigating memory leaks."
          runbook_url: "docs/operators/incident-response-runbook.md#high-memory-usage"

      # Critical Error Spike - High severity if many critical errors
      - alert: CriticalErrorSpike
        expr: rate(connector_errors_total{severity="critical"}[5m]) > 0.1
        for: 2m
        labels:
          severity: high
        annotations:
          summary: "Critical errors increasing"
          description: "Critical errors are occurring at {{ $value | humanize }} per second. Type: {{ $labels.type }}"
          runbook_url: "docs/operators/incident-response-runbook.md#critical-errors"

      # Settlement SLA Breach - Warning if settlement success rate drops
      - alert: SettlementSLABreach
        expr: |
          (
            sum(rate(settlements_executed_total{status="success"}[1h]))
            /
            sum(rate(settlements_executed_total[1h]))
          ) < 0.99
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Settlement SLA breach"
          description: "Settlement success rate is {{ $value | humanizePercentage }}, below 99% SLA threshold."
          runbook_url: "docs/operators/incident-response-runbook.md#sla-breach"

      # Packet SLA Breach - Warning if packet success rate drops
      - alert: PacketSLABreach
        expr: |
          (
            sum(rate(ilp_packets_processed_total{status="success"}[1h]))
            /
            sum(rate(ilp_packets_processed_total[1h]))
          ) < 0.999
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Packet SLA breach"
          description: "Packet success rate is {{ $value | humanizePercentage }}, below 99.9% SLA threshold."
          runbook_url: "docs/operators/incident-response-runbook.md#sla-breach"
