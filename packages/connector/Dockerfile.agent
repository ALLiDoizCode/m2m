# Dockerfile for Agent Society Test
# Builds a standalone agent node for multi-container testing
#
# Usage:
#   docker build -f packages/connector/Dockerfile.agent -t m2m-agent .
#   docker run -e AGENT_ID=peer-0 -p 8080:8080 -p 3000:3000 -p 9000:9000 m2m-agent

FROM node:22-alpine

# Set working directory
WORKDIR /app

# Copy package files for dependency installation
COPY package.json package-lock.json tsconfig.base.json ./
COPY packages/connector/package.json packages/connector/tsconfig.json ./packages/connector/
COPY packages/shared/package.json packages/shared/tsconfig.json ./packages/shared/

# Install dependencies (ignore-scripts to skip husky prepare)
RUN npm ci --workspaces --ignore-scripts

# Copy source code
COPY packages/connector/src ./packages/connector/src
COPY packages/shared/src ./packages/shared/src

# Copy pre-built explorer UI (assumes it's already built on host)
COPY packages/connector/dist/explorer-ui ./packages/connector/dist/explorer-ui

# Build TypeScript (shared first, then connector)
RUN npm run build -w @m2m/shared && npm run build:connector-only -w @m2m/connector

# Set environment variables
ENV NODE_ENV=production
ENV AGENT_HTTP_PORT=8080
ENV AGENT_BTP_PORT=3000
ENV AGENT_EXPLORER_PORT=9000
ENV AGENT_DATABASE_PATH=:memory:
ENV AGENT_EXPLORER_DB_PATH=:memory:
ENV LOG_LEVEL=info

# Expose ports
EXPOSE 8080
EXPOSE 3000
EXPOSE 9000

# Health check
HEALTHCHECK --interval=10s --timeout=5s --start-period=10s --retries=3 \
  CMD wget --no-verbose --tries=1 --spider http://localhost:8080/health || exit 1

# Start the agent server
CMD ["node", "packages/connector/dist/agent/agent-server.js"]
