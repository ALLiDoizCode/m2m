/**
 * Agent Society Integration Test Helpers
 *
 * Provides utility functions for creating multi-peer agent networks,
 * establishing social graphs, deploying contracts, and simulating events.
 */

import * as crypto from 'crypto';
import { ethers } from 'ethers';
import { getPublicKey } from 'nostr-tools';
import { AgentNode } from '../../../src/agent/agent-node';
import type { AgentNodeConfig } from '../../../src/agent/agent-node';
import { ToonCodec } from '../../../src/agent/toon-codec';
import type { NostrEvent } from '../../../src/agent/toon-codec';
import { ILPPreparePacket, PacketType } from '@m2m/shared';

// ============================================
// Configuration
// ============================================

export interface AgentSocietyTestConfig {
  /** Number of peers to create (default: 5) */
  peerCount: number;
  /** AGENT token name */
  agentTokenName: string;
  /** AGENT token symbol */
  agentTokenSymbol: string;
  /** Initial deposit for payment channels */
  initialChannelDeposit: bigint;
  /** Settlement timeout in seconds */
  settlementTimeout: number;
  /** Anvil RPC URL */
  anvilRpcUrl: string;
  /** Skip payment channel setup */
  skipChannels: boolean;
  /** Enable verbose logging */
  verbose: boolean;
}

export const DEFAULT_CONFIG: AgentSocietyTestConfig = {
  peerCount: parseInt(process.env.AGENT_SOCIETY_PEER_COUNT ?? '5', 10),
  agentTokenName: 'Agent Token',
  agentTokenSymbol: 'AGENT',
  initialChannelDeposit: ethers.parseEther('1000'),
  settlementTimeout: 3600, // 1 hour
  anvilRpcUrl: process.env.ANVIL_RPC_URL ?? 'http://localhost:8545',
  skipChannels: process.env.SKIP_CHANNELS === 'true',
  verbose: process.env.VERBOSE === 'true',
};

// ============================================
// Types
// ============================================

export interface AgentPeer {
  /** Peer identifier (e.g., "peer-0") */
  id: string;
  /** Peer index */
  index: number;
  /** Nostr public key (64-char hex) */
  nostrPubkey: string;
  /** Nostr private key (64-char hex) */
  nostrPrivkey: string;
  /** ILP address (e.g., "g.agent.peer0") */
  ilpAddress: string;
  /** AgentNode instance */
  agentNode: AgentNode;
  /** EVM wallet (funded with AGENT tokens) */
  evmWallet: ethers.Wallet;
  /** Pubkeys of followed peers */
  follows: string[];
  /** Map of peerId -> channelId for open channels */
  channels: Map<string, string>;
}

export interface DeploymentResult {
  /** AGENT token contract address */
  tokenAddress: string;
  /** TokenNetworkRegistry contract address */
  registryAddress: string;
  /** TokenNetwork contract address for AGENT token */
  tokenNetworkAddress: string;
  /** Deployer wallet */
  deployer: ethers.Wallet;
}

export interface SimulationResults {
  /** Number of events sent */
  eventsSent: number;
  /** Number of events received (fulfilled) */
  eventsReceived: number;
  /** Payment records */
  payments: Array<{
    from: string;
    to: string;
    amount: bigint;
  }>;
  /** Error messages */
  errors: string[];
}

export interface VerificationResult {
  /** Overall success */
  success: boolean;
  /** Individual check results */
  checks: Array<{
    name: string;
    passed: boolean;
    details: string;
  }>;
  /** Summary message */
  summary: string;
}

export type SocialGraphTopology = Record<number, number[]>;

// ============================================
// Social Graph Topologies
// ============================================

/**
 * Hardcoded social graph for 5 peers (hub-and-spoke + ring).
 *
 * Peer 0 (Hub): follows [1, 2, 3, 4]
 * Peer 1: follows [0, 2]
 * Peer 2: follows [0, 1, 3]
 * Peer 3: follows [0, 2, 4]
 * Peer 4: follows [0, 3]
 */
export const SOCIAL_GRAPH_5_PEERS: SocialGraphTopology = {
  0: [1, 2, 3, 4], // Hub follows all
  1: [0, 2],
  2: [0, 1, 3],
  3: [0, 2, 4],
  4: [0, 3],
};

/**
 * Generate a social graph for N peers.
 * Uses hub-and-spoke (peer 0 is hub) + ring topology.
 *
 * @param n - Number of peers
 * @returns Social graph topology
 */
export function generateSocialGraph(n: number): SocialGraphTopology {
  if (n <= 0) {
    return {};
  }

  if (n === 1) {
    return { 0: [] };
  }

  if (n <= 5) {
    // Use hardcoded topology for small graphs
    const graph: SocialGraphTopology = {};
    for (let i = 0; i < n; i++) {
      const hardcodedFollows = SOCIAL_GRAPH_5_PEERS[i];
      if (hardcodedFollows) {
        graph[i] = hardcodedFollows.filter((j) => j < n);
      } else {
        graph[i] = [0];
      }
    }
    return graph;
  }

  // Generate algorithmic topology for N > 5
  const graph: SocialGraphTopology = {};

  for (let i = 0; i < n; i++) {
    const follows: number[] = [];
    graph[i] = follows;

    // Peer 0 is the hub, follows all others
    if (i === 0) {
      for (let j = 1; j < n; j++) {
        follows.push(j);
      }
      continue;
    }

    // All non-hub peers follow the hub
    follows.push(0);

    // Ring topology: each peer follows adjacent peers
    const prev = i === 1 ? n - 1 : i - 1;
    const next = i === n - 1 ? 1 : i + 1;

    if (!follows.includes(prev) && prev !== 0) {
      follows.push(prev);
    }
    if (!follows.includes(next) && next !== 0) {
      follows.push(next);
    }
  }

  return graph;
}

// ============================================
// Peer Creation
// ============================================

/**
 * Generate a deterministic Nostr keypair from a seed.
 *
 * @param seed - Seed string
 * @returns Object with pubkey and privkey (both 64-char hex)
 */
export function generateNostrKeypair(seed: string): { pubkey: string; privkey: string } {
  const privkey = crypto.createHash('sha256').update(seed).digest('hex');
  const pubkey = getPublicKey(Buffer.from(privkey, 'hex'));
  return { pubkey, privkey };
}

/**
 * Generate a deterministic EVM wallet from a seed.
 *
 * @param seed - Seed string
 * @param provider - Ethers provider
 * @returns Ethers Wallet connected to provider
 */
export function generateEvmWallet(seed: string, provider: ethers.Provider): ethers.Wallet {
  const privateKey = crypto.createHash('sha256').update(`evm-${seed}`).digest('hex');
  return new ethers.Wallet(`0x${privateKey}`, provider);
}

/**
 * Create a single AgentPeer with all components.
 *
 * @param index - Peer index (0, 1, 2, ...)
 * @param provider - Ethers provider
 * @returns AgentPeer (not yet initialized)
 */
export function createAgentPeer(index: number, provider: ethers.Provider): AgentPeer {
  const seed = `agent-society-test-peer-${index}`;
  const { pubkey, privkey } = generateNostrKeypair(seed);
  const evmWallet = generateEvmWallet(seed, provider);

  const config: AgentNodeConfig = {
    agentPubkey: pubkey,
    agentPrivkey: privkey,
    databasePath: ':memory:',
    pricing: {
      noteStorage: 100n,
      followUpdate: 50n,
      deletion: 10n,
      queryBase: 200n,
    },
    enableBuiltInHandlers: true,
  };

  const agentNode = new AgentNode(config);

  return {
    id: `peer-${index}`,
    index,
    nostrPubkey: pubkey,
    nostrPrivkey: privkey,
    ilpAddress: `g.agent.peer${index}`,
    agentNode,
    evmWallet,
    follows: [],
    channels: new Map(),
  };
}

/**
 * Create N agent peers.
 *
 * @param count - Number of peers to create
 * @param provider - Ethers provider
 * @returns Array of AgentPeer (not yet initialized)
 */
export function createAgentPeers(count: number, provider: ethers.Provider): AgentPeer[] {
  const peers: AgentPeer[] = [];
  for (let i = 0; i < count; i++) {
    peers.push(createAgentPeer(i, provider));
  }
  return peers;
}

/**
 * Initialize all peer AgentNodes.
 *
 * @param peers - Array of peers to initialize
 */
export async function initializePeers(peers: AgentPeer[]): Promise<void> {
  await Promise.all(peers.map((peer) => peer.agentNode.initialize()));
}

/**
 * Shutdown all peer AgentNodes.
 *
 * @param peers - Array of peers to shutdown
 */
export async function shutdownPeers(peers: AgentPeer[]): Promise<void> {
  await Promise.all(
    peers.map(async (peer) => {
      try {
        await peer.agentNode.shutdown();
      } catch (error) {
        // Ignore shutdown errors
      }
    })
  );
}

// ============================================
// Social Graph Setup
// ============================================

/**
 * Setup social graph relationships between peers.
 *
 * @param peers - Array of peers
 * @param topology - Social graph topology (peerIndex -> followedIndices[])
 */
export function setupSocialGraph(peers: AgentPeer[], topology: SocialGraphTopology): void {
  for (const [peerIndexStr, followIndices] of Object.entries(topology)) {
    const peerIndex = parseInt(peerIndexStr, 10);
    const peer = peers[peerIndex];
    if (!peer) continue;

    for (const followIndex of followIndices) {
      const followedPeer = peers[followIndex];
      if (!followedPeer) continue;

      // Add to FollowGraphRouter
      peer.agentNode.followGraphRouter.addFollow({
        pubkey: followedPeer.nostrPubkey,
        ilpAddress: followedPeer.ilpAddress,
        petname: followedPeer.id,
      });

      // Track in peer.follows
      peer.follows.push(followedPeer.nostrPubkey);
    }
  }
}

// ============================================
// Contract Deployment
// ============================================

// MockERC20 ABI - compiled from packages/contracts/test/mocks/MockERC20.sol
const MOCK_ERC20_ABI = [
  'constructor(string _name, string _symbol, uint8 _decimals)',
  'function name() view returns (string)',
  'function symbol() view returns (string)',
  'function decimals() view returns (uint8)',
  'function totalSupply() view returns (uint256)',
  'function balanceOf(address) view returns (uint256)',
  'function transfer(address to, uint256 value) returns (bool)',
  'function approve(address spender, uint256 value) returns (bool)',
  'function allowance(address, address) view returns (uint256)',
  'function transferFrom(address from, address to, uint256 value) returns (bool)',
  'event Transfer(address indexed from, address indexed to, uint256 value)',
  'event Approval(address indexed owner, address indexed spender, uint256 value)',
];

// MockERC20 bytecode - compiled from packages/contracts/test/mocks/MockERC20.sol with Forge
// Initial supply: 1,000,000 tokens (with configurable decimals) minted to deployer
const MOCK_ERC20_BYTECODE =
  '0x6080604052346200034a5762000a5e803803806200001d816200034e565b9283398101906060818303126200034a5780516001600160401b03908181116200034a57836200004f91840162000374565b602093848401518381116200034a576040916200006e91860162000374565b9301519160ff83168093036200034a5781519381851162000268575f54946001938487811c971680156200033f575b8888101462000249578190601f97888111620002ec575b50889088831160011462000288575f926200027c575b50505f19600383901b1c191690841b175f555b8051918211620002685782548381811c911680156200025d575b87821014620002495785811162000201575b5085948211600114620001a05793819293945f9262000194575b50505f19600383901b1c191690821b1790555b8060ff196002541617600255604d81116200018057600a0a90620f42409180830292830403620001805760049082600355335f525260405f20556040516106799081620003e58239f35b634e487b7160e01b5f52601160045260245ffd5b015190505f8062000123565b601f19821694835f52865f20915f5b88888210620001ec5750508385969710620001d3575b505050811b01905562000136565b01515f1960f88460031b161c191690555f8080620001c5565b828401518555938601939283019201620001af565b835f52865f208680850160051c8201928986106200023f575b0160051c019084905b8281106200023357505062000109565b5f815501849062000223565b925081926200021a565b634e487b7160e01b5f52602260045260245ffd5b90607f1690620000f7565b634e487b7160e01b5f52604160045260245ffd5b015190505f80620000ca565b90869350601f198316915f80528a5f20925f5b8c828210620002d55750508411620002bc575b505050811b015f55620000dd565b01515f1960f88460031b161c191690555f8080620002ae565b8385015186558a979095019493840193016200029b565b9091505f8052885f208880850160051c8201928b861062000335575b918891869594930160051c01915b82811062000326575050620000b4565b5f815585945088910162000316565b9250819262000308565b96607f16966200009d565b5f80fd5b6040519190601f01601f191682016001600160401b038111838210176200026857604052565b919080601f840112156200034a5782516001600160401b0381116200026857602090620003aa601f8201601f191683016200034e565b928184528282870101116200034a575f5b818110620003d05750825f9394955001015290565b8581018301518482018401528201620003bb56fe6080604090808252600480361015610015575f80fd5b5f3560e01c91826306fdde031461048a57508163095ea7b31461041c57816318160ddd146103fe57816323b872dd146102e1578163313ce567146102c057816370a082311461028b57816395d89b4114610169578163a9059cbb146100cf575063dd62ed3e14610083575f80fd5b346100cb57806003193601126100cb5760209061009e6105a6565b6100a66105bc565b9060018060a01b038091165f5260058452825f2091165f528252805f20549051908152f35b5f80fd5b82346100cb57806003193601126100cb576020916100eb6105a6565b60243590335f5282855261010482855f205410156105d2565b335f52828552835f20610118838254610615565b905560018060a01b031691825f528452825f20610136828254610636565b905582519081527fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef843392a35160018152f35b82346100cb575f3660031901126100cb578051905f60018054908160011c9060018316928315610281575b602093848410811461026e5783885290811561025257506001146101fc575b505050829003601f01601f191682019267ffffffffffffffff8411838510176101e957508291826101e592528261055f565b0390f35b604190634e487b7160e01b5f525260245ffd5b60015f908152929350837fb10e2d527612073b26eecdfd717e6a320cf44b4afac2b0732d9fcbe2b7fa0cf65b83851061023e57505050508301018480806101b3565b805488860183015293019284908201610228565b60ff1916878501525050151560051b84010190508480806101b3565b602289634e487b7160e01b5f525260245ffd5b91607f1691610194565b82346100cb5760203660031901126100cb576020916001600160a01b036102b06105a6565b165f528252805f20549051908152f35b82346100cb575f3660031901126100cb5760209060ff600254169051908152f35b82346100cb5760603660031901126100cb576102fb6105a6565b916103046105bc565b9260443560018060a01b0380921691825f5260209584875261032b83875f205410156105d2565b835f5260058752855f20335f52875282865f2054106103c2579186917fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef93855f52868452875f2061037d848254610615565b90551694855f528252855f20610394828254610636565b9055835f5260058252855f20335f528252855f206103b3828254610615565b90558551908152a35160018152f35b855162461bcd60e51b81528086018890526016602482015275496e73756666696369656e7420616c6c6f77616e636560501b6044820152606490fd5b82346100cb575f3660031901126100cb576020906003549051908152f35b82346100cb57806003193601126100cb576020906104386105a6565b602435335f5260058452825f209160018060a01b031691825f52845280835f205582519081527f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925843392a35160018152f35b83346100cb575f3660031901126100cb575f805460018160011c9060018316928315610555575b602093848410811461026e57838852908115610252575060011461050157505050829003601f01601f191682019267ffffffffffffffff8411838510176101e957508291826101e592528261055f565b5f808052929350837f290decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e5635b83851061054157505050508301018480806101b3565b80548886018301529301928490820161052b565b91607f16916104b1565b602080825282518183018190529093925f5b82811061059257505060409293505f838284010152601f8019910116010190565b818101860151848201604001528501610571565b600435906001600160a01b03821682036100cb57565b602435906001600160a01b03821682036100cb57565b156105d957565b60405162461bcd60e51b8152602060048201526014602482015273496e73756666696369656e742062616c616e636560601b6044820152606490fd5b9190820391821161062257565b634e487b7160e01b5f52601160045260245ffd5b919082018092116106225756fea26469706673582212205933fde19cbb69f2cccc4f75287d18e1bba74e57ee228dc52a228763eb68bac664736f6c63430008180033';

/**
 * Deploy the AGENT token contract.
 *
 * @param deployer - Deployer wallet
 * @param name - Token name
 * @param symbol - Token symbol
 * @returns Token contract address
 */
export async function deployAgentToken(
  deployer: ethers.Wallet,
  name: string,
  symbol: string
): Promise<string> {
  const factory = new ethers.ContractFactory(MOCK_ERC20_ABI, MOCK_ERC20_BYTECODE, deployer);
  // Deploy with name, symbol, and 18 decimals
  const token = await factory.deploy(name, symbol, 18);
  await token.waitForDeployment();
  return token.target as string;
}

/**
 * Transfer tokens to all peers.
 *
 * @param tokenAddress - Token contract address
 * @param deployer - Deployer wallet (has initial supply)
 * @param peers - Peers to fund
 * @param amountPerPeer - Amount to send to each peer
 */
export async function fundPeers(
  tokenAddress: string,
  deployer: ethers.Wallet,
  peers: AgentPeer[],
  amountPerPeer: bigint
): Promise<void> {
  const token = new ethers.Contract(
    tokenAddress,
    ['function transfer(address to, uint256 value) returns (bool)'],
    deployer
  );

  // Get the current nonce to avoid caching issues
  let nonce = await deployer.getNonce();

  for (const peer of peers) {
    const tx = await token.getFunction('transfer')(peer.evmWallet.address, amountPerPeer, {
      nonce: nonce++,
    });
    await tx.wait();
  }
}

/**
 * Fund peers with ETH for gas fees.
 *
 * @param deployer - Deployer wallet (has ETH)
 * @param peers - Peers to fund
 * @param amountPerPeer - ETH amount per peer (e.g., ethers.parseEther("0.1"))
 */
export async function fundPeersWithEth(
  deployer: ethers.Wallet,
  peers: AgentPeer[],
  amountPerPeer: bigint
): Promise<void> {
  let nonce = await deployer.getNonce();

  for (const peer of peers) {
    const tx = await deployer.sendTransaction({
      to: peer.evmWallet.address,
      value: amountPerPeer,
      nonce: nonce++,
    });
    await tx.wait();
  }
}

// ============================================
// Payment Channels
// ============================================

// TokenNetworkRegistry ABI - minimal interface for deployment and token network creation
const TOKEN_NETWORK_REGISTRY_ABI = [
  'constructor()',
  'function createTokenNetwork(address token) returns (address)',
  'function token_to_token_networks(address token) view returns (address)',
  'function getTokenNetwork(address token) view returns (address)',
  'event TokenNetworkCreated(address indexed token, address indexed tokenNetwork)',
];

// TokenNetworkRegistry bytecode - compiled from packages/contracts/src/TokenNetworkRegistry.sol with Forge
// NOTE: This bytecode must be regenerated if the contract source changes using:
// forge inspect TokenNetworkRegistry bytecode
const TOKEN_NETWORK_REGISTRY_BYTECODE =
  '0x60808060405234610078573315610063575f8054336001600160a01b03198216811783556040519290916001600160a01b0316907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e09080a3612f94908161007d8239f35b631e4fbdf760e01b81525f6004820152602490fd5b5f80fdfe608060408181526004918236101562000016575f80fd5b5f3560e01c9081630fabd9e714620006e157508063306275be14620006755780633f4ba83a146200060357806351fb012d14620005e05780635c975abb14620005b9578063715018a6146200055e5780638456cb5914620004fa5780638da5cb5b14620004d1578063981005a2146200049157806398f44a1214620003035780639e45511914620002c3578063cdfb2b4e1462000275578063d6b0f484146200022a578063d84c1b3814620001bb578063daf9c21014620001785763f2fde38b14620000e0575f80fd5b346200017457602036600319011262000174576001600160a01b038235818116939192908490036200017457620001166200071f565b83156200015e5750505f54826bffffffffffffffffffffffff60a01b8216175f55167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e05f80a3005b905f6024925191631e4fbdf760e01b8352820152fd5b5f80fd5b509034620001745760203660031901126200017457356001600160a01b038116919082900362000174576020915f526003825260ff815f20541690519015158152f35b509034620001745760203660031901126200017457356001600160a01b03811691908290036200017457620001ef6200071f565b815f5260036020525f20600160ff198254161790557f6a65f90b1a644d2faac467a21e07e50e3f8fa5846e26231d30ae79a417d3d2625f80a2005b823462000174575f3660031901126200017457620002476200071f565b805460ff191690557f212c6e1d3045c9581ef0adf2504dbb1d137f52f38162ccf77a16c69d14eba5c35f80a1005b823462000174575f3660031901126200017457620002926200071f565b805460ff191660011790557fe5e5846f783279948f6ec5faad38318cde86fe5be7ea845ede56d62f16c374345f80a1005b509034620001745760203660031901126200017457356001600160a01b03818116929183900362000174576020925f5260018352815f2054169051908152f35b5034620001745760209182600319360112620001745780356001600160a01b03818116939184900362000174576200033a6200074b565b8315620004835760ff835416806200046d575b6200045f57835f526001855280825f205416620004495781516127f28082019082821067ffffffffffffffff831117620004365760609183916200076d833987815269d3c21bcecceda1000000898201526301e13380868201520301905ff080156200042c57169182156200041e57508190835f5260018552805f206bffffffffffffffffffffffff60a01b908382825416179055825f526002865284825f209182541617905551927ff11a7558a113d9627989c5edf26cbd19143b7375248e621c8e30ac9e0847dc3f5f80a38152f35b905163111139af60e01b8152fd5b82513d5f823e3d90fd5b604186634e487b7160e01b5f525260245ffd5b509160249251916307f60e1360e01b8352820152fd5b50516307c241ad60e51b8152fd5b50835f526003855260ff825f205416156200034d565b5051630f58058360e11b8152fd5b509034620001745760203660031901126200017457356001600160a01b03818116929183900362000174576020925f5260028352815f2054169051908152f35b503462000174575f36600319011262000174575f5490516001600160a01b039091168152602090f35b503462000174575f366003190112620001745760207f62e78cea01bee320cd4e420270b5ea74000d11b0c9f74754ebdbfc544b05a258916200053b6200071f565b620005456200074b565b5f805460ff60a01b1916600160a01b17905551338152a1005b3462000174575f36600319011262000174576200057a6200071f565b5f80546001600160a01b0319811682556001600160a01b03167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e08280a3005b503462000174575f366003190112620001745760209060ff5f5460a01c1690519015158152f35b503462000174575f366003190112620001745760ff602092541690519015158152f35b503462000174575f3660031901126200017457620006206200071f565b5f549160ff8360a01c1615620006675760ff60a01b1983165f5581513381527f5db9ee0a495bf2e6ff9c91a7834c1ba4fdd244a5e8aa4e537bd38aeae4b073aa90602090a1005b9051638dfc202b60e01b8152fd5b509034620001745760203660031901126200017457356001600160a01b03811691908290036200017457620006a96200071f565b815f5260036020525f2060ff1981541690557fdd2e6d9f52cbe8f695939d018b7d4a216dc613a669876163ac548b916489d9175f80a2005b905082346200017457602036600319011262000174576001600160a01b039035818116939084900362000174576020935f52600184525f2054168152f35b5f546001600160a01b031633036200073357565b60405163118cdaa760e01b8152336004820152602490fd5b60ff5f5460a01c166200075a57565b60405163d93c066560e01b8152600490fdfe6101c034620002a0576001600160401b0390601f620027f238819003918201601f191683019190848311848410176200028c578160609285926040958652833981010312620002a05781516001600160a01b0392908381168103620002a057826020830151920151928051906200007682620002a4565b600c825260208201906b546f6b656e4e6574776f726b60a01b82528051976200009f89620002a4565b6001895260208901603160f81b815260017f9b779b17422d0df92223018b32b4d1fa46e071723d6817e2486d003becc55f0055620000dd85620002c0565b93610120948552620000ef8b6200048a565b95610140968752519020998a60e05251902061010099818b524660a05283519160208301917f8b73c3c69bb8fe3d512ecc4cf759cc79239f7b179b0ffacaa9a75d522b39400f83528584015260608301524660808301523060a083015260a0825260c0820192828410908411176200028c57828452815190206080523060c05233156200027657505060028054610100600160a81b0319811633600881811b610100600160a81b03169290921790935592519891921c167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e05f80a36101609283526101809384526101a09485526121c0968762000632883960805187611d50015260a05187611e0b015260c05187611d1a015260e05187611d9f01525186611dc501525185610ed201525184610efb0152518381816102cc0152818161030001528181610369015281816109da01528181610a0e01528181610ae101528181610d290152611291015251828181610e9a0152611340015251818181611149015261172e0152f35b631e4fbdf760e01b82525f60c490910152602490fd5b634e487b7160e01b5f52604160045260245ffd5b5f80fd5b604081019081106001600160401b038211176200028c57604052565b8051602090818110156200035a5750601f825111620002fb5780825192015190808310620002ed57501790565b825f19910360031b1b161790565b90604051809263305a27a960e01b82528060048301528251908160248401525f935b82851062000340575050604492505f838284010152601f80199101168101030190fd5b84810182015186860160440152938101938593506200031d565b906001600160401b0382116200028c575f54926001938481811c911680156200047f575b838210146200046b57601f811162000435575b5081601f8411600114620003cf57509282939183925f94620003c3575b50501b915f199060031b1c1916175f5560ff90565b015192505f80620003ae565b919083601f1981165f8052845f20945f905b888383106200041a575050501062000401575b505050811b015f5560ff90565b01515f1960f88460031b161c191690555f8080620003f4565b858701518855909601959485019487935090810190620003e1565b5f805284601f845f20920160051c820191601f860160051c015b8281106200045f57505062000391565b5f81550185906200044f565b634e487b7160e01b5f52602260045260245ffd5b90607f16906200037e565b805160209081811015620005165750601f825111620004b75780825192015190808310620002ed57501790565b90604051809263305a27a960e01b82528060048301528251908160248401525f935b828510620004fc575050604492505f838284010152601f80199101168101030190fd5b8481018201518686016044015293810193859350620004d9565b9192916001600160401b0381116200028c5760019182548381811c9116801562000626575b828210146200046b57601f8111620005f0575b5080601f83116001146200058c5750819293945f9262000580575b50505f19600383901b1c191690821b17905560ff90565b015190505f8062000569565b90601f19831695845f52825f20925f905b888210620005d85750508385969710620005bf575b505050811b01905560ff90565b01515f1960f88460031b161c191690555f8080620005b2565b8087859682949686015181550195019301906200059d565b835f5283601f835f20920160051c820191601f850160051c015b8281106200061a5750506200054e565b5f81550184906200060a565b90607f16906200053b56fe60a06040526004361015610011575f80fd5b5f3560e01c806324f453d1146117b85780632e9637e0146116da578063365473c61461149357806336bcdb80146111d55780633f4ba83a1461116c5780634c8b9fc8146111325780635a104746146111155780635c975abb146110f3578063715018a6146110945780637a7ebd7b1461101d5780638456cb5914610fc457806384b0196e14610ebd57806387d9871714610e835780638da5cb5b14610e57578063a79a2c7814610de2578063b62e9e9b14610bac578063bf32097c14610a96578063c76701c3146106b6578063db96157d1461069a578063f2fde38b14610603578063fa29f75214610398578063fc0c546a146103545763fd3d319914610116575f80fd5b34610350576020806003193601126103505760043590610134611bf7565b61013c611c26565b815f526004815260405f20906001820191825492600260ff851661015f81611b37565b0361033e576101746002830154835490611b93565b421061032c578492835f52600580825260405f2095600160a01b600190038060048701541697885f52845260405f205492875f5280855260405f20895f52855260405f206001015496885f5281865260405f208a5f52865260405f206004015491895f52808752828160405f209301968588541693845f52895260405f20600401549384938d5f52808b5260405f20825f528b5260405f20549d5f528a5260405f20905f52895260405f20600101549a61022d91611bea565b9061023791611bea565b9061024191611b93565b98899861024d91611bea565b9061025791611bea565b9061026191611b93565b94859260ff19166003179055851515976040977ff94fb5c0628a82dc90648e8dc5e983f632633b0d26603d64e8cc042ca0790aa4996102f9575b5050816102c2575b5050508351928352820152a260015f8051602061216b83398151915255005b806102f1935416907f000000000000000000000000000000000000000000000000000000000000000016611c99565b5f82816102a3565b61032591837f000000000000000000000000000000000000000000000000000000000000000016611c99565b5f8661029b565b6040516385986a1760e01b8152600490fd5b60405163f806e9d960e01b8152600490fd5b5f80fd5b34610350575f366003190112610350576040517f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03168152602090f35b34610350576103a636611ac7565b6103b1929192611bf7565b6103b9611c26565b815f526020926004845260405f2060018101600160ff8254166103db81611b37565b0361033e5760048201546001600160a01b039081163381148015806105f3575b6105e157156105db575080600584015416935b868151036105c95780889151928282019681885199604085019687519b606087019788519760800197885191604051608052608051019e8f936080519561045495611ba0565b039a601f199b8c8101608051526080519061046e91611a4f565b60805151902061047d90611c44565b9061048791611e31565b61049391949294611e6b565b1691829116036105b757885f5260058a5260405f20815f528a52600360405f200154875111156105a5576001978a6105456002968c61055195815f526005855260405f20335f5285528960405f200160ff199e8f8254161790558c51825f526005865260405f20825f528652600360405f2001558251915f526005855260405f20905f528452600460405f20015551955194516040519586938401978891606093918352602083015260408201520190565b03908101835282611a4f565b5190209482541617905560024291015551926040519384528301527fd5957384eab5a0d19edc418bd26b5a30bf723c432b8ec504bb3153db8d8f921760403393a360015f8051602061216b83398151915255005b604051633ab3447f60e11b8152600490fd5b604051638baa579f60e01b8152600490fd5b604051631cfb46fb60e21b8152600490fd5b9361040e565b6040516350a2e21f60e11b8152600490fd5b50826005860154163314156103fb565b346103505760203660031901126103505761061c6119cf565b610624611c6a565b6001600160a01b038181169182156106825760028054610100600160a81b03198116600893841b610100600160a81b031617909155901c167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e05f80a3005b604051631e4fbdf760e01b81525f6004820152602490fd5b34610350575f366003190112610350576020604051610e108152f35b34610350576101a03660031901126103505760a0366023190112610350576040516106e0816119fb565b602435815260443560208201526064356040820152608435606082015260a435608082015267ffffffffffffffff9060c43582811161035057610727903690600401611a71565b60a03660e31901126103505760405192610740846119fb565b60e43584526101043560208501526101243560408501526101443560608501526101643560808501526101843590811161035057610782903690600401611a71565b61078a611bf7565b610792611c26565b6004355f52600460205260405f20600181015491600160ff84166107b581611b37565b0361033e57600435855114801590610a89575b6105c9576020850151602087015103610a77576108736108409161083761087c9661083289518a61082a602082015161081c6040840151936080606082015191015190604051958694602086019889611ba0565b03601f198101835282611a4f565b519020611c44565b611e31565b90949194611e6b565b610832885160208a015161082a60408c01519161081c8d6080606082015191015190604051958694602086019889611ba0565b90959195611e6b565b60018060a01b03918280600483015416921696828814908160058401978587808b5416809d14921683610a6d575b8315610a4f575b505050156105b7576004355f52600560205260405f20845f5260205260405f2054906004355f52600560205260405f20855f5260205260405f2060010154986004355f52600560205260405f208b5f5260205260405f20549a6004355f52600560205260405f20905f5260205260405f2060010154935f149961095d60019561096761096d9661096260039f9761096297604099610a3a578961095d910151998a920151978894611bea565b611bea565b611b93565b9d611bea565b96879560ff1916179101558580610a07575b5050816109d0575b50505060405191825260208201527ffb2f4bc0fb2e0f1001f78d15e81a2e1981f262d31e8bd72309e26cc63bf7bb02604060043592a260015f8051602061216b83398151915255005b806109ff935416907f000000000000000000000000000000000000000000000000000000000000000016611c99565b828181610987565b610a3391837f000000000000000000000000000000000000000000000000000000000000000016611c99565b858561097f565b908961095d910151998a920151978894611bea565b9192509082610a63575b50508a85816108b1565b149050848b610a59565b8c811493506108aa565b60405163e112ed9160e01b8152600490fd5b50600435865114156107c8565b3461035057604036600319011261035057610aaf6119e5565b610ab7611c6a565b60ff6002541615610b9a576040516370a0823160e01b8152306004820152906001600160a01b03907f00000000000000000000000000000000000000000000000000000000000000008216602084602481845afa938415610b8f575f94610b57575b508382610b2592611c99565b60405192835216907f668ede93de2924e11e5554ea95dd0839a40ddf58c1f04b209fde0dc8298a75c8602060043592a3005b909193506020813d602011610b87575b81610b7460209383611a4f565b8101031261035057519290610b25610b19565b3d9150610b67565b6040513d5f823e3d90fd5b60405163dcdde9dd60e01b8152600490fd5b346103505760803660031901126103505760443560043560243567ffffffffffffffff60643581811161035057610be7903690600401611a71565b93610bf0611bf7565b610bf8611c26565b835f526020916004835260405f2095600160ff8189015416610c1981611b37565b0361033e5760048701546001600160a01b03973391891691821491821580610dd2575b6105e157899215610dca575060050154165b60405190608082019382851090851117610db65761087389938660608695610cd5986040528c8152338b8201528b60408201520152610832604051898101907f3a313e46ac850ea3171e09169e25e22c511e6ca6e78188b6007f76435ce3dcad82528c60408201523360608201528b60808201528960a082015260a0815261082a81611a17565b169116036105b757835f526005825260405f20335f52825260405f20600381019081548311156105a5576001810180549182871115610da457548611610d9257610d4e610d23879384611bea565b809933907f000000000000000000000000000000000000000000000000000000000000000016611c99565b55556040519384528301527fe3dc7feadbd67893939d3a39c2e030d48267965cc32664a5ad07a8dd18bf16fd60403393a360015f8051602061216b83398151915255005b604051634d6416c960e01b8152600490fd5b60405163179b08df60e31b8152600490fd5b634e487b7160e01b5f52604160045260245ffd5b915050610c4e565b5089600583015416331415610c3c565b3461035057604036600319011261035057610dfb6119e5565b6004355f52600560205260405f209060018060a01b03165f5260205260a060405f2080549060018101549060ff600282015416600460038301549201549260405194855260208501521515604084015260608301526080820152f35b34610350575f3660031901126103505760025460405160089190911c6001600160a01b03168152602090f35b34610350575f3660031901126103505760206040517f00000000000000000000000000000000000000000000000000000000000000008152f35b34610350575f36600319011261035057610ef67f0000000000000000000000000000000000000000000000000000000000000000611ef6565b610f1f7f0000000000000000000000000000000000000000000000000000000000000000612017565b60405160208082019282841067ffffffffffffffff851117610db657916020610f798594610f6b97966040525f8452604051978897600f60f81b895260e0858a015260e0890190611b55565b908782036040890152611b55565b914660608701523060808701525f60a087015285830360c087015251918281520192915f5b828110610fad57505050500390f35b835185528695509381019392810192600101610f9e565b34610350575f36600319011261035057610fdc611c6a565b610fe4611c26565b600160ff1960025416176002557f62e78cea01bee320cd4e420270b5ea74000d11b0c9f74754ebdbfc544b05a2586020604051338152a1005b34610350576020366003190112610350576004355f52600460205260c060405f2080549060ff60018201541690600281015460038201549060018060a01b03600581600486015416940154169360405195865261107981611b37565b602086015260408501526060840152608083015260a0820152f35b34610350575f366003190112610350576110ac611c6a565b60028054610100600160a81b031981169091555f9060081c6001600160a01b03167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e08280a3005b34610350575f36600319011261035057602060ff600254166040519015158152f35b34610350575f366003190112610350576020600354604051908152f35b34610350575f3660031901126103505760206040517f00000000000000000000000000000000000000000000000000000000000000008152f35b34610350575f36600319011261035057611184611c6a565b60025460ff8116156111c35760ff19166002557f5db9ee0a495bf2e6ff9c91a7834c1ba4fdd244a5e8aa4e537bd38aeae4b073aa6020604051338152a1005b604051638dfc202b60e01b8152600490fd5b34610350576060366003190112610350576004356111f16119e5565b906044356111fd611bf7565b611205611c26565b815f526020906004825260405f2090600160ff818401541661122681611b37565b0361033e5760048201546001600160a01b03958616959290831686141590839082611482575b50506105e157835f526005835260405f20855f52835260405f205490818110611470578161127991611bea565b6040516370a0823160e01b80825230600483015290937f000000000000000000000000000000000000000000000000000000000000000016918585602481865afa948515610b8f575f95611441575b50604051906323b872dd60e01b5f523360045230602452604452855f60648180875af160015f5114811615611422575b816040525f6060521561140c5750849060246040518094819382523060048301525afa908115610b8f575f916113dd575b5061133d9261133791611bea565b90611b93565b907f000000000000000000000000000000000000000000000000000000000000000082116113cb577f0346e981e2bfa2366dc2307a8f1fa24779830a01121b1275fe565c6b98bb4d3491835f526005825260405f20855f52825260405f2055825f526005815260405f20845f52815260405f2054604051908152a360015f8051602061216b83398151915255005b604051630d5befc560e31b8152600490fd5b90508381813d8311611405575b6113f48183611a4f565b81010312610350575161133d611329565b503d6113ea565b635274afe760e01b815260048101839052602490fd5b600181151661143857833b15153d1516166112f8565b503d5f823e3d90fd5b9094508581813d8311611469575b6114598183611a4f565b81010312610350575193886112c8565b503d61144f565b60405163070f6eed60e11b8152600490fd5b60050154168614159050828761124c565b34610350576114a136611ac7565b91906114ab611bf7565b6114b3611c26565b815f526020926004845260405f2091600260ff6001850154166114d581611b37565b0361033e57835f5260059283865260405f20335f52865260ff600260405f200154166116c95760048101546001600160a01b03919082169033821415806116ba575b6105e15761152b6002820154825490611b93565b4210156116a857858391885f52818a5260405f20845f528a5260ff600260405f200154165f1461169e575050505b858351036105c957825193878401958651928460408701938451958c60608a019a8b519a6080019a8b51906040519a8b948501956115979487611ba0565b0396601f199788810182526115ac9082611a4f565b5190206115b890611c44565b906115c291611e31565b6115ce91949294611e6b565b1694859116036105b757875f5280895260405f20845f528952600360405f200154875111156105a557611656938751895f52828b5260405f20825f528b52600360405f200155825191895f528a5260405f20905f528952600460405f2001555193519251926105456040519485928a8401978891606093918352602083015260408201520190565b5190209051926040519384528301527fa74d11e70725a216b7835e4eccc704900e38620c7254d1b5fe3811f064a4244660403393a360015f8051602061216b83398151915255005b0154169050611559565b604051637222b06b60e11b8152600490fd5b50828682015416331415611517565b6040516298465360e81b8152600490fd5b34610350576020366003190112610350576004356116f6611bf7565b6116fe611c26565b805f52600460205260405f20600181018054600160ff821661171f81611b37565b0361033e5761175360038401547f000000000000000000000000000000000000000000000000000000000000000090611b93565b42106117a65760029060ff19161790556002429101557fa3d9abb459f23bad7e2b9ad2f9bb6f56d3b2d3e3958c2e97fae66e35fcae56de6020604051428152a260015f8051602061216b83398151915255005b60405163d56b7c9760e01b8152600490fd5b34610350576040366003190112610350576117d16119cf565b602435906117dd611bf7565b6117e5611c26565b6001600160a01b039080821680156105e1578033146105e157610e1084106119bd573310156119b657335b6003549260405194602095868101838516946bffffffffffffffffffffffff19809160601b1682528487169660601b16603483015286604883015260488252608082019167ffffffffffffffff9281811084821117610db657604052519020955f1981146119a257600101600355855f526004875260ff600160405f2001541661189981611b37565b611990576040519160c0830191821183831017610db65786937f448d27f1fe12f92a2070111296e68fd6ef0a01c0e05bf5819eda0dbcf267bf3d9389936040528281528381019160018352600560408301925f84526060810142815260808201948b865260a08301968d88528b5f5260048a5260405f209351845560018401905161192381611b37565b61192c81611b37565b60ff801983541691161790555160028301555160038201558260048201945116936bffffffffffffffffffffffff60a01b94858254161790550192511690825416179055604051908152a460015f8051602061216b83398151915255604051908152f35b604051630ec0f14960e01b8152600490fd5b634e487b7160e01b5f52601160045260245ffd5b3390611810565b60405163579d2e9960e01b8152600490fd5b600435906001600160a01b038216820361035057565b602435906001600160a01b038216820361035057565b60a0810190811067ffffffffffffffff821117610db657604052565b60c0810190811067ffffffffffffffff821117610db657604052565b6040810190811067ffffffffffffffff821117610db657604052565b90601f8019910116810190811067ffffffffffffffff821117610db657604052565b81601f820112156103505780359067ffffffffffffffff8211610db65760405192611aa6601f8401601f191660200185611a4f565b8284526020838301011161035057815f926020809301838601378301015290565b60e0600319820112610350576004359160a060231983011261035057604051611aef816119fb565b602435815260443560208201526064356040820152608435606082015260a43560808201529160c4359067ffffffffffffffff821161035057611b3491600401611a71565b90565b60041115611b4157565b634e487b7160e01b5f52602160045260245ffd5b91908251928382525f5b848110611b7f575050825f602080949584010152601f8019910116010190565b602081830181015184830182015201611b5f565b919082018092116119a257565b919260a093969594919660c08401977f716df000aa2a680ba0826f710c1641c4d9fbef21b69b995e39fe4dd74da178cb855260208501526040840152606083015260808201520152565b919082039182116119a257565b5f8051602061216b8339815191526002815414611c145760029055565b604051633ee5aeb560e01b8152600490fd5b60ff60025416611c3257565b60405163d93c066560e01b8152600490fd5b604290611c4f611d17565b906040519161190160f01b8352600283015260228201522090565b60025460081c6001600160a01b03163303611c8157565b60405163118cdaa760e01b8152336004820152602490fd5b60405163a9059cbb60e01b5f9081526001600160a01b039384166004526024949094529260209060448180855af160015f5114811615611cf8575b8360405215611ce257505050565b635274afe760e01b835216600482015260249150fd5b6001811516611d0e57813b15153d151616611cd4565b833d5f823e3d90fd5b307f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03161480611e08575b15611d72577f000000000000000000000000000000000000000000000000000000000000000090565b60405160208101907f8b73c3c69bb8fe3d512ecc4cf759cc79239f7b179b0ffacaa9a75d522b39400f82527f000000000000000000000000000000000000000000000000000000000000000060408201527f000000000000000000000000000000000000000000000000000000000000000060608201524660808201523060a082015260a08152611e0281611a17565b51902090565b507f00000000000000000000000000000000000000000000000000000000000000004614611d49565b8151919060418303611e6157611e5a9250602082015190606060408401519301515f1a906120e8565b9192909190565b50505f9160029190565b611e7481611b37565b80611e7d575050565b611e8681611b37565b60018103611ea05760405163f645eedf60e01b8152600490fd5b611ea981611b37565b60028103611eca5760405163fce698f760e01b815260048101839052602490fd5b80611ed6600392611b37565b14611ede5750565b602490604051906335e2f38360e21b82526004820152fd5b60ff8114611f345760ff811690601f8211611f225760405191611f1883611a33565b8252602082015290565b604051632cd44ac360e21b8152600490fd5b506040515f8054906001908260011c6001841692831561200d575b6020948583108514611ff9578287528694908115611fd95750600114611f7e575b5050611b3492500382611a4f565b5f8080527f290decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e56395935091905b818310611fc1575050611b3493508201015f80611f70565b85548784018501529485019486945091830191611fa9565b915050611b3494925060ff191682840152151560051b8201015f80611f70565b634e487b7160e01b5f52602260045260245ffd5b90607f1690611f4f565b60ff81146120395760ff811690601f8211611f225760405191611f1883611a33565b506040515f60018054918260011c600184169283156120de575b6020948583108514611ff9578287528694908115611fd95750600114612081575050611b3492500382611a4f565b9093915060015f527fb10e2d527612073b26eecdfd717e6a320cf44b4afac2b0732d9fcbe2b7fa0cf6935f915b8183106120c6575050611b3493508201015f80611f70565b855487840185015294850194869450918301916120ae565b90607f1690612053565b91907f7fffffffffffffffffffffffffffffff5d576e7357a4501ddfe92f46681b20a0841161215f579160209360809260ff5f9560405194855216868401526040830152606082015282805260015afa15610b8f575f516001600160a01b0381161561215557905f905f90565b505f906001905f90565b5050505f916003919056fe9b779b17422d0df92223018b32b4d1fa46e071723d6817e2486d003becc55f00a26469706673582212203c0fa53b2d411f91f12b4b3ce8f0f2930b7f442eaed6263673d4dc9e3154c32164736f6c63430008180033a2646970667358221220f9a16d1c8c247d79d6b932f2221d96bb4097553a447fbd3342f2bcddd7eb699464736f6c63430008180033';

// TokenNetwork ABI - minimal interface for channel operations
// Note: openChannel takes participant2 (msg.sender is participant1)
const TOKEN_NETWORK_ABI = [
  'function openChannel(address participant2, uint256 settlementTimeout) returns (bytes32)',
  'function setTotalDeposit(bytes32 channelId, address participant, uint256 totalDeposit)',
  // Auto-generated getters for public mappings
  'function channels(bytes32 channelId) view returns (uint256 settlementTimeout, uint8 state, uint256 closedAt, uint256 openedAt, address participant1, address participant2)',
  'function participants(bytes32 channelId, address participant) view returns (uint256 deposit, uint256 withdrawnAmount, bool isCloser, uint256 nonce, uint256 transferredAmount)',
  'event ChannelOpened(bytes32 indexed channelId, address indexed participant1, address indexed participant2, uint256 settlementTimeout)',
];

/**
 * Deploy the TokenNetworkRegistry contract.
 *
 * @param deployer - Deployer wallet
 * @returns Registry contract address
 */
export async function deployTokenNetworkRegistry(deployer: ethers.Wallet): Promise<string> {
  const factory = new ethers.ContractFactory(
    TOKEN_NETWORK_REGISTRY_ABI,
    TOKEN_NETWORK_REGISTRY_BYTECODE,
    deployer
  );
  const registry = await factory.deploy();
  await registry.waitForDeployment();
  return registry.target as string;
}

/**
 * Create a TokenNetwork for a specific token via the registry.
 *
 * @param registryAddress - TokenNetworkRegistry address
 * @param tokenAddress - ERC20 token address
 * @param deployer - Deployer wallet
 * @returns TokenNetwork contract address
 */
export async function createTokenNetwork(
  registryAddress: string,
  tokenAddress: string,
  deployer: ethers.Wallet
): Promise<string> {
  const registry = new ethers.Contract(registryAddress, TOKEN_NETWORK_REGISTRY_ABI, deployer);

  // Check if token network already exists
  const existingNetwork = (await registry.getFunction('getTokenNetwork')(tokenAddress)) as string;
  if (existingNetwork !== ethers.ZeroAddress) {
    return existingNetwork;
  }

  // Create new token network
  const tx = await registry.getFunction('createTokenNetwork')(tokenAddress);
  const receipt = await tx.wait();

  // Find the TokenNetworkCreated event
  const iface = new ethers.Interface(TOKEN_NETWORK_REGISTRY_ABI);
  for (const log of receipt.logs) {
    try {
      const parsed = iface.parseLog(log);
      if (parsed && parsed.name === 'TokenNetworkCreated') {
        return parsed.args[1] as string; // tokenNetwork address
      }
    } catch {
      // Skip logs that don't match our ABI
    }
  }

  // Fallback: query the registry
  return (await registry.getFunction('getTokenNetwork')(tokenAddress)) as string;
}

/**
 * Approve TokenNetwork to spend tokens for all peers.
 *
 * @param tokenAddress - ERC20 token address
 * @param tokenNetworkAddress - TokenNetwork address
 * @param peers - Peers to approve
 * @param approvalAmount - Amount to approve
 */
export async function approvePeerTokens(
  tokenAddress: string,
  tokenNetworkAddress: string,
  peers: AgentPeer[],
  approvalAmount: bigint
): Promise<void> {
  const tokenAbi = ['function approve(address spender, uint256 value) returns (bool)'];

  for (const peer of peers) {
    const token = new ethers.Contract(tokenAddress, tokenAbi, peer.evmWallet);
    const tx = await token.getFunction('approve')(tokenNetworkAddress, approvalAmount);
    await tx.wait();
  }
}

/**
 * Open payment channels between connected peers based on social graph.
 * One peer from each pair opens the channel (msg.sender = participant1).
 *
 * @param tokenNetworkAddress - TokenNetwork address
 * @param peers - All peers
 * @param topology - Social graph topology
 * @param settlementTimeout - Channel settlement timeout in seconds
 * @returns Map of channel IDs keyed by "peer1-peer2" (sorted)
 */
export async function openPaymentChannels(
  tokenNetworkAddress: string,
  peers: AgentPeer[],
  topology: SocialGraphTopology,
  settlementTimeout: number
): Promise<Map<string, string>> {
  const channelMap = new Map<string, string>();
  const openedPairs = new Set<string>();

  // Track nonces per wallet to avoid "nonce too low" errors
  // when same wallet opens multiple channels in sequence
  const walletNonces = new Map<string, number>();

  // Initialize nonces for all peer wallets
  for (const peer of peers) {
    const provider = peer.evmWallet.provider;
    if (!provider) continue;
    const nonce = await provider.getTransactionCount(peer.evmWallet.address);
    walletNonces.set(peer.evmWallet.address, nonce);
  }

  for (const [peerIndexStr, followIndices] of Object.entries(topology)) {
    const peerIndex = parseInt(peerIndexStr, 10);
    const peer = peers[peerIndex];
    if (!peer) continue;

    for (const followIndex of followIndices) {
      const followPeer = peers[followIndex];
      if (!followPeer) continue;

      // Create a canonical pair key (sorted by address)
      const addresses = [peer.evmWallet.address, followPeer.evmWallet.address].sort();
      const pairKey = `${addresses[0]}-${addresses[1]}`;

      // Skip if channel already opened for this pair
      if (openedPairs.has(pairKey)) {
        continue;
      }

      // The peer with lexicographically smaller address opens the channel
      // This peer calls openChannel(otherPeer, timeout)
      const openerPeer =
        peer.evmWallet.address.toLowerCase() < followPeer.evmWallet.address.toLowerCase()
          ? peer
          : followPeer;
      const otherPeer = openerPeer === peer ? followPeer : peer;

      // Get and increment nonce for this wallet
      const currentNonce = walletNonces.get(openerPeer.evmWallet.address) ?? 0;
      walletNonces.set(openerPeer.evmWallet.address, currentNonce + 1);

      // Encode function call and send transaction
      const iface = new ethers.Interface(TOKEN_NETWORK_ABI);
      const calldata = iface.encodeFunctionData('openChannel', [
        otherPeer.evmWallet.address,
        BigInt(settlementTimeout),
      ]);

      const tx = await openerPeer.evmWallet.sendTransaction({
        to: tokenNetworkAddress,
        data: calldata,
        gasLimit: 500000n,
        nonce: currentNonce,
      });
      const receipt = await tx.wait();
      if (!receipt || receipt.status === 0) {
        throw new Error(`openChannel transaction failed for ${openerPeer.id} -> ${otherPeer.id}`);
      }

      // Extract channel ID from event (reuse iface from above)
      let channelId: string | undefined;
      for (const log of receipt.logs) {
        try {
          const parsed = iface.parseLog(log);
          if (parsed && parsed.name === 'ChannelOpened') {
            channelId = parsed.args[0] as string;
            break;
          }
        } catch {
          // Skip logs that don't match
        }
      }

      if (channelId) {
        channelMap.set(pairKey, channelId);
        openedPairs.add(pairKey);

        // Store channel in both peers
        peer.channels.set(followPeer.id, channelId);
        followPeer.channels.set(peer.id, channelId);
      }
    }
  }

  return channelMap;
}

/**
 * Get channel details for sharing between peers.
 *
 * @param tokenNetworkAddress - TokenNetwork address
 * @param channelId - Channel ID
 * @param provider - Ethereum provider
 * @returns Channel state information
 */
export async function getChannelDetails(
  tokenNetworkAddress: string,
  channelId: string,
  provider: ethers.Provider
): Promise<{
  channelId: string;
  deposit1: bigint;
  deposit2: bigint;
  state: number;
  participant1: string;
  participant2: string;
}> {
  const tokenNetwork = new ethers.Contract(tokenNetworkAddress, TOKEN_NETWORK_ABI, provider);

  // Get channel data from public mapping
  const [, state, , , participant1, participant2] = (await tokenNetwork.getFunction('channels')(
    channelId
  )) as [bigint, number, bigint, bigint, string, string];

  // Get deposits from participants mapping
  const [deposit1] = (await tokenNetwork.getFunction('participants')(channelId, participant1)) as [
    bigint,
    bigint,
    boolean,
    bigint,
    bigint,
  ];

  const [deposit2] = (await tokenNetwork.getFunction('participants')(channelId, participant2)) as [
    bigint,
    bigint,
    boolean,
    bigint,
    bigint,
  ];

  return {
    channelId,
    deposit1,
    deposit2,
    state: Number(state), // Convert uint8 enum to number
    participant1,
    participant2,
  };
}

// ============================================
// Event Simulation
// ============================================

export const toonCodec = new ToonCodec();

// Deterministic condition for agent services
const AGENT_FULFILLMENT = Buffer.alloc(32, 0);
const AGENT_CONDITION = crypto.createHash('sha256').update(AGENT_FULFILLMENT).digest();

let eventCounter = 0;

/**
 * Create a test Nostr event.
 *
 * @param overrides - Partial event to merge with defaults
 * @returns Complete NostrEvent
 */
export function createTestNostrEvent(overrides?: Partial<NostrEvent>): NostrEvent {
  eventCounter++;
  const timestamp = Math.floor(Date.now() / 1000);

  return {
    id: crypto.randomBytes(32).toString('hex'),
    pubkey: overrides?.pubkey ?? crypto.randomBytes(32).toString('hex'),
    created_at: timestamp,
    kind: 1,
    tags: [],
    content: `Test event ${eventCounter}`,
    sig: crypto.randomBytes(64).toString('hex'),
    ...overrides,
  };
}

/**
 * Create an ILP Prepare packet containing a TOON-encoded event.
 *
 * @param event - Nostr event to encode
 * @param amount - Payment amount
 * @param destination - ILP destination address
 * @returns ILP Prepare packet
 */
export function createILPPreparePacket(
  event: NostrEvent,
  amount: bigint,
  destination: string
): ILPPreparePacket {
  return {
    type: PacketType.PREPARE,
    amount,
    destination,
    executionCondition: AGENT_CONDITION,
    expiresAt: new Date(Date.now() + 30000),
    data: toonCodec.encode(event),
  };
}

/**
 * Simulate event exchange between all connected peers.
 *
 * @param peers - Array of peers
 * @returns Simulation results
 */
export async function simulateEventExchange(peers: AgentPeer[]): Promise<SimulationResults> {
  const results: SimulationResults = {
    eventsSent: 0,
    eventsReceived: 0,
    payments: [],
    errors: [],
  };

  // Each peer sends a Kind 1 note to each followed peer
  for (const sender of peers) {
    for (const followPubkey of sender.follows) {
      const receiver = peers.find((p) => p.nostrPubkey === followPubkey);
      if (!receiver) continue;

      // Create note event
      const noteEvent = createTestNostrEvent({
        kind: 1,
        pubkey: sender.nostrPubkey,
        content: `Hello from ${sender.id} to ${receiver.id}!`,
        tags: [['p', receiver.nostrPubkey]],
      });

      // Create ILP packet with payment
      const packet = createILPPreparePacket(noteEvent, 100n, receiver.ilpAddress);

      results.eventsSent++;

      try {
        // Process through receiver's AgentNode
        const response = await receiver.agentNode.processIncomingPacket(packet, sender.id);

        if (response.type === PacketType.FULFILL) {
          results.eventsReceived++;
          results.payments.push({
            from: sender.id,
            to: receiver.id,
            amount: 100n,
          });
        } else if (response.type === PacketType.REJECT) {
          results.errors.push(
            `${sender.id} -> ${receiver.id}: Rejected with ${response.code}: ${response.message}`
          );
        }
      } catch (error) {
        results.errors.push(`${sender.id} -> ${receiver.id}: Error: ${(error as Error).message}`);
      }
    }
  }

  return results;
}

// ============================================
// Verification
// ============================================

/**
 * Verify the test results.
 *
 * @param peers - Array of peers
 * @param topology - Social graph topology
 * @returns Verification result
 */
export async function verifyResults(
  peers: AgentPeer[],
  topology: SocialGraphTopology
): Promise<VerificationResult> {
  const checks: VerificationResult['checks'] = [];

  // Check 1: All agents initialized
  const initializedCount = peers.filter((p) => p.agentNode.isInitialized).length;
  checks.push({
    name: 'Agents Initialized',
    passed: initializedCount === peers.length,
    details: `${initializedCount}/${peers.length} agents initialized`,
  });

  // Check 2: Social graph established
  let expectedConnections = 0;
  let actualConnections = 0;

  for (const followIndices of Object.values(topology)) {
    expectedConnections += followIndices.length;
  }

  for (const peer of peers) {
    actualConnections += peer.agentNode.followGraphRouter.getFollowCount();
  }

  checks.push({
    name: 'Social Graph',
    passed: actualConnections === expectedConnections,
    details: `${actualConnections}/${expectedConnections} connections established`,
  });

  // Check 3: Events stored
  let totalEvents = 0;
  for (const peer of peers) {
    const events = await peer.agentNode.database.queryEvents({ kinds: [1] });
    totalEvents += events.length;
  }

  const minExpectedEvents = expectedConnections; // At least one event per connection
  checks.push({
    name: 'Events Stored',
    passed: totalEvents >= minExpectedEvents,
    details: `${totalEvents} Kind 1 events stored (expected >= ${minExpectedEvents})`,
  });

  // Check 4: Routing works
  let routingSuccesses = 0;
  let routingTotal = 0;

  for (const peer of peers) {
    for (const followPubkey of peer.follows) {
      const followedPeer = peers.find((p) => p.nostrPubkey === followPubkey);
      if (followedPeer) {
        routingTotal++;
        if (peer.agentNode.followGraphRouter.hasRouteTo(followedPeer.ilpAddress)) {
          routingSuccesses++;
        }
      }
    }
  }

  checks.push({
    name: 'Routing Table',
    passed: routingSuccesses === routingTotal,
    details: `${routingSuccesses}/${routingTotal} routes valid`,
  });

  // Generate summary
  const passedCount = checks.filter((c) => c.passed).length;
  const success = passedCount === checks.length;

  return {
    success,
    checks,
    summary: `Agent Society Test: ${passedCount}/${checks.length} checks passed`,
  };
}

// ============================================
// Infrastructure Check
// ============================================

/**
 * Check if Anvil is running and accessible.
 *
 * @param rpcUrl - Anvil RPC URL
 * @returns true if Anvil is accessible
 */
export async function checkAnvilConnection(rpcUrl: string): Promise<boolean> {
  try {
    const provider = new ethers.JsonRpcProvider(rpcUrl);
    await provider.getBlockNumber();
    return true;
  } catch {
    return false;
  }
}

// ============================================
// Progress Reporting
// ============================================

/**
 * Report progress during test execution.
 *
 * @param phase - Current phase name
 * @param message - Progress message
 * @param verbose - Whether to log (default: true)
 */
export function reportProgress(phase: string, message: string, verbose = true): void {
  if (verbose) {
    // eslint-disable-next-line no-console
    console.log(`[${new Date().toISOString()}] [${phase}] ${message}`);
  }
}
